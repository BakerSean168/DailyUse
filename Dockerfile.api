# API Dockerfile
# ç”¨äºæ„å»ºç”Ÿäº§çº§åˆ«çš„ API å®¹å™¨

FROM node:20-alpine AS builder

WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm

# å¤åˆ¶å·¥ä½œåŒºé…ç½®
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages ./packages
COPY apps/api ./apps/api

# å®‰è£…ä¾èµ–
RUN NODE_ENV=development pnpm install --no-frozen-lockfile

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
WORKDIR /app/apps/api
RUN pnpm prisma:generate

# æ„å»ºé¡¹ç›®
RUN pnpm build

# ç”Ÿäº§é•œåƒ
FROM node:20-alpine

WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm

# 1. å¤åˆ¶ API çš„äº§ç‰© (ä¿æŒä¸å˜)
COPY --from=builder /app/apps/api/dist ./dist
COPY --from=builder /app/apps/api/package.json ./
COPY --from=builder /app/apps/api/prisma ./prisma

# ğŸ‘‡ã€æ–°å¢ã€‘2. å¤åˆ¶å·¥ä½œåŒºé…ç½®å’Œæœ¬åœ°åŒ… (å…³é”®ä¿®å¤ï¼)
COPY --from=builder /app/pnpm-workspace.yaml ./
COPY --from=builder /app/packages ./packages

# 3. å®‰è£…ä¾èµ–ï¼ˆ--ignore-scripts è·³è¿‡ prepare/postinstall é¿å…æ„å»ºè„šæœ¬ï¼‰
RUN pnpm install --prod --no-frozen-lockfile --ignore-scripts
RUN pnpm add ioredis -w --prod

# 4. ç”Ÿæˆ Prisma Clientï¼ˆprisma ç°åœ¨åœ¨ dependencies ä¸­ï¼‰
RUN pnpm prisma:generate

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# å¯åŠ¨åº”ç”¨
CMD ["node", "dist/index.js"]
