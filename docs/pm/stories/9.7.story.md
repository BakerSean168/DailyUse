# Story 9.7: E2E Tests - Schedule Conflict Detection

**Epic**: EPIC-SCHEDULE-001 (Êó•Á®ãÂÜ≤Á™ÅÊ£ÄÊµã)  
**Story Points**: 1  
**Priority**: P0  
**Status**: Draft  
**Sprint**: Sprint 5  
**Dependencies**: Story 9.6 (UI Component)

---

## üìã Story Statement

**As a** QA engineer  
**I want** to have E2E tests for schedule conflict detection  
**So that** we can ensure the complete conflict detection flow works correctly from UI to database

---

## ‚úÖ Acceptance Criteria

### AC-1: Test Conflict Detection Flow ‚úÖ
```gherkin
Given I am on the schedule creation page
When I enter a schedule time that overlaps with existing schedules
Then the system should:
  - Display conflict alert with correct count
  - Show conflicting schedule details
  - Display resolution suggestions
  - Allow me to apply suggestions
  - Verify conflicts resolved after applying suggestion
```

### AC-2: Test Schedule Creation with Conflicts ‚úÖ
```gherkin
Given I am creating a schedule with detected conflicts
When I submit the form
Then the system should:
  - Create the schedule successfully
  - Store hasConflict=true in database
  - Store conflictingSchedules array
  - Display success message
  - Navigate to schedule list
  - Show conflict indicator on created schedule
```

### AC-3: Test Conflict Resolution Flow ‚úÖ
```gherkin
Given I have a schedule with conflicts
When I click "resolve conflict" button
Then the system should:
  - Open resolution dialog
  - Show available strategies (RESCHEDULE, CANCEL, IGNORE)
  - Apply selected strategy
  - Update schedule in database
  - Re-detect conflicts
  - Show success message if resolved
```

### AC-4: Test Edge Cases ‚úÖ
```gherkin
Given various edge case scenarios
When I test the conflict detection
Then it should handle:
  - Multiple overlapping schedules (2+ conflicts)
  - Partial overlaps (start/end time overlaps)
  - Complete overlaps (one schedule fully contains another)
  - Editing existing schedule (excludeUuid parameter)
  - No conflicts (show success state)
```

---

## üì¶ Dev Notes

### üîó Previous Story Insights

**Story 9.6 (UI Component)**:
- ‚úÖ `ScheduleConflictAlert` component with data-testid attributes
- ‚úÖ Conflict display, suggestions, and actions

**Story 9.5 (Client Services)**:
- ‚úÖ `useSchedule()` composable with conflict detection methods

**Story 9.4 (API Endpoints)**:
- ‚úÖ REST endpoints for conflict detection

### üìä Test Scenarios

#### Scenario 1: Detect Conflict on New Schedule
```typescript
test('should detect conflict when creating overlapping schedule', async ({ page }) => {
  // Setup: Create existing schedule (14:00-15:00)
  await createExistingSchedule(page, {
    title: 'Existing Meeting',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  // Navigate to create page
  await page.goto('/schedule/create');

  // Fill form with overlapping time (14:30-15:30)
  await page.fill('[data-testid="schedule-title"]', 'New Meeting');
  await page.fill('[data-testid="start-time"]', '2025-10-21 14:30');
  await page.fill('[data-testid="end-time"]', '2025-10-21 15:30');

  // Verify conflict alert appears
  await expect(page.locator('[data-testid="conflict-alert"]')).toBeVisible();
  await expect(page.locator('[data-testid="conflict-count"]')).toContainText('1');
  await expect(page.locator('[data-testid="conflict-title"]')).toContainText('Existing Meeting');
  await expect(page.locator('[data-testid="overlap-duration"]')).toContainText('30 ÂàÜÈíü');
});
```

#### Scenario 2: Apply Suggestion to Resolve Conflict
```typescript
test('should resolve conflict by applying suggestion', async ({ page }) => {
  // Setup: Create existing schedule
  await createExistingSchedule(page, {
    title: 'Existing Meeting',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  // Navigate and create conflicting schedule
  await page.goto('/schedule/create');
  await page.fill('[data-testid="schedule-title"]', 'New Meeting');
  await page.fill('[data-testid="start-time"]', '2025-10-21 14:30');
  await page.fill('[data-testid="end-time"]', '2025-10-21 15:30');

  // Verify conflict exists
  await expect(page.locator('[data-testid="conflict-alert"]')).toBeVisible();

  // Click first suggestion button (move to suggested time)
  await page.click('[data-testid="suggestion-button-0"]');

  // Wait for re-detection
  await page.waitForTimeout(1000);

  // Verify conflict resolved
  await expect(page.locator('[data-testid="conflict-alert"]')).not.toBeVisible();
  await expect(page.locator('[data-testid="no-conflict-message"]')).toBeVisible();
});
```

#### Scenario 3: Create Schedule with Conflict (Intentional)
```typescript
test('should create schedule even with conflicts', async ({ page }) => {
  // Setup existing schedule
  await createExistingSchedule(page, {
    title: 'Existing Meeting',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  // Navigate and fill form
  await page.goto('/schedule/create');
  await page.fill('[data-testid="schedule-title"]', 'Conflicting Meeting');
  await page.fill('[data-testid="start-time"]', '2025-10-21 14:30');
  await page.fill('[data-testid="end-time"]', '2025-10-21 15:30');

  // Verify conflict shown
  await expect(page.locator('[data-testid="conflict-alert"]')).toBeVisible();

  // Submit form anyway (ignore conflict)
  await page.click('[data-testid="submit-button"]');

  // Verify success
  await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  await expect(page).toHaveURL('/schedule/list');

  // Verify schedule created with conflict flag
  const schedule = await page.locator('[data-testid="schedule-item"]').first();
  await expect(schedule.locator('[data-testid="conflict-indicator"]')).toBeVisible();
});
```

#### Scenario 4: Edit Schedule (Exclude Current Schedule)
```typescript
test('should exclude current schedule when editing', async ({ page }) => {
  // Setup: Create two schedules
  const schedule1 = await createExistingSchedule(page, {
    title: 'Meeting A',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  await createExistingSchedule(page, {
    title: 'Meeting B',
    startTime: '2025-10-21 16:00',
    endTime: '2025-10-21 17:00',
  });

  // Navigate to edit Meeting A
  await page.goto(`/schedule/edit/${schedule1.uuid}`);

  // Change time (still in same time slot)
  await page.fill('[data-testid="start-time"]', '2025-10-21 14:10');
  await page.fill('[data-testid="end-time"]', '2025-10-21 15:10');

  // Verify NO conflict (excludeUuid should exclude Meeting A itself)
  await expect(page.locator('[data-testid="conflict-alert"]')).not.toBeVisible();
  await expect(page.locator('[data-testid="no-conflict-message"]')).toBeVisible();
});
```

#### Scenario 5: Multiple Conflicts
```typescript
test('should detect multiple conflicts', async ({ page }) => {
  // Setup: Create 3 existing schedules
  await createExistingSchedule(page, {
    title: 'Meeting 1',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  await createExistingSchedule(page, {
    title: 'Meeting 2',
    startTime: '2025-10-21 14:30',
    endTime: '2025-10-21 15:30',
  });

  await createExistingSchedule(page, {
    title: 'Meeting 3',
    startTime: '2025-10-21 15:00',
    endTime: '2025-10-21 16:00',
  });

  // Navigate and create schedule overlapping all 3
  await page.goto('/schedule/create');
  await page.fill('[data-testid="schedule-title"]', 'Long Meeting');
  await page.fill('[data-testid="start-time"]', '2025-10-21 14:00');
  await page.fill('[data-testid="end-time"]', '2025-10-21 16:00');

  // Verify 3 conflicts detected
  await expect(page.locator('[data-testid="conflict-alert"]')).toBeVisible();
  await expect(page.locator('[data-testid="conflict-count"]')).toContainText('3');
  await expect(page.locator('[data-testid="conflict-item"]')).toHaveCount(3);
});
```

#### Scenario 6: Resolve Conflict with Strategy
```typescript
test('should resolve conflict using RESCHEDULE strategy', async ({ page }) => {
  // Setup: Create conflicting schedule
  const conflictingSchedule = await createExistingSchedule(page, {
    title: 'Conflicting Meeting',
    startTime: '2025-10-21 14:00',
    endTime: '2025-10-21 15:00',
  });

  // Navigate to schedule list
  await page.goto('/schedule/list');

  // Click resolve conflict button
  const scheduleItem = page.locator(`[data-testid="schedule-${conflictingSchedule.uuid}"]`);
  await scheduleItem.locator('[data-testid="resolve-conflict-button"]').click();

  // Verify resolution dialog opens
  await expect(page.locator('[data-testid="resolution-dialog"]')).toBeVisible();

  // Select RESCHEDULE strategy
  await page.click('[data-testid="strategy-reschedule"]');

  // Enter new time (suggested time should be pre-filled)
  await page.fill('[data-testid="new-start-time"]', '2025-10-21 15:30');
  await page.fill('[data-testid="new-end-time"]', '2025-10-21 16:30');

  // Submit resolution
  await page.click('[data-testid="confirm-resolution"]');

  // Verify success
  await expect(page.locator('[data-testid="success-message"]')).toContainText('ÂÜ≤Á™ÅÂ∑≤Ëß£ÂÜ≥');

  // Verify conflict indicator removed
  await expect(scheduleItem.locator('[data-testid="conflict-indicator"]')).not.toBeVisible();
});
```

### üìÇ File Locations

**E2E Tests**:
- `apps/web-e2e/src/schedule/conflict-detection.spec.ts` ‚≠ê **NEW**
- `apps/web-e2e/src/schedule/helpers.ts` ‚≠ê **NEW** (test helper functions)

**Test Helpers** (`helpers.ts`):
```typescript
import { Page } from '@playwright/test';

export async function createExistingSchedule(
  page: Page,
  schedule: {
    title: string;
    startTime: string; // '2025-10-21 14:00'
    endTime: string;
  },
) {
  // Navigate to create page
  await page.goto('/schedule/create');

  // Fill form
  await page.fill('[data-testid="schedule-title"]', schedule.title);
  await page.fill('[data-testid="start-time"]', schedule.startTime);
  await page.fill('[data-testid="end-time"]', schedule.endTime);

  // Submit
  await page.click('[data-testid="submit-button"]');

  // Wait for success
  await page.waitForSelector('[data-testid="success-message"]');

  // Get created schedule UUID from URL or response
  const uuid = await page.url().match(/\/schedule\/(\w+)/)?.[1];

  return { uuid, ...schedule };
}

export async function clearAllSchedules(page: Page) {
  // Navigate to list
  await page.goto('/schedule/list');

  // Delete all schedules
  const deleteButtons = await page.locator('[data-testid="delete-button"]').all();
  for (const button of deleteButtons) {
    await button.click();
    await page.click('[data-testid="confirm-delete"]');
  }
}
```

### üß™ Testing Requirements

**E2E Test Coverage**:
- ‚úÖ Conflict detection on new schedule
- ‚úÖ Conflict detection on edit schedule (excludeUuid)
- ‚úÖ Multiple conflicts (2+ overlapping schedules)
- ‚úÖ Apply suggestion to resolve conflict
- ‚úÖ Create schedule with conflict (ignore)
- ‚úÖ Resolve conflict with RESCHEDULE strategy
- ‚úÖ Resolve conflict with CANCEL strategy
- ‚úÖ Resolve conflict with IGNORE strategy
- ‚úÖ No conflicts (success state)
- ‚úÖ Edge cases (partial overlap, complete overlap)

**Test Setup**:
- ‚úÖ Database seeding (create test schedules)
- ‚úÖ Authentication (login before tests)
- ‚úÖ Cleanup (delete test data after each test)

**Test Execution**:
- ‚úÖ Run: `pnpm nx e2e web-e2e --grep="conflict-detection"`
- ‚úÖ All tests should pass
- ‚úÖ No flaky tests (run 3 times to verify)

### ‚ö†Ô∏è Technical Constraints

**Playwright Configuration**:
- ‚úÖ Use `@playwright/test` (already set up in project)
- ‚úÖ Run against local dev server: `http://localhost:5173`
- ‚úÖ Use `data-testid` attributes (not CSS selectors)
- ‚úÖ Wait for network idle before assertions
- ‚úÖ Take screenshots on failure

**Test Data**:
- ‚úÖ Use fixed dates (e.g., '2025-10-21') for reproducibility
- ‚úÖ Clean up test data after each test
- ‚úÖ Use unique titles to avoid conflicts between tests

**Async Handling**:
- ‚úÖ Wait for API calls to complete
- ‚úÖ Wait for UI updates (loading states)
- ‚úÖ Use `waitForSelector` for dynamic content

---

## üìù Tasks/Subtasks

### Task 1: Create Test File Structure ‚è≠Ô∏è (30 minutes)
- [ ] 1.1. Create `conflict-detection.spec.ts`
- [ ] 1.2. Create `helpers.ts` with utility functions
- [ ] 1.3. Set up test fixtures (beforeEach, afterEach)
- [ ] 1.4. Add authentication helper

### Task 2: Implement Core Test Scenarios ‚è≠Ô∏è (2 hours)
- [ ] 2.1. Test: Detect conflict on new schedule
- [ ] 2.2. Test: Apply suggestion to resolve conflict
- [ ] 2.3. Test: Create schedule with conflict
- [ ] 2.4. Test: Edit schedule (excludeUuid)
- [ ] 2.5. Test: Multiple conflicts

### Task 3: Implement Resolution Scenarios ‚è≠Ô∏è (1 hour)
- [ ] 3.1. Test: Resolve with RESCHEDULE strategy
- [ ] 3.2. Test: Resolve with CANCEL strategy
- [ ] 3.3. Test: Resolve with IGNORE strategy

### Task 4: Test Execution and Debugging ‚è≠Ô∏è (1 hour)
- [ ] 4.1. Run all tests locally
- [ ] 4.2. Debug failing tests
- [ ] 4.3. Verify no flaky tests (run 3x)
- [ ] 4.4. Add screenshots for failures

---

## üìä Estimation Summary

| Task | Estimated Time |
|------|----------------|
| Task 1 | 30 minutes |
| Task 2 | 2 hours |
| Task 3 | 1 hour |
| Task 4 | 1 hour |
| **Total** | **4.5 hours** |

**Story Points**: 1 SP

---

## ‚úÖ Definition of Done

- [ ] All E2E test scenarios implemented
- [ ] All tests pass locally
- [ ] No flaky tests
- [ ] Test helpers created
- [ ] Test data cleanup implemented
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Story marked as "Done"

---

**Created**: 2025-10-24  
**Last Updated**: 2025-10-24  
**Status**: Draft  
**Assignee**: TBD
