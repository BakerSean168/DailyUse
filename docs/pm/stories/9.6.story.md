# Story 9.6: UI Component - Conflict Warning Panel

**Epic**: EPIC-SCHEDULE-001 (日程冲突检测)  
**Story Points**: 3  
**Priority**: P0  
**Status**: Draft  
**Sprint**: Sprint 5  
**Dependencies**: Story 9.5 (Client Services)

---

## 📋 Story Statement

**As a** user creating or editing a schedule  
**I want** to see visual conflict warnings with suggested resolutions  
**So that** I can avoid scheduling conflicts and resolve them easily

---

## ✅ Acceptance Criteria

### AC-1: Implement ScheduleConflictAlert Component ✅
```gherkin
Given I am creating/editing a schedule with time inputs
When conflicts are detected
Then the system should:
  - Display v-alert with type="error" and prominent styling
  - Show conflict count: "检测到 N 个时间冲突"
  - List each conflicting schedule with:
    - Schedule title
    - Overlap duration (formatted: "重叠 30 分钟")
    - Severity indicator (color coded)
  - Show "建议调整" section with action buttons
  - Provide buttons to apply suggestions (移至建议时间, 缩短时长, 忽略)
```

### AC-2: Real-time Conflict Detection ✅
```gherkin
Given I am filling out the schedule form
When I change startTime or endTime fields
Then the system should:
  - Automatically call detectConflicts() from useSchedule()
  - Debounce API calls (500ms delay)
  - Show loading state during detection
  - Update conflict alert immediately after detection
  - Clear alert if no conflicts found
```

### AC-3: Apply Suggestion Actions ✅
```gherkin
Given conflict suggestions are displayed
When I click a suggestion button (e.g., "移至 14:00")
Then the system should:
  - Update form.startTime and form.endTime with suggested values
  - Re-trigger conflict detection
  - Update conflict alert (should show no conflicts if resolved)
  - Provide visual feedback (button loading state)
```

### AC-4: Integration with Schedule Form ✅
```gherkin
Given I am using the schedule creation/edit form
When the ScheduleConflictAlert component is rendered
Then it should:
  - Be positioned below time input fields
  - Use reactive state from useSchedule() composable
  - Support both create and edit modes
  - Display different messages for excludeUuid scenarios
```

### AC-5: Accessibility and UX ✅
```gherkin
Given the conflict alert is displayed
When I interact with the component
Then it should:
  - Use ARIA labels for screen readers
  - Support keyboard navigation
  - Show clear error messages
  - Provide visual feedback for actions
  - Use color-blind friendly severity indicators
```

---

## 📦 Dev Notes

### 🔗 Previous Story Insights

**Story 9.5 (Client Services)**:
- ✅ `useSchedule()` composable provides:
  ```typescript
  const {
    conflicts,
    isDetectingConflicts,
    conflictError,
    detectConflicts,
    createSchedule,
    resolveConflict,
  } = useSchedule();
  ```

**Existing UI Patterns**:
- ✅ Vuetify 3 (v-alert, v-btn, v-card, v-form, v-text-field)
- ✅ Element Plus for date picker (el-date-picker)
- ✅ Composable pattern: `useSchedule()`, `useSnackbar()`
- ✅ Error handling: v-alert with type="error"

### 📊 Data Models

#### Component Props

```typescript
// ScheduleConflictAlert.vue Props
interface Props {
  conflicts: ConflictDetectionResult | null;
  isLoading: boolean;
  error: string | null;
}

// Optional: If form values needed
interface Props {
  modelValue: {
    startTime: number;
    endTime: number;
  };
  conflicts: ConflictDetectionResult | null;
  isLoading: boolean;
}
```

#### Component Emits

```typescript
interface Emits {
  (e: 'apply-suggestion', suggestion: Suggestion): void;
  (e: 'ignore-conflict'): void;
}
```

### 🏗️ Component Structure

**Component File**:
- `apps/web/src/modules/schedule/presentation/components/ScheduleConflictAlert.vue` ⭐ **NEW**

**Template Structure**:
```vue
<template>
  <div class="schedule-conflict-alert">
    <!-- Loading State -->
    <v-progress-linear v-if="isLoading" indeterminate color="primary" />

    <!-- Error State -->
    <v-alert v-if="error" type="error" variant="tonal" class="mb-4">
      {{ error }}
    </v-alert>

    <!-- No Conflicts -->
    <v-alert v-if="!isLoading && conflicts && !conflicts.hasConflicts" 
      type="success" 
      variant="tonal" 
      density="compact"
      class="mb-4"
    >
      <v-icon start>mdi-check-circle</v-icon>
      无时间冲突
    </v-alert>

    <!-- Conflicts Detected -->
    <v-alert v-if="conflicts?.hasConflicts"
      type="error"
      variant="tonal"
      prominent
      border="start"
      class="mb-4"
    >
      <template #title>
        <v-icon start>mdi-alert-circle</v-icon>
        检测到 {{ conflicts.conflictCount }} 个时间冲突
      </template>

      <v-divider class="my-2"></v-divider>

      <!-- Conflict List -->
      <div class="conflict-list">
        <div v-for="(conflict, index) in conflicts.conflicts" 
          :key="index"
          class="conflict-item"
        >
          <v-chip
            :color="getSeverityColor(conflict.severity)"
            size="small"
            class="mr-2"
          >
            {{ getSeverityLabel(conflict.severity) }}
          </v-chip>
          <span class="conflict-title">
            与"{{ conflict.conflictingSchedule.title }}"冲突
          </span>
          <span class="overlap-time">
            重叠 {{ formatDuration(conflict.overlapMinutes) }}
          </span>
        </div>
      </div>

      <v-divider class="my-3"></v-divider>

      <!-- Suggestions -->
      <div v-if="conflicts.suggestions.length > 0" class="suggestions">
        <div class="suggestions-header">
          <v-icon start size="small">mdi-lightbulb-outline</v-icon>
          建议调整：
        </div>
        <div class="suggestions-actions">
          <v-btn
            v-for="(suggestion, index) in conflicts.suggestions"
            :key="index"
            size="small"
            variant="outlined"
            @click="handleApplySuggestion(suggestion)"
          >
            {{ getSuggestionLabel(suggestion) }}
          </v-btn>
          <v-btn
            size="small"
            variant="text"
            @click="handleIgnore"
          >
            忽略冲突
          </v-btn>
        </div>
      </div>
    </v-alert>
  </div>
</template>
```

**Script Structure**:
```typescript
<script setup lang="ts">
import { computed } from 'vue';
import type { ScheduleContracts } from '@dailyuse/contracts';

type ConflictDetectionResult = ScheduleContracts.ConflictDetectionResult;
type Suggestion = ScheduleContracts.Suggestion;

interface Props {
  conflicts: ConflictDetectionResult | null;
  isLoading: boolean;
  error?: string | null;
}

interface Emits {
  (e: 'apply-suggestion', suggestion: Suggestion): void;
  (e: 'ignore-conflict'): void;
}

const props = defineProps<Props>();
const emit = defineEmits<Emits>();

// Severity mapping
const getSeverityColor = (severity: string) => {
  const colors = {
    CRITICAL: 'error',
    HIGH: 'error',
    MEDIUM: 'warning',
    LOW: 'info',
  };
  return colors[severity] || 'grey';
};

const getSeverityLabel = (severity: string) => {
  const labels = {
    CRITICAL: '严重',
    HIGH: '高',
    MEDIUM: '中',
    LOW: '低',
  };
  return labels[severity] || severity;
};

// Format duration (minutes to human-readable)
const formatDuration = (minutes: number): string => {
  if (minutes < 60) {
    return `${minutes} 分钟`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours} 小时 ${mins} 分钟` : `${hours} 小时`;
};

// Format suggestion label
const getSuggestionLabel = (suggestion: Suggestion): string => {
  if (suggestion.suggestedStartTime && suggestion.suggestedEndTime) {
    const startTime = new Date(suggestion.suggestedStartTime);
    const timeStr = startTime.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    return `移至 ${timeStr}`;
  }
  return suggestion.action;
};

// Event handlers
const handleApplySuggestion = (suggestion: Suggestion) => {
  emit('apply-suggestion', suggestion);
};

const handleIgnore = () => {
  emit('ignore-conflict');
};
</script>
```

**Style**:
```vue
<style scoped>
.schedule-conflict-alert {
  margin: 1rem 0;
}

.conflict-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.conflict-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.conflict-title {
  font-weight: 500;
}

.overlap-time {
  color: rgb(var(--v-theme-error));
  font-size: 0.875rem;
  font-weight: 500;
}

.suggestions {
  margin-top: 1rem;
}

.suggestions-header {
  display: flex;
  align-items: center;
  font-weight: 500;
  margin-bottom: 0.75rem;
}

.suggestions-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
</style>
```

### 📂 File Locations

**Components**:
- `apps/web/src/modules/schedule/presentation/components/ScheduleConflictAlert.vue` ⭐ **NEW**
- `apps/web/src/modules/schedule/presentation/components/index.ts` ⭐ **MODIFIED** (export component)

**Usage Example** (Schedule Form):
```vue
<template>
  <v-form @submit.prevent="handleSubmit">
    <v-row>
      <v-col cols="12" md="6">
        <v-text-field
          v-model="form.title"
          label="日程标题"
          variant="outlined"
          required
        />
      </v-col>
      
      <v-col cols="12" md="6">
        <el-date-picker
          v-model="form.startTime"
          type="datetime"
          placeholder="开始时间"
          @change="handleTimeChange"
        />
      </v-col>
      
      <v-col cols="12" md="6">
        <el-date-picker
          v-model="form.endTime"
          type="datetime"
          placeholder="结束时间"
          @change="handleTimeChange"
        />
      </v-col>
    </v-row>

    <!-- Conflict Alert Component -->
    <ScheduleConflictAlert
      :conflicts="scheduleComposable.conflicts.value"
      :is-loading="scheduleComposable.isDetectingConflicts.value"
      :error="scheduleComposable.conflictError.value"
      @apply-suggestion="handleApplySuggestion"
      @ignore-conflict="handleIgnoreConflict"
    />

    <v-btn type="submit" color="primary">
      创建日程
    </v-btn>
  </v-form>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';
import { useSchedule } from '../composables/useSchedule';
import ScheduleConflictAlert from '../components/ScheduleConflictAlert.vue';
import { useDebounceFn } from '@vueuse/core';

const scheduleComposable = useSchedule();

const form = ref({
  accountUuid: 'user-uuid',
  title: '',
  startTime: null,
  endTime: null,
  duration: 0,
});

// Debounced conflict detection
const debouncedDetectConflicts = useDebounceFn(async () => {
  if (form.value.startTime && form.value.endTime) {
    await scheduleComposable.detectConflicts(
      form.value.accountUuid,
      form.value.startTime.getTime(),
      form.value.endTime.getTime(),
    );
  }
}, 500);

// Watch time changes
watch([() => form.value.startTime, () => form.value.endTime], () => {
  debouncedDetectConflicts();
});

// Handle suggestion
const handleApplySuggestion = async (suggestion: any) => {
  if (suggestion.suggestedStartTime && suggestion.suggestedEndTime) {
    form.value.startTime = new Date(suggestion.suggestedStartTime);
    form.value.endTime = new Date(suggestion.suggestedEndTime);
    // Re-detect conflicts
    await debouncedDetectConflicts();
  }
};

// Handle ignore
const handleIgnoreConflict = () => {
  // User chooses to ignore conflict
  // Could set a flag or proceed with creation
};

// Handle submit
const handleSubmit = async () => {
  form.value.duration = Math.floor(
    (form.value.endTime.getTime() - form.value.startTime.getTime()) / 60000
  );
  
  await scheduleComposable.createSchedule(form.value);
};
</script>
```

### 🧪 Testing Requirements

**Component Tests** (`ScheduleConflictAlert.spec.ts`):
- ✅ Renders loading state
- ✅ Renders error state
- ✅ Renders "无时间冲突" for no conflicts
- ✅ Renders conflict list with correct count
- ✅ Displays severity chips with correct colors
- ✅ Formats duration correctly (30分钟, 1小时30分钟)
- ✅ Renders suggestion buttons
- ✅ Emits 'apply-suggestion' when button clicked
- ✅ Emits 'ignore-conflict' when ignore clicked

**Integration Tests**:
- ✅ Component responds to prop changes
- ✅ Loading state shows/hides correctly
- ✅ Conflict data renders correctly
- ✅ Suggestion buttons work end-to-end

---

## 📝 Tasks/Subtasks

### Task 1: Create ScheduleConflictAlert Component ⏭️ (2 hours)
- [ ] 1.1. Create component file
- [ ] 1.2. Implement template (loading, error, no conflicts, conflicts)
- [ ] 1.3. Implement script (props, emits, helper functions)
- [ ] 1.4. Add styles
- [ ] 1.5. Export from index.ts

### Task 2: Write Component Tests ⏭️ (1.5 hours)
- [ ] 2.1. Test loading state
- [ ] 2.2. Test error state
- [ ] 2.3. Test no conflicts state
- [ ] 2.4. Test conflicts display
- [ ] 2.5. Test suggestion interactions

### Task 3: Integration with Schedule Form ⏭️ (1.5 hours)
- [ ] 3.1. Add component to schedule form
- [ ] 3.2. Implement debounced conflict detection
- [ ] 3.3. Implement apply suggestion handler
- [ ] 3.4. Test end-to-end flow

### Task 4: Documentation and Review ⏭️ (1 hour)
- [ ] 4.1. Add JSDoc comments
- [ ] 4.2. Create usage examples
- [ ] 4.3. Code review
- [ ] 4.4. Final testing

---

## 📊 Estimation Summary

| Task | Estimated Time |
|------|----------------|
| Task 1 | 2 hours |
| Task 2 | 1.5 hours |
| Task 3 | 1.5 hours |
| Task 4 | 1 hour |
| **Total** | **6 hours** |

**Story Points**: 3 SP

---

## ✅ Definition of Done

- [ ] ScheduleConflictAlert component implemented
- [ ] Component renders all states correctly
- [ ] Unit tests pass (≥80% coverage)
- [ ] Integration with schedule form complete
- [ ] Manual testing completed
- [ ] Code reviewed and approved
- [ ] Merged to main branch
- [ ] Story marked as "Done"

---

**Created**: 2025-10-24  
**Last Updated**: 2025-10-24  
**Status**: Draft  
**Assignee**: TBD
