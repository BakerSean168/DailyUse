# Story 9.1: Contracts & Domain - 冲突检测模型

**Epic**: EPIC-SCHEDULE-001 (日程冲突检测)  
**Story Points**: 3 SP  
**Priority**: P0  
**Status**: Ready for Review  
**Created**: 2025-10-24  
**Completed**: 2025-10-24  
**Sprint**: Sprint 5  
**Owner**: Dev Agent (James)

---

## 📋 Story

**As a** developer working on calendar schedule conflict detection,  
**I want** to define data contracts and domain logic for conflict detection,  
**So that** the system can identify overlapping schedules and provide conflict resolution suggestions.

---

## ✅ Acceptance Criteria

### AC-1: Define Conflict Detection Contracts

**Given** the Schedule module needs conflict detection capabilities  
**When** contracts are defined for conflict detection  
**Then**  
- `ScheduleServerDTO` should include `hasConflict` (boolean) and `conflictingSchedules` (optional string[])
- `ConflictDetectionResult` interface should include:
  - `hasConflict`: boolean
  - `conflicts`: array of conflict details (scheduleUuid, scheduleTitle, overlapStart, overlapEnd, overlapDuration)
  - `suggestions`: array of resolution suggestions (type, newStartTime, newEndTime)
- All contracts should follow TypeScript readonly patterns
- Contracts should be exported from `packages/contracts/src/modules/schedule/`

---

### AC-2: Implement Domain Logic for Conflict Detection

**Given** contracts are defined  
**When** domain logic is implemented in Schedule aggregate  
**Then**  
- Schedule aggregate should have `detectConflicts(otherSchedules: Schedule[]): ConflictDetectionResult` method
- Private helper methods should include:
  - `isOverlapping(other: Schedule): boolean` - detect if two schedules overlap
  - `calculateOverlap(other: Schedule): number` - calculate overlap duration in minutes
  - `generateSuggestions(conflicts: Schedule[]): Suggestion[]` - generate resolution suggestions
- Domain logic should be pure (no repository dependencies)
- All methods should have proper type safety

---

### AC-3: Unit Tests with ≥ 80% Coverage

**Given** domain logic is implemented  
**When** unit tests are written  
**Then**  
- Test `detectConflicts()` with no conflicts (should return `hasConflict: false`)
- Test `detectConflicts()` with single conflict (should return correct conflict details)
- Test `detectConflicts()` with multiple conflicts (should return all conflicts)
- Test `isOverlapping()` edge cases:
  - No overlap (before/after)
  - Partial overlap (start/end)
  - Complete overlap (one inside another)
  - Exact time match
- Test coverage ≥ 80%
- All tests should pass

---

## 🏗️ Dev Notes

> **Note**: This story creates a NEW `Schedule` aggregate for calendar events/meetings (user-facing schedules), separate from the existing `ScheduleTask` aggregate which is for cron-based background tasks.

### Previous Story Insights

- N/A (First story in EPIC-SCHEDULE-001)

---

### Data Models

#### Current Architecture Status

**Existing Implementation** [Source: semantic_search results]:
- **ScheduleTask Aggregate** (`packages/domain-server/src/schedule/aggregates/ScheduleTask.ts`): 
  - Purpose: Cron-based background task scheduling (automation)
  - Fields: uuid, accountUuid, name, description, sourceModule, sourceEntityId, status, enabled, schedule (ScheduleConfig VO), execution (ExecutionInfo VO), retryPolicy (RetryPolicy VO), metadata (TaskMetadata VO), executions[] (ScheduleExecution entities)
  - **NOT suitable for calendar conflict detection** (different domain concept)

**New Implementation Needed**:
- **Schedule Aggregate** (NEW):
  - Purpose: User-facing calendar events/meetings with conflict detection
  - Core Fields (NEW):
    - `uuid: string`
    - `accountUuid: string`
    - `title: string`
    - `description?: string`
    - `startTime: number` (timestamp)
    - `endTime: number` (timestamp)
    - `duration: number` (calculated, in minutes)
    - `hasConflict: boolean`
    - `conflictingSchedules?: string[]` (UUIDs)
  - Domain Methods (NEW):
    - `detectConflicts(otherSchedules: Schedule[]): ConflictDetectionResult`
    - `isOverlapping(other: Schedule): boolean`
    - `calculateOverlap(other: Schedule): number`
    - `generateSuggestions(conflicts: Schedule[]): Suggestion[]`

#### Contracts to Define [Source: epic-schedule-001-conflict-detection.md]

**Location**: `packages/contracts/src/modules/schedule/`

**1. ScheduleServerDTO** (Update or Create New):
```typescript
// packages/contracts/src/modules/schedule/aggregates/ScheduleServer.ts
export interface ScheduleServerDTO {
  readonly uuid: string;
  readonly accountUuid: string;
  readonly title: string;
  readonly description?: string;
  readonly startTime: number;
  readonly endTime: number;
  readonly duration: number;  // in minutes
  
  // NEW: Conflict detection fields
  readonly hasConflict: boolean;
  readonly conflictingSchedules?: string[];  // Array of conflicting schedule UUIDs
  
  // Additional fields (TBD in future stories)
  readonly priority?: number;
  readonly location?: string;
  readonly attendees?: string[];
  readonly createdAt: number;
  readonly updatedAt: number;
}
```

**2. ConflictDetectionResult** (NEW):
```typescript
// packages/contracts/src/modules/schedule/ConflictDetectionResult.ts
export interface ConflictDetectionResult {
  readonly hasConflict: boolean;
  readonly conflicts: ConflictDetail[];
  readonly suggestions: ConflictSuggestion[];
}

export interface ConflictDetail {
  readonly scheduleUuid: string;
  readonly scheduleTitle: string;
  readonly overlapStart: number;       // timestamp
  readonly overlapEnd: number;         // timestamp
  readonly overlapDuration: number;    // in minutes
}

export interface ConflictSuggestion {
  readonly type: 'move_earlier' | 'move_later' | 'shorten';
  readonly newStartTime: number;       // timestamp
  readonly newEndTime: number;         // timestamp
}
```

**3. ConflictSeverity Enum** [Source: docs/modules/schedule/features/01-conflict-detection.md]:
```typescript
// packages/contracts/src/modules/schedule/enums.ts
export enum ConflictSeverity {
  MINOR = 'minor',        // < 15 minutes overlap
  MODERATE = 'moderate',  // 15-60 minutes overlap
  SEVERE = 'severe'       // > 60 minutes or complete overlap
}
```

---

### API Specifications

- **N/A for this story** (Contracts & Domain only)
- API endpoints will be defined in Story 9.4

---

### Component Specifications

- **N/A for this story** (Backend only)
- UI components will be defined in Story 9.6

---

### File Locations

#### NEW Files to Create:

**Contracts Layer**:
```
packages/contracts/src/modules/schedule/
├── aggregates/
│   ├── ScheduleServer.ts        # NEW: ScheduleServerDTO interface
│   └── ScheduleClient.ts        # NEW: ScheduleClientDTO interface (future)
├── ConflictDetectionResult.ts   # NEW: Conflict detection result types
└── enums.ts                     # UPDATE: Add ConflictSeverity enum
```

**Domain-Server Layer**:
```
packages/domain-server/src/schedule/
├── aggregates/
│   └── Schedule.ts              # NEW: Schedule aggregate root with conflict detection logic
└── __tests__/
    └── Schedule.spec.ts         # NEW: Unit tests for Schedule aggregate
```

**Key Note**: DO NOT modify `ScheduleTask.ts` - it serves a different purpose (cron task scheduling)

---

### Testing Requirements [Source: DDD_REFACTORING_FINAL_REPORT.md]

**Test Strategy**:
1. **Unit Tests** (Jest/Vitest):
   - Test Location: `packages/domain-server/src/schedule/__tests__/Schedule.spec.ts`
   - Coverage Target: ≥ 80%
   - Test Cases:
     - **No Conflicts**: `detectConflicts([])` should return `{ hasConflict: false, conflicts: [], suggestions: [] }`
     - **Single Conflict**: Two overlapping schedules should return correct conflict details
     - **Multiple Conflicts**: Three overlapping schedules should return all conflicts
     - **Edge Cases** (isOverlapping):
       - Schedule A ends exactly when Schedule B starts (no overlap)
       - Schedule A starts exactly when Schedule B ends (no overlap)
       - Schedule A completely contains Schedule B
       - Schedule B completely contains Schedule A
       - Partial overlap at start
       - Partial overlap at end
     - **Overlap Calculation**: `calculateOverlap()` should return correct duration in minutes
     - **Suggestion Generation**: `generateSuggestions()` should return valid time adjustments

2. **Test Pattern** (DDD Best Practice):
   ```typescript
   describe('Schedule Aggregate', () => {
     describe('detectConflicts()', () => {
       it('should return no conflicts when schedules do not overlap', () => {
         const schedule1 = Schedule.create({ startTime: 1000, endTime: 2000 });
         const schedule2 = Schedule.create({ startTime: 3000, endTime: 4000 });
         const result = schedule1.detectConflicts([schedule2]);
         expect(result.hasConflict).toBe(false);
       });
       
       // More test cases...
     });
   });
   ```

3. **Coverage Command**:
   ```bash
   pnpm nx test domain-server --coverage
   ```

---

### Technical Constraints

**DDD Architecture** [Source: DDD_REFACTORING_FINAL_REPORT.md]:
1. **Domain Layer Purity**:
   - Schedule aggregate MUST NOT depend on repositories
   - `detectConflicts()` should accept `Schedule[]` as parameter (not query repository)
   - Repository calls will be handled by ApplicationService in Story 9.2

2. **Aggregate Root Responsibilities**:
   - Enforce business rules (e.g., startTime < endTime)
   - Encapsulate domain logic (conflict detection algorithm)
   - Emit domain events (if needed, to be decided in Story 9.2)

3. **Value Object Pattern**:
   - Consider creating TimeRange VO if needed (for startTime/endTime validation)
   - Consider creating Duration VO (for duration calculations)

4. **Type Safety**:
   - Use TypeScript readonly properties for DTOs
   - Use strict null checks (`strictNullChecks: true`)
   - Avoid `any` types

**Prisma Schema** [Source: docs/modules/schedule/features/01-conflict-detection.md]:
- Prisma schema changes will be in Story 9.3 (Infrastructure)
- For now, focus on domain contracts and logic

---

## 📝 Tasks / Subtasks

### Task 1: Create Conflict Detection Contracts (AC: 1)
- [x] **Subtask 1.1**: Define `ScheduleServerDTO` interface with conflict fields
  - File: `packages/contracts/src/modules/schedule/aggregates/ScheduleServer.ts`
  - Fields: uuid, accountUuid, title, description, startTime, endTime, duration, hasConflict, conflictingSchedules
- [x] **Subtask 1.2**: Define `ConflictDetectionResult` interface
  - File: `packages/contracts/src/modules/schedule/ConflictDetectionResult.ts`
  - Types: ConflictDetectionResult, ConflictDetail, ConflictSuggestion
- [x] **Subtask 1.3**: Add `ConflictSeverity` enum to existing enums file
  - File: `packages/contracts/src/modules/schedule/enums.ts`
  - Values: MINOR, MODERATE, SEVERE
- [x] **Subtask 1.4**: Export all new contracts from module index
  - File: `packages/contracts/src/modules/schedule/index.ts`
  - Add exports for new interfaces

---

### Task 2: Implement Schedule Aggregate with Conflict Detection (AC: 2)
- [x] **Subtask 2.1**: Create Schedule aggregate root class
  - File: `packages/domain-server/src/schedule/aggregates/Schedule.ts`
  - Extends: `AggregateRoot` (from `@dailyuse/utils`)
  - Private fields: _uuid, _accountUuid, _title, _description, _startTime, _endTime, _duration
- [x] **Subtask 2.2**: Implement `detectConflicts()` method
  - Iterate through `otherSchedules[]` and filter overlapping ones
  - Generate conflict details for each overlap
  - Generate suggestions based on conflicts
  - Return `ConflictDetectionResult`
- [x] **Subtask 2.3**: Implement `isOverlapping()` private method
  - Algorithm: `(this.startTime < other.endTime) && (this.endTime > other.startTime)`
  - Return boolean
- [x] **Subtask 2.4**: Implement `calculateOverlap()` private method
  - Calculate overlap start: `Math.max(this.startTime, other.startTime)`
  - Calculate overlap end: `Math.min(this.endTime, other.endTime)`
  - Return duration in minutes: `(overlapEnd - overlapStart) / 60000`
- [x] **Subtask 2.5**: Implement `generateSuggestions()` private method
  - Suggestion logic (simplified for MVP):
    - `move_later`: Suggest moving to after the last conflicting schedule
    - `move_earlier`: Suggest moving to before the first conflicting schedule
    - `shorten`: Suggest reducing duration to fit gaps
  - Return `ConflictSuggestion[]`
- [x] **Subtask 2.6**: Add factory methods (`create`, `fromDTO`)
  - Validate: `startTime < endTime`
  - Calculate duration: `(endTime - startTime) / 60000`
- [x] **Subtask 2.7**: Export Schedule from aggregates index
  - File: `packages/domain-server/src/schedule/aggregates/index.ts`

---

### Task 3: Write Unit Tests (AC: 3)
- [x] **Subtask 3.1**: Setup test file with test data fixtures
  - File: `packages/domain-server/src/schedule/__tests__/Schedule.spec.ts`
  - Create helper functions to generate test schedules
- [x] **Subtask 3.2**: Test `detectConflicts()` with no conflicts
  - Test: Non-overlapping schedules should return `hasConflict: false`
- [x] **Subtask 3.3**: Test `detectConflicts()` with single conflict
  - Test: Two overlapping schedules should return correct conflict details
  - Verify: scheduleUuid, scheduleTitle, overlapStart, overlapEnd, overlapDuration
- [x] **Subtask 3.4**: Test `detectConflicts()` with multiple conflicts
  - Test: Schedule overlapping with 2+ others should return all conflicts
- [x] **Subtask 3.5**: Test `isOverlapping()` edge cases
  - Test cases:
    - Adjacent schedules (A.endTime === B.startTime) → false
    - Partial overlap at start → true
    - Partial overlap at end → true
    - Complete containment (A inside B) → true
    - Complete containment (B inside A) → true
    - No overlap (A before B) → false
    - No overlap (A after B) → false
- [x] **Subtask 3.6**: Test `calculateOverlap()` accuracy
  - Test: Verify overlap duration calculation in minutes
  - Test edge case: Exact time match should return full duration
- [x] **Subtask 3.7**: Test `generateSuggestions()` logic
  - Test: Suggestions should provide valid alternative times
  - Test: Move_later should be after last conflict
  - Test: Move_earlier should be before first conflict
- [x] **Subtask 3.8**: Run coverage report and verify ≥ 80%
  - Command: `pnpm nx test domain-server --coverage`
  - If < 80%, add missing test cases
  - **Result**: ✅ 94.94% coverage (28/28 tests passed)

---

## 🔄 Dependencies

**Depends On**:
- Sprint 4 completion (STORY-031)
- Existing DDD architecture (`@dailyuse/utils` AggregateRoot)

**Blocks**:
- Story 9.2: Application Service (needs domain logic)
- Story 9.3: Infrastructure (needs contracts)
- Story 9.4: API Endpoints (needs contracts)

---

## 📚 References

**Epic**: [epic-schedule-001-conflict-detection.md](../epics/epic-schedule-001-conflict-detection.md)  
**Feature Spec**: [docs/modules/schedule/features/01-conflict-detection.md](../../modules/schedule/features/01-conflict-detection.md)  
**Architecture**: [DDD_REFACTORING_FINAL_REPORT.md](../../architecture/DDD_REFACTORING_FINAL_REPORT.md)  
**Testing Guide**: [docs/guides/testing-strategy.md](../../guides/testing-strategy.md) (if exists)

---

## ✅ Definition of Done

- [x] All acceptance criteria met
- [x] All tasks/subtasks completed
- [x] Unit tests written with ≥ 80% coverage (94.94% achieved)
- [x] All tests pass (`pnpm nx test domain-server` - 28/28 passed)
- [x] No TypeScript errors (`pnpm nx build contracts` - Success ✅)
- [x] Code follows DDD patterns (no repository dependencies in domain layer)
- [x] Contracts exported from `@dailyuse/contracts`
- [ ] Peer review completed (if applicable)
- [x] Story marked as "Ready for Review" in Sprint 5 tracking

---

## 📋 Dev Agent Record

### Agent Model Used
- **Model**: Claude 3.5 Sonnet (GitHub Copilot)
- **Date**: 2025-10-24
- **Session Duration**: ~45 minutes

### Implementation Summary

**Files Created** (4 new files):
1. `packages/contracts/src/modules/schedule/aggregates/ScheduleServer.ts` (90 lines)
   - Complete ScheduleServerDTO interface with conflict detection fields
   
2. `packages/contracts/src/modules/schedule/ConflictDetectionResult.ts` (98 lines)
   - ConflictDetectionResult, ConflictDetail, ConflictSuggestion interfaces
   
3. `packages/domain-server/src/schedule/aggregates/Schedule.ts` (388 lines)
   - Complete Schedule aggregate root with conflict detection logic
   - Core methods: detectConflicts(), isOverlapping(), calculateOverlap(), generateSuggestions()
   
4. `packages/domain-server/src/schedule/__tests__/Schedule.spec.ts` (743 lines)
   - Comprehensive test suite with 28 test cases covering all edge cases

**Files Modified** (3 files):
1. `packages/contracts/src/modules/schedule/enums.ts`
   - Added ConflictSeverity enum (MINOR, MODERATE, SEVERE)
   
2. `packages/contracts/src/modules/schedule/index.ts`
   - Exported new Schedule contracts
   
3. `packages/domain-server/src/schedule/aggregates/index.ts`
   - Exported Schedule aggregate

### Test Results
- **Test Command**: `pnpm nx test domain-server --run -- Schedule.spec`
- **Tests Passed**: 28/28 ✅
- **Coverage**: 94.94% (exceeds 80% requirement)
- **Uncovered Lines**: 132-133, 136-137 (optional field handling in toServerDTO - acceptable)

### Completion Notes
- ✅ All 3 Acceptance Criteria met
- ✅ All domain logic is pure (no repository dependencies)
- ✅ Conflict detection algorithm handles all edge cases:
  - Adjacent schedules (no overlap)
  - Partial overlaps (start/end)
  - Complete containment (A inside B, B inside A)
  - Multiple conflicts
  - Exact time matches
- ✅ Suggestions generated for 3 strategies: move_earlier, move_later, shorten
- ✅ Factory methods validate business rules (startTime < endTime)

### File List
**Created**:
- `packages/contracts/src/modules/schedule/aggregates/ScheduleServer.ts`
- `packages/contracts/src/modules/schedule/ConflictDetectionResult.ts`
- `packages/domain-server/src/schedule/aggregates/Schedule.ts`
- `packages/domain-server/src/schedule/__tests__/Schedule.spec.ts`

**Modified**:
- `packages/contracts/src/modules/schedule/enums.ts`
- `packages/contracts/src/modules/schedule/index.ts`
- `packages/domain-server/src/schedule/aggregates/index.ts`

### Change Log
- 2025-10-24: Initial implementation by Dev Agent (James)
  - Created all contract interfaces
  - Implemented Schedule aggregate with full conflict detection
  - Wrote comprehensive test suite (28 tests, 94.94% coverage)
  - All tests passing

---

*Story created by: Scrum Master Bob (BMAD Agent)*  
*Implemented by: Dev Agent James (BMAD Agent)*  
*Document version: 1.1*  
*Last updated: 2025-10-24*
