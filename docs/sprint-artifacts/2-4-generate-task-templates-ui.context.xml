<?xml version="1.0" encoding="UTF-8"?>
<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.4</storyId>
    <title>Generate Task Templates UI</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-4-generate-task-templates-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to generate and import tasks into my plan</iWant>
    <soThat>I save time on planning</soThat>
    <tasks>
      <task id="1" priority="high">Extend useAIGeneration Composable with generateTasks() method</task>
      <task id="2" priority="high">Create TaskApiClient Method for task generation</task>
      <task id="3" priority="high">Create TaskAIGenerationDialog Component</task>
      <task id="4" priority="medium">Implement Priority Sorting (HIGH â†’ MEDIUM â†’ LOW)</task>
      <task id="5" priority="high">Integrate Button into KeyResult Detail View</task>
      <task id="6" priority="high">Implement Batch Task Import logic</task>
      <task id="7" priority="medium">Handle Import Errors (partial failures, network errors)</task>
      <task id="8" priority="medium">Navigate to Task List After Import</task>
      <task id="9" priority="medium">Error Handling UI (429, 504, 400, 500)</task>
      <task id="10" priority="high">Unit Tests for dialog and composable</task>
      <task id="11" priority="medium">E2E Test for full import flow</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" type="functional">"Generate Tasks" button visible in KeyResult detail view</criterion>
    <criterion id="AC-2" type="functional">Click button opens TaskAIGenerationDialog</criterion>
    <criterion id="AC-3" type="ux">Dialog shows loading indicator during generation</criterion>
    <criterion id="AC-4" type="functional">Generated tasks displayed in checklist with title, hours, priority</criterion>
    <criterion id="AC-5" type="functional">User can check/uncheck tasks for import</criterion>
    <criterion id="AC-6" type="functional">User can edit task fields (title, hours, priority, description)</criterion>
    <criterion id="AC-7" type="functional">"Import Selected" creates TaskTemplate entities (batch API call)</criterion>
    <criterion id="AC-8" type="functional">Success message shows "7 tasks imported" (count)</criterion>
    <criterion id="AC-9" type="functional">Dialog closes, navigates to Task list view</criterion>
    <criterion id="AC-10" type="ux">Tasks sorted by priority (HIGH â†’ MEDIUM â†’ LOW) by default</criterion>
    <criterion id="AC-11" type="ux">Estimated hours displayed with icon (ðŸ•’ 8 hours)</criterion>
    <criterion id="AC-12" type="ux">Priority displayed with color badges (red/yellow/blue)</criterion>
    <criterion id="AC-13" type="ux">Batch import shows progress indicator if &gt; 5 tasks</criterion>
    <criterion id="AC-14" type="technical">Uses useAIGeneration composable</criterion>
    <criterion id="AC-15" type="technical">Batch create via TaskTemplateApplicationService.createBatch()</criterion>
    <criterion id="AC-16" type="technical">Updates taskStore after import</criterion>
    <criterion id="AC-17" type="technical">Error handling with snackbar</criterion>
    <criterion id="AC-18" type="quality">Component unit tests pass</criterion>
    <criterion id="AC-19" type="quality">Zero console errors</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Task Generation UI">
        UI design for TaskAIGenerationDialog with priority sorting, progress indicator, batch import handling, and dialog layout diagram.
      </doc>
      <doc path="docs/sprint-artifacts/2-3-generate-task-templates-backend.md" title="Story 2.3 Backend" section="API Contract">
        Backend API: POST /api/ai/generate/tasks, TaskTemplatePreview structure (title, description, estimatedHours, priority, dependencies, tags), typical response 10-15 seconds.
      </doc>
      <doc path="docs/sprint-artifacts/2-2-generate-key-results-ui.md" title="Story 2.2 UI" section="Reusable Patterns">
        Similar UI patterns: useAIGeneration composable, dialog loading states, inline editing with Vuetify, error handling with snackbar.
      </doc>
      <doc path="docs/architecture-web.md" title="Web Architecture" section="Component Communication">
        Vue component communication patterns: props down (parent â†’ dialog), events up (dialog â†’ parent), store for global state.
      </doc>
    </docs>
    
    <code>
      <file path="apps/web/src/modules/goal/presentation/composables/useAIGeneration.ts" kind="composable" symbol="useAIGeneration" reason="Extend composable with generateTasks() method following generateKeyResults() pattern"/>
      <file path="apps/web/src/modules/task/infrastructure/api/TaskApiClient.ts" kind="api-client" symbol="TaskApiClient" reason="Add generateTasks() method to call POST /api/ai/generate/tasks"/>
      <file path="apps/web/src/modules/task/presentation/stores/taskStore.ts" kind="store" symbol="taskStore" reason="Use addTasks() method to add batch imported tasks to store"/>
      <file path="apps/web/src/modules/goal/presentation/views/KeyResultDetailView.vue" kind="view" symbol="KeyResultDetailView" reason="Add 'Generate Tasks' button below KR details, above task list"/>
      <file path="apps/web/src/composables/useMessage.ts" kind="composable" symbol="useMessage" reason="Use for snackbar notifications (showError, showSuccess, showWarning)"/>
    </code>
    
    <dependencies>
      <package name="vue" version="^3.5" ecosystem="npm">Vue 3 Composition API</package>
      <package name="vuetify" version="^3.7" ecosystem="npm">Vuetify components (v-dialog, v-list, v-checkbox, v-text-field, v-select, v-chip, v-progress-linear)</package>
      <package name="pinia" version="^2.2" ecosystem="npm">State management (taskStore)</package>
      <package name="vue-router" version="^4.5" ecosystem="npm">Navigation (router.push('/tasks'))</package>
      <package name="@dailyuse/contracts" version="workspace:*" ecosystem="pnpm-workspace">DTOs (GenerateTasksRequest, GenerateTasksResponse, TaskTemplatePreview, TaskPriority)</package>
      <package name="@dailyuse/domain-client" version="workspace:*" ecosystem="pnpm-workspace">Client-side entities (TaskTemplateClient)</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Reuse useAIGeneration composable from Story 2.2 - extend with generateTasks() method, follow same error handling pattern</constraint>
    <constraint type="ux">Priority color scheme: HIGH=red (v-chip color="error"), MEDIUM=amber (v-chip color="warning"), LOW=blue (v-chip color="info")</constraint>
    <constraint type="ux">Loading indicator appears immediately, display during 10-15 second API call</constraint>
    <constraint type="ux">Progress indicator (v-progress-linear) shown when importing &gt; 5 tasks, update percentage (count/total * 100)</constraint>
    <constraint type="validation">Client-side validation: krTitle required before generation, estimatedHours â‰¥ 1</constraint>
    <constraint type="batch-import">Two strategies: 1) Single batch API POST /api/tasks/batch (preferred), 2) Parallel individual POST /api/tasks (fallback)</constraint>
    <constraint type="error-handling">Handle partial failures: "5 tasks imported. 2 failed." with retry option for failed tasks</constraint>
    <constraint type="navigation">After successful import, navigate to task list view with newly imported tasks highlighted (temporary CSS class, fade after 2s)</constraint>
    <constraint type="accessibility">Dialog keyboard accessible, ESC to close, focus trap, ARIA labels for checkboxes</constraint>
  </constraints>

  <interfaces>
    <interface name="useAIGeneration.generateTasks()" kind="composable-method" signature="(request: GenerateTasksRequest) =&gt; Promise&lt;GenerateTasksResponse&gt;" path="apps/web/src/modules/goal/presentation/composables/useAIGeneration.ts"/>
    <interface name="TaskApiClient.generateTasks()" kind="api-method" signature="async generateTasks(request: GenerateTasksRequest): Promise&lt;GenerateTasksResponse&gt;" path="apps/web/src/modules/task/infrastructure/api/TaskApiClient.ts"/>
    <interface name="TaskApiClient.createBatch()" kind="api-method" signature="async createBatch(tasks: CreateTaskTemplateRequest[]): Promise&lt;TaskTemplateClientDTO[]&gt;" path="apps/web/src/modules/task/infrastructure/api/TaskApiClient.ts"/>
    <interface name="taskStore.addTasks()" kind="store-action" signature="addTasks(tasks: TaskTemplateClient[]): void" path="apps/web/src/modules/task/presentation/stores/taskStore.ts"/>
    <interface name="TaskAIGenerationDialog" kind="vue-component" signature="props: { modelValue: boolean, keyResultTitle: string, keyResultDescription?: string, targetValue: number, currentValue: number, unit?: string, timeRemaining: number }, emits: { 'update:modelValue': boolean, 'tasksImported': number }" path="apps/web/src/modules/task/presentation/components/TaskAIGenerationDialog.vue"/>
    <interface name="router.push()" kind="vue-router" signature="(location: string) =&gt; void" path="vue-router"/>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Vitest 3.2.4 + @vue/test-utils 2.4.6 for component tests. E2E: Playwright 1.56.1 for full user journey. Mock API responses for unit tests. Coverage target: â‰¥70% for new components.
    </standards>
    <locations>
      <location>apps/web/src/modules/task/presentation/components/__tests__/TaskAIGenerationDialog.test.ts</location>
      <location>apps/web/src/modules/goal/presentation/composables/__tests__/useAIGeneration.test.ts</location>
      <location>apps/web/e2e/task/ai-generate-tasks.spec.ts</location>
    </locations>
    <ideas>
      <idea criterion="AC-1">E2E: Navigate to Goal detail â†’ Click KR â†’ Assert "Generate Tasks" button visible</idea>
      <idea criterion="AC-2">Unit test: Click button â†’ Assert dialog.visible = true</idea>
      <idea criterion="AC-3">Unit test: During API call â†’ Assert v-progress-circular visible</idea>
      <idea criterion="AC-4">Unit test: After API response â†’ Assert 5-10 v-list-item elements with task data</idea>
      <idea criterion="AC-5">Unit test: Click checkbox â†’ Assert selected array updated</idea>
      <idea criterion="AC-6">Unit test: Edit hours in v-text-field type=number â†’ Assert task.estimatedHours updated</idea>
      <idea criterion="AC-7">Unit test: Click "Import Selected" â†’ Assert TaskApiClient.createBatch() called with 7 tasks</idea>
      <idea criterion="AC-8">Unit test: After import â†’ Assert snackbar displays "7 tasks imported"</idea>
      <idea criterion="AC-9">Unit test: After import â†’ Assert router.push('/tasks') called</idea>
      <idea criterion="AC-10">Unit test: Assert tasks sorted â†’ HIGH tasks appear before MEDIUM, MEDIUM before LOW</idea>
      <idea criterion="AC-11">Unit test: Assert v-icon "mdi-clock-outline" present next to hours</idea>
      <idea criterion="AC-12">Unit test: Assert HIGH task has v-chip color="error", MEDIUM has color="warning"</idea>
      <idea criterion="AC-13">Unit test: Import 10 tasks â†’ Assert v-progress-linear visible, percentage 0% â†’ 100%</idea>
      <idea criterion="AC-17">Unit test: Mock 429 response â†’ Assert snackbar displays "Daily quota exceeded"</idea>
      <idea criterion="AC-19">E2E: Full flow â†’ Assert no console.error() calls</idea>
    </ideas>
  </tests>
</story-context>
