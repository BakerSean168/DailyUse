# 技术评审会议：EPIC-003/004/005 方案评审

**会议日期**: 待定  
**评审范围**: 性能优化、离线同步客户端、后端同步服务  
**参与角色**: Tech Lead, 前端开发, 后端开发, QA, DevOps  
**预计时长**: 2-3 小时

---

## 📋 会议议程

| 时间 | 议题 | 主讲 | 重点讨论 |
|------|------|------|---------|
| 0:00-0:15 | 会议开场 & 背景介绍 | PM | EPIC 间依赖关系 |
| 0:15-0:45 | EPIC-003 技术方案 | 前端 | 性能测量、优化策略 |
| 0:45-1:30 | EPIC-004 技术方案 | 前端 | 状态机、本地存储、冲突处理 |
| 1:30-2:15 | EPIC-005 技术方案 | 后端 | API 设计、数据库、安全 |
| 2:15-2:45 | 集成点讨论 | 全员 | 接口契约、端到端流程 |
| 2:45-3:00 | 风险评估 & 决策 | Tech Lead | 技术债、优先级 |

---

## 🔗 EPIC 依赖关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          EPIC 依赖关系图                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────────┐                                                      │
│   │  EPIC-002    │                                                      │
│   │   Desktop    │◄── ✅ Completed                                      │
│   │ Application  │                                                      │
│   └──────┬───────┘                                                      │
│          │                                                              │
│          ├────────────────────────┬─────────────────────────┐          │
│          │                        │                         │          │
│          ▼                        ▼                         │          │
│   ┌──────────────┐         ┌──────────────┐                │          │
│   │  EPIC-003    │         │  EPIC-004    │                │          │
│   │ Performance  │         │ Client Sync  │◄───────────────┤          │
│   │ Optimization │         │ (离线同步)    │                │          │
│   └──────────────┘         └──────┬───────┘                │          │
│        P2                         │                         │          │
│   独立实施 ✓                       │ 双向依赖               │          │
│                                   ▼                         │          │
│                            ┌──────────────┐                 │          │
│                            │  EPIC-005    │─────────────────┘          │
│                            │ Backend Sync │                            │
│                            │   Service    │                            │
│                            └──────────────┘                            │
│                                  P3                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

实施建议顺序:
1️⃣ EPIC-003 (独立，可立即开始)
2️⃣ EPIC-005 → EPIC-004 (先后端 API，再客户端实现)
   或 EPIC-004 + EPIC-005 并行开发（定义接口契约后）
```

---

# 📊 EPIC-003: 性能优化

## 评审要点

### 1. 性能目标

| 指标 | 当前估计 | 目标 | 风险等级 |
|------|----------|------|---------|
| 冷启动时间 | ~5-8s | **< 3s** | 🟡 中 |
| 内存占用 | ~400-500MB | **< 300MB** | 🟡 中 |
| 首屏渲染 | ~2-3s | **< 1.5s** | 🟢 低 |
| IPC 响应 | ~50-100ms | **< 30ms** | 🟡 中 |

### 2. 技术方案概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    EPIC-003 优化策略矩阵                         │
├───────────────────┬─────────────────────────────────────────────┤
│     优化维度       │            具体措施                         │
├───────────────────┼─────────────────────────────────────────────┤
│                   │ • 预加载关键模块                             │
│   启动时间优化     │ • 延迟加载非关键功能                         │
│   STORY-016       │ • 代码分割 & Tree Shaking                   │
│                   │ • Electron 启动参数优化                      │
├───────────────────┼─────────────────────────────────────────────┤
│                   │ • 组件按需加载 (Vue async components)        │
│   内存优化        │ • 大数据列表虚拟滚动                         │
│   STORY-017       │ • 图片懒加载 & 缓存策略                      │
│                   │ • 内存泄漏检测 (24h 监控)                    │
├───────────────────┼─────────────────────────────────────────────┤
│                   │ • IPC 批量处理                               │
│   IPC 优化        │ • 消息序列化优化                             │
│   STORY-018       │ • 主进程逻辑精简                             │
│                   │ • 异步 IPC 队列                              │
└───────────────────┴─────────────────────────────────────────────┘
```

### 3. 讨论问题

| # | 问题 | 背景 | 决策选项 |
|---|------|------|---------|
| Q1 | 性能基准如何持续监控？ | 需要防止性能回退 | A) CI 集成 B) 定期手动测试 |
| Q2 | 最低配置 (4GB RAM) 是否必须支持？ | 影响优化深度 | A) 必须 B) 仅推荐配置 |
| Q3 | 是否需要性能预算机制？ | 控制每次提交的性能影响 | A) 需要 B) 后期考虑 |

### 4. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 优化效果不达预期 | 30% | 中 | 分阶段验证，及时调整 |
| 引入功能回退 | 20% | 高 | 自动化回归测试 |
| 影响开发效率 | 40% | 低 | 仅在 CI 中强制检查 |

---

# 📊 EPIC-004: 离线同步客户端

## 评审要点

### 1. 核心架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    客户端同步架构 (Electron)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Renderer Process                           Main Process               │
│  ┌─────────────────────────────────┐       ┌─────────────────────┐     │
│  │                                 │       │                     │     │
│  │  ┌─────────────────────────┐   │       │  ┌───────────────┐  │     │
│  │  │     Vue Application     │   │  IPC  │  │  SyncService  │  │     │
│  │  │  ┌───────────────────┐  │◄──┼──────►│  │               │  │     │
│  │  │  │   Sync Store      │  │   │       │  │  • pushChanges│  │     │
│  │  │  │   (Pinia)         │  │   │       │  │  • pullChanges│  │     │
│  │  │  └───────────────────┘  │   │       │  │  • resolve    │  │     │
│  │  │           │              │   │       │  └───────┬───────┘  │     │
│  │  │           ▼              │   │       │          │          │     │
│  │  │  ┌───────────────────┐  │   │       │          ▼          │     │
│  │  │  │  Conflict UI      │  │   │       │  ┌───────────────┐  │     │
│  │  │  │  Resolution       │  │   │       │  │ SQLite        │  │     │
│  │  │  └───────────────────┘  │   │       │  │ (本地存储)     │  │     │
│  │  └─────────────────────────┘   │       │  └───────────────┘  │     │
│  │                                 │       │          │          │     │
│  └─────────────────────────────────┘       │          │          │     │
│                                            │          ▼          │     │
│                                            │  ┌───────────────┐  │     │
│                                            │  │ NetworkService│──┼──►云端
│                                            │  │ (HTTP Client) │  │     │
│                                            │  └───────────────┘  │     │
│                                            │                     │     │
│                                            └─────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2. 同步状态机

```typescript
// 6 种状态 + 8 种事件
enum SyncState {
  IDLE      = 'idle',       // 空闲，无待同步变更
  PENDING   = 'pending',    // 有待同步变更，等待同步
  SYNCING   = 'syncing',    // 正在同步中
  CONFLICT  = 'conflict',   // 检测到冲突，等待解决
  ERROR     = 'error',      // 同步失败
  OFFLINE   = 'offline',    // 离线模式
}
```

**状态转换验证问题：**

| # | 场景 | 当前设计 | 需确认 |
|---|------|---------|--------|
| 1 | 同步中网络断开 | SYNCING → OFFLINE | ✅ 已处理 |
| 2 | 离线时产生新变更 | OFFLINE 状态保持，记录变更 | ✅ 已处理 |
| 3 | 同步失败后自动重试 | 指数退避，最大5次 | ⚠️ 需确认次数 |
| 4 | 多冲突连续处理 | 逐个处理，不阻塞 UI | ✅ 已处理 |

### 3. 本地存储设计

```sql
-- SQLite 同步相关表
CREATE TABLE sync_log (
    id INTEGER PRIMARY KEY,
    event_id TEXT UNIQUE,
    entity_type TEXT,
    entity_id TEXT,
    operation TEXT,
    payload TEXT,        -- JSON
    local_version INTEGER,
    synced INTEGER DEFAULT 0,
    created_at INTEGER
);

CREATE TABLE sync_state (
    id INTEGER PRIMARY KEY,
    last_sync_version INTEGER DEFAULT 0,
    last_sync_at INTEGER,
    device_id TEXT
);

CREATE TABLE conflict_records (
    id INTEGER PRIMARY KEY,
    entity_type TEXT,
    entity_id TEXT,
    local_data TEXT,
    remote_data TEXT,
    resolved INTEGER DEFAULT 0,
    resolution TEXT,
    created_at INTEGER
);
```

### 4. 讨论问题

| # | 问题 | 背景 | 决策选项 |
|---|------|------|---------|
| Q1 | 冲突解决 UI 何时弹出？ | 避免打断用户 | A) 立即 B) 任务栏提示 C) 下次打开时 |
| Q2 | 离线变更上限？ | 防止数据积压 | A) 无限制 B) 1000条 C) 按时间清理 |
| Q3 | 同步频率如何控制？ | 平衡实时性与性能 | A) 实时 B) 500ms防抖 C) 用户配置 |
| Q4 | 首次同步是增量还是全量？ | 新设备场景 | A) 全量快照 B) 增量回放 |

### 5. 与 EPIC-005 接口契约

```typescript
// 客户端调用的后端 API
interface SyncAPI {
  // 推送变更
  push(request: SyncPushRequest): Promise<SyncPushResponse>;
  
  // 拉取变更
  pull(request: SyncPullRequest): Promise<SyncPullResponse>;
  
  // 设备管理
  registerDevice(dto: RegisterDeviceDto): Promise<DeviceResponse>;
  
  // 冲突解决
  resolveConflict(id: string, dto: ResolveConflictDto): Promise<void>;
}
```

### 6. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| SQLite 性能瓶颈 | 20% | 中 | 批量写入、索引优化 |
| 状态机边界情况 | 30% | 高 | 详细的状态转换测试 |
| 冲突解决 UX 复杂 | 40% | 中 | 先实现简单版本 |
| 与后端契约不匹配 | 25% | 高 | 先定义 OpenAPI spec |

---

# 📊 EPIC-005: 后端同步服务

## 评审要点

### 1. 核心架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        后端同步服务架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    Clients              API Layer                  Business Layer       │
│   ┌─────────┐       ┌──────────────────┐       ┌──────────────────┐    │
│   │Desktop  │──────►│ /sync/push       │──────►│  SyncService     │    │
│   │   Web   │       │ /sync/pull       │       │  ConflictDetector│    │
│   │ Mobile  │       │ /sync/devices    │       │  DeviceManager   │    │
│   └─────────┘       │ /sync/conflicts  │       └────────┬─────────┘    │
│                     └──────────────────┘                │              │
│                                                         ▼              │
│                     ┌───────────────────────────────────────────┐      │
│                     │              PostgreSQL                    │      │
│                     │  sync_events │ entity_versions │ devices  │      │
│                     │  sync_cursors │ sync_conflicts            │      │
│                     └───────────────────────────────────────────┘      │
│                                                                         │
│                     ┌───────────────────────────────────────────┐      │
│                     │                 Redis                      │      │
│                     │  分布式锁 │ 在线状态 │ 速率限制 │ 缓存    │      │
│                     └───────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2. 数据模型决策

| 表名 | 用途 | 增长速度 | 归档策略 |
|------|------|---------|---------|
| sync_events | 事件溯源 | 高 | 90天后归档 |
| entity_versions | 当前状态 | 中 | 不归档 |
| devices | 设备注册 | 低 | 90天不活跃清理 |
| sync_cursors | 同步进度 | 低 | 跟随设备 |
| sync_conflicts | 冲突记录 | 中 | 30天后归档 |

### 3. API 设计

```yaml
# OpenAPI 3.0 核心端点
paths:
  /sync/push:
    post:
      summary: 推送本地变更到服务端
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                deviceId: { type: string }
                changes: { type: array }
      responses:
        200:
          description: 推送结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  accepted: { type: array }
                  conflicts: { type: array }
                  newVersion: { type: integer }
        409:
          description: 版本冲突
        423:
          description: 同步锁超时
        429:
          description: 速率限制

  /sync/pull:
    post:
      summary: 从服务端拉取远程变更
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                deviceId: { type: string }
                lastSyncVersion: { type: integer }
                limit: { type: integer, default: 100 }
      responses:
        200:
          description: 变更列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  changes: { type: array }
                  currentVersion: { type: integer }
                  hasMore: { type: boolean }
```

### 4. 安全设计

| 安全措施 | 实现方式 | 状态 |
|---------|---------|------|
| 用户隔离 | PostgreSQL RLS | ✅ 已设计 |
| 设备认证 | JWT + Device ID | ✅ 已设计 |
| 速率限制 | Redis + 滑动窗口 | ✅ 已设计 |
| SQL 注入防护 | 参数化查询 | ✅ 已设计 |
| 数据加密传输 | HTTPS | ✅ 基础设施 |
| 数据静态加密 | PostgreSQL 透明加密 | ⚠️ 待确认 |

### 5. 讨论问题

| # | 问题 | 背景 | 决策选项 |
|---|------|------|---------|
| Q1 | 版本号策略？ | 用户级 vs 全局 | A) 用户级递增 B) 全局递增 |
| Q2 | 事件归档存储？ | 成本考虑 | A) S3 B) PostgreSQL 分区 C) 直接删除 |
| Q3 | WebSocket 是否 Phase 1？ | 实时性需求 | A) 是 B) Phase 2 |
| Q4 | 冲突自动合并范围？ | 减少用户干预 | A) 仅非冲突字段 B) 基于规则 |
| Q5 | 多租户 vs 单租户部署？ | 架构影响 | A) 多租户 B) 可配置 |

### 6. 性能要求

| 指标 | 目标 | 监控方式 |
|------|------|---------|
| Push API (p95) | < 200ms | Prometheus |
| Pull API (p95) | < 300ms | Prometheus |
| 冲突率 | < 5% | 业务指标 |
| 并发用户 | 10,000+ | 负载测试 |

### 7. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 高并发死锁 | 25% | 高 | 分布式锁 + 超时 |
| 数据不一致 | 10% | 极高 | 事务 + 版本校验 |
| 存储成本增长 | 60% | 中 | 归档 + 压缩 |
| 版本号溢出 | 1% | 高 | BIGINT + 监控 |

---

# 🔗 集成点讨论

## 端到端同步流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           端到端同步流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Device A                    Server                    Device B             │
│  ────────                    ──────                    ────────             │
│      │                          │                          │                │
│      │  1. 用户修改数据          │                          │                │
│      │  2. 写入本地 SQLite       │                          │                │
│      │  3. 触发 PENDING 状态     │                          │                │
│      │                          │                          │                │
│      │──────────────────────────►                          │                │
│      │  4. POST /sync/push      │                          │                │
│      │     { changes: [...] }   │                          │                │
│      │                          │                          │                │
│      │                          │  5. 检查版本冲突          │                │
│      │                          │  6. 写入 sync_events     │                │
│      │                          │  7. 更新 entity_versions │                │
│      │                          │                          │                │
│      │◄──────────────────────────│                          │                │
│      │  8. { accepted: [...],   │                          │                │
│      │       newVersion: 42 }   │                          │                │
│      │                          │                          │                │
│      │  9. 更新本地版本号        │                          │                │
│      │  10. 清除待同步队列       │──────────────────────────►               │
│      │                          │  11. WebSocket 通知       │                │
│      │                          │      (可选)              │                │
│      │                          │                          │                │
│      │                          │◄──────────────────────────│               │
│      │                          │  12. POST /sync/pull     │                │
│      │                          │      { lastVersion: 40 } │                │
│      │                          │                          │                │
│      │                          │──────────────────────────►               │
│      │                          │  13. { changes: [...],   │                │
│      │                          │        hasMore: false }  │                │
│      │                          │                          │                │
│      │                          │  14. 应用变更到本地       │                │
│      │                          │  15. 更新同步游标         │                │
│      │                          │                          │                │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 接口契约确认清单

| 接口 | 客户端 (EPIC-004) | 服务端 (EPIC-005) | 状态 |
|------|------------------|-------------------|------|
| 设备注册 | `DeviceService.register()` | `POST /sync/devices` | ⚠️ 待对齐 |
| 推送变更 | `SyncService.push()` | `POST /sync/push` | ⚠️ 待对齐 |
| 拉取变更 | `SyncService.pull()` | `POST /sync/pull` | ⚠️ 待对齐 |
| 解决冲突 | `ConflictResolver.resolve()` | `POST /sync/conflicts/:id/resolve` | ⚠️ 待对齐 |

**建议**: 在开发前创建 OpenAPI 3.0 规范文件，作为契约基准。

---

# 📋 决策记录

> ✅ **评审完成**: 2025-12-07 | 所有决策已确定

## 决策结果

| ID | 决策点 | EPIC | 决策结果 | 理由 |
|----|--------|------|----------|------|
| D1 | 性能基准 CI 集成 | 003 | **A+B 混合** | PR轻量冒烟 + 每日完整基准 |
| D2 | 冲突 UI 弹出时机 | 004 | **B) 任务栏通知** | 不打断用户专注工作 |
| D3 | 离线变更上限 | 004 | **B) 1000条** | 覆盖99%使用场景 |
| D4 | 同步防抖时间 | 004 | **B) 500ms** | 平衡实时性和性能 |
| D5 | 版本号范围 | 005 | **A) 用户级递增** | 更好扩展性，避免全局热点 |
| D6 | 事件归档存储 | 005 | **B) PostgreSQL 分区** | 简化运维，可直接查询 |
| D7 | WebSocket Phase | 005 | **B) Phase 2** | 先验证核心同步逻辑 |
| D8 | 数据静态加密 | 005 | **B) 暂不需要** | HTTPS已加密传输 |
| D9 | EPIC 实施顺序 | ALL | **B) 并行开发** | 契约优先，Week 0 产出 OpenAPI |

## 评审新增发现

| 发现项 | EPIC | 优先级 | 状态 |
|--------|------|--------|------|
| SQLite 添加 retry_count, last_error 字段 | 004 | 高 | ✅ 已补充 |
| 添加"禁用同步"用户设置 | 004 | 中 | ✅ 已补充 |
| Redis 降级策略 (回退数据库行锁) | 005 | 高 | ✅ 已补充 |
| STORY-025 拆分为 3 个子 Story | 005 | 高 | ✅ 已拆分 |

---

# ✅ 会议输出检查清单

会议结束时应确认：

- [x] 所有待决策事项已有结论
- [x] 接口契约已达成一致 (Week 0 产出 OpenAPI)
- [x] 风险缓解措施已确认
- [ ] 各 EPIC 负责人已指定 (待分配)
- [x] 下一步行动计划已明确 (见 decision-log.md)
- [x] 评审意见已记录

---

# 📎 附件

1. [EPIC-003 完整文档](../EPIC-003-performance-optimization.md)
2. [EPIC-004 完整文档](../EPIC-004-offline-sync.md)
3. [EPIC-005 完整文档](../EPIC-005-backend-sync-service.md)
4. [决策跟踪表](./decision-log.md) - **新增**

---

**文档版本**: v2.0  
**创建日期**: 2025-12-07  
**评审完成**: 2025-12-07  
**创建者**: PM Agent
