# 技术决策跟踪表

## 决策记录

| ID | 决策点 | EPIC | 选项 | 决策结果 | 理由 | 决策人 | 决策日期 |
|----|--------|------|------|----------|------|--------|----------|
| D1 | 性能基准 CI 集成频率 | 003 | A) 每次 PR<br>B) 每日构建<br>C) 每周 | **A+B 混合** | PR轻量冒烟+每日完整基准，平衡成本和反馈速度 | Tech Review | 2025-12-07 |
| D2 | 冲突 UI 弹出时机 | 004 | A) 立即弹窗<br>B) 任务栏通知<br>C) 下次打开时 | **B) 任务栏通知** | 不打断用户专注工作，红点提示+专门冲突管理页 | Tech Review | 2025-12-07 |
| D3 | 离线变更数量上限 | 004 | A) 无限制<br>B) 1000 条<br>C) 按时间 (7天) | **B) 1000 条** | 覆盖99%使用场景，超出时友好提示 | Tech Review | 2025-12-07 |
| D4 | 同步防抖时间 | 004 | A) 实时<br>B) 500ms<br>C) 用户可配置 | **B) 500ms** | 平衡实时性和性能，减少网络请求 | Tech Review | 2025-12-07 |
| D5 | 版本号范围 | 005 | A) 用户级递增<br>B) 全局递增 | **A) 用户级递增** | 更好的扩展性，避免全局热点 | Tech Review | 2025-12-07 |
| D6 | 事件归档存储方案 | 005 | A) S3/GCS<br>B) PostgreSQL 分区<br>C) 直接删除 | **B) PostgreSQL 分区** | 简化运维，可直接查询历史，后期可迁移S3 | Tech Review | 2025-12-07 |
| D7 | WebSocket 实现阶段 | 005 | A) Phase 1<br>B) Phase 2 | **B) Phase 2** | 先用轮询验证核心同步逻辑，降低初期复杂度 | Tech Review | 2025-12-07 |
| D8 | 数据静态加密 | 005 | A) 需要<br>B) 不需要 | **B) 暂不需要** | HTTPS已加密传输，数据敏感度中等，后期可按需添加 | Tech Review | 2025-12-07 |
| D9 | EPIC 实施顺序 | ALL | A) 003 → 005 → 004<br>B) 003 独立 + 004/005 并行 | **B) 并行开发** | 契约优先(Week 0产出OpenAPI)，时间效率最优 | Tech Review | 2025-12-07 |

---

## 决策详情

### D1: 性能基准 CI 集成频率

**背景**: 需要在 CI 中运行性能基准测试，防止性能回退。

| 选项 | 优点 | 缺点 |
|------|------|------|
| A) 每次 PR | 及时发现问题 | CI 时间增加、成本高 |
| B) 每日构建 | 平衡成本与反馈 | 问题发现延迟 |
| C) 每周 | 成本最低 | 难以定位引入问题的提交 |

**建议**: B) 每日构建 + 关键 PR 手动触发

---

### D2: 冲突 UI 弹出时机

**背景**: 当检测到同步冲突时，如何通知用户。

| 选项 | 用户体验 | 技术复杂度 |
|------|---------|-----------|
| A) 立即弹窗 | 可能打断工作 | 低 |
| B) 任务栏通知 | 非侵入式 | 中 |
| C) 下次打开时 | 延迟处理 | 低 |

**建议**: B) 任务栏通知 + 专门的冲突管理页面

---

### D3: 离线变更数量上限

**背景**: 长时间离线可能积累大量变更，影响同步性能。

| 选项 | 存储影响 | 同步复杂度 |
|------|---------|-----------|
| A) 无限制 | 高 | 高 |
| B) 1000 条 | 低 | 低 |
| C) 按时间 (7天) | 中 | 中 |

**建议**: B) 1000 条 + 超出时提醒用户

---

### D4: 同步防抖时间

**背景**: 频繁的小变更如何批量同步。

| 选项 | 实时性 | 性能 |
|------|--------|------|
| A) 实时 | 最高 | 可能有压力 |
| B) 500ms | 高 | 良好 |
| C) 用户可配置 | 灵活 | 增加复杂度 |

**建议**: B) 500ms 防抖

---

### D5: 版本号范围

**背景**: 版本号是用户级别还是全局级别递增。

| 选项 | 扩展性 | 复杂度 |
|------|--------|--------|
| A) 用户级递增 | 更好 | 稍复杂 |
| B) 全局递增 | 受限 | 简单 |

**建议**: A) 用户级递增（已在 EPIC-005 中设计）

---

### D6: 事件归档存储方案

**背景**: 历史同步事件的存储和清理策略。

| 选项 | 成本 | 可查询性 | 复杂度 |
|------|------|---------|--------|
| A) S3/GCS | 低 | 需额外工具 | 中 |
| B) PostgreSQL 分区 | 中 | 直接查询 | 中 |
| C) 直接删除 | 最低 | 无法恢复 | 低 |

**建议**: B) PostgreSQL 分区（简化运维）或 A) S3（长期成本优化）

---

### D7: WebSocket 实现阶段

**背景**: 实时推送功能的实现时机。

| 选项 | 用户体验 | 开发成本 |
|------|---------|---------|
| A) Phase 1 | 最佳 | 高 |
| B) Phase 2 | 可接受（轮询） | 分阶段 |

**建议**: B) Phase 2（先用轮询验证核心同步逻辑）

---

### D8: 数据静态加密

**背景**: PostgreSQL 中的用户数据是否需要加密存储。

| 选项 | 安全性 | 性能 | 成本 |
|------|--------|------|------|
| A) 需要 | 高 | 有影响 | 需配置 |
| B) 不需要 | 基础 | 无影响 | 无 |

**考虑因素**: 
- 数据敏感程度
- 合规要求
- 已有 HTTPS 传输加密

**建议**: 根据合规要求决定

---

### D9: EPIC 实施顺序

**背景**: 三个 EPIC 的开发顺序。

| 选项 | 优点 | 缺点 |
|------|------|------|
| A) 003 → 005 → 004 | 风险低，串行 | 总时间长 |
| B) 003 独立 + 004/005 并行 | 时间最优 | 需要严格契约管理 |

**建议**: B) 并行开发（先定义 OpenAPI 契约）

---

## 行动项

| # | 行动项 | 负责人 | 截止日期 | 状态 |
|---|--------|--------|----------|------|
| 1 | 创建 OpenAPI 3.0 规范文件 (sync-api.yaml) | 后端 | Week 0 | 🟡 进行中 |
| 2 | 设置 Mock Server 供前端开发 | 后端 | Week 0 | ⬜ 待开始 |
| 3 | EPIC-003 Sprint 规划 + 启动 | 前端 | Week 1 | ⬜ 待开始 |
| 4 | EPIC-004 SQLite 表设计更新 (添加 retry_count, last_error) | 前端 | Week 1 | ⬜ 待开始 |
| 5 | EPIC-005 STORY-025 拆分为 025a/b/c | SM | Week 0 | ⬜ 待开始 |
| 6 | 性能基准 CI 配置 (分层测试策略) | DevOps | Week 1 | ⬜ 待开始 |
| 7 | 数据库迁移脚本准备 (含分区策略) | 后端 | Week 1 | ⬜ 待开始 |
| 8 | Redis 降级策略文档补充 | 后端 | Week 1 | ⬜ 待开始 |
| 9 | 添加"禁用同步"用户设置设计 | PM | Week 0 | ⬜ 待开始 |

---

## 评审新增发现

### 需要补充到 EPIC 的内容

| 发现项 | 关联 EPIC | 类型 | 优先级 |
|--------|----------|------|--------|
| SQLite 表添加 retry_count, last_error, priority 字段 | EPIC-004 | 技术补充 | 高 |
| 添加"禁用同步"用户设置 | EPIC-004 | 产品需求 | 中 |
| Redis 降级策略 (回退到数据库行锁) | EPIC-005 | 技术补充 | 高 |
| STORY-025 拆分为 3 个子 Story | EPIC-005 | 规划调整 | 高 |
| 性能目标调整：最低配置冷启动 < 5s | EPIC-003 | 目标调整 | 中 |

---

**更新记录**

| 日期 | 更新内容 | 更新人 |
|------|---------|--------|
| 2025-12-07 | 创建决策跟踪表 | PM |
| 2025-12-07 | 完成技术评审，填入所有决策结果和行动项 | Tech Review |

