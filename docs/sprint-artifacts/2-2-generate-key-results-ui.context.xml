<?xml version="1.0" encoding="UTF-8"?>
<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.2</storyId>
    <title>Generate Key Results UI</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-generate-key-results-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to see and select generated Key Results in the Goal form</iWant>
    <soThat>I can quickly populate my goal</soThat>
    <tasks>
      <task id="1" priority="high">Create useAIGeneration Composable with generateKeyResults() method</task>
      <task id="2" priority="high">Extend GoalApiClient with generateKeyResults() API call</task>
      <task id="3" priority="high">Create KeyResultAIGenerationDialog Component (loading, display, selection, editing)</task>
      <task id="4" priority="high">Integrate AI Button into GoalForm component</task>
      <task id="5" priority="medium">Handle KR Selection and Addition to goalStore</task>
      <task id="6" priority="medium">Error Handling UI (429, 504, 400, 500 errors)</task>
      <task id="7" priority="low">Weight Redistribution Logic (optional)</task>
      <task id="8" priority="high">Unit Tests for dialog and composable</task>
      <task id="9" priority="medium">E2E Test for full generation flow</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" type="functional">"AI Generate" button visible in Goal creation/edit form</criterion>
    <criterion id="AC-2" type="functional">Click button opens KeyResultAIGenerationDialog</criterion>
    <criterion id="AC-3" type="ux">Dialog shows loading indicator during API call (8-12 seconds)</criterion>
    <criterion id="AC-4" type="functional">Generated KRs displayed in list with title, target, weight</criterion>
    <criterion id="AC-5" type="functional">User can check/uncheck each KR for selection</criterion>
    <criterion id="AC-6" type="functional">User can edit KR fields (title, target, unit) before adding</criterion>
    <criterion id="AC-7" type="functional">"Add Selected" button creates KeyResult entities and adds to Goal</criterion>
    <criterion id="AC-8" type="functional">Dialog closes after successful addition, Goal form updated with new KRs</criterion>
    <criterion id="AC-9" type="functional">Error messages displayed for quota exceeded (429) or timeout (504)</criterion>
    <criterion id="AC-10" type="ux">Button icon is "✨ AI Magic" or similar</criterion>
    <criterion id="AC-11" type="ux">Loading state shows animated spinner + "Generating with AI..."</criterion>
    <criterion id="AC-12" type="ux">Success state shows checkmark + "3 Key Results generated"</criterion>
    <criterion id="AC-13" type="ux">KR list supports drag-to-reorder (optional, weight-based order default)</criterion>
    <criterion id="AC-14" type="technical">Inline editing uses Vuetify v-text-field components</criterion>
    <criterion id="AC-15" type="technical">Uses useAIGeneration composable for API calls</criterion>
    <criterion id="AC-16" type="technical">Updates goalStore after adding KRs</criterion>
    <criterion id="AC-17" type="technical">Handles errors with useMessage composable (snackbar)</criterion>
    <criterion id="AC-18" type="quality">Zero console errors during happy path</criterion>
    <criterion id="AC-19" type="quality">Component passes Vue Test Utils unit tests</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Frontend Components">
        Detailed UI design for KeyResultAIGenerationDialog with loading states, inline editing, error handling, and dialog layout diagram.
      </doc>
      <doc path="docs/sprint-artifacts/2-1-generate-key-results-backend.md" title="Story 2.1 Backend" section="API Contract">
        Backend API: POST /api/ai/generate/key-results, request/response DTOs, error codes (429, 504, 400, 500), typical response time 8-12 seconds.
      </doc>
      <doc path="docs/architecture-web.md" title="Web Architecture" section="Vue 3 Patterns">
        Vue 3 Composition API, Pinia store patterns, DDD frontend layers (Presentation, Application, Infrastructure, Domain).
      </doc>
      <doc path="docs/epics.md" title="DailyUse Epics" section="Story 2.2">
        Story description: Generate Key Results UI with dialog, selection, and integration into Goal form.
      </doc>
    </docs>
    
    <code>
      <file path="apps/web/src/modules/goal/presentation/stores/goalStore.ts" kind="store" symbol="goalStore" reason="Pinia store for Goal state management - use addKeyResult() method to add generated KRs to Goal"/>
      <file path="apps/web/src/modules/goal/infrastructure/api/GoalApiClient.ts" kind="api-client" symbol="GoalApiClient" reason="HTTP client for Goal APIs - extend with generateKeyResults() method to call POST /api/ai/generate/key-results"/>
      <file path="apps/web/src/modules/goal/presentation/components/GoalForm.vue" kind="component" symbol="GoalForm" reason="Main Goal form component - add AI Generate button next to Key Results section"/>
      <file path="apps/web/src/composables/useMessage.ts" kind="composable" symbol="useMessage" reason="Message composable for snackbar notifications - use showError(), showSuccess() for feedback"/>
    </code>
    
    <dependencies>
      <package name="vue" version="^3.5" ecosystem="npm">Vue 3 Composition API (ref, computed, watch)</package>
      <package name="vuetify" version="^3.7" ecosystem="npm">Vuetify 3 components (v-dialog, v-list, v-checkbox, v-text-field, v-btn, v-alert, v-progress-circular)</package>
      <package name="pinia" version="^2.2" ecosystem="npm">State management (goalStore)</package>
      <package name="@vueuse/core" version="14.0.0" ecosystem="npm">Vue composition utilities</package>
      <package name="@dailyuse/contracts" version="workspace:*" ecosystem="pnpm-workspace">DTOs (GenerateKeyResultsRequest, GenerateKeyResultsResponse, KeyResultPreview)</package>
      <package name="@dailyuse/domain-client" version="workspace:*" ecosystem="pnpm-workspace">Client-side entities (KeyResultClient, Goal)</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">DDD Frontend: Presentation (Vue components), Application (Pinia stores), Infrastructure (API clients), Domain (Client entities)</constraint>
    <constraint type="ux">Loading indicator must appear immediately on button click, display during 8-12 second API call</constraint>
    <constraint type="ux">Error messages must be user-friendly (no technical jargon, provide actionable guidance)</constraint>
    <constraint type="validation">Client-side validation: goalTitle required before generation, startDate &lt; endDate</constraint>
    <constraint type="component">Dialog component must be reusable, accept props (goalTitle, goalDescription, dates), emit events (update:modelValue, keyResultsSelected)</constraint>
    <constraint type="error-handling">Handle all error types: 429 (quota exceeded + resetAt), 504 (timeout + retry), 400 (validation), 500 (generic)</constraint>
    <constraint type="accessibility">Dialog must be keyboard accessible, support ESC to close, focus trap during open</constraint>
  </constraints>

  <interfaces>
    <interface name="useAIGeneration.generateKeyResults()" kind="composable-method" signature="(request: GenerateKeyResultsRequest) =&gt; Promise&lt;GenerateKeyResultsResponse&gt;" path="apps/web/src/modules/goal/presentation/composables/useAIGeneration.ts"/>
    <interface name="GoalApiClient.generateKeyResults()" kind="api-method" signature="async generateKeyResults(request: GenerateKeyResultsRequest): Promise&lt;GenerateKeyResultsResponse&gt;" path="apps/web/src/modules/goal/infrastructure/api/GoalApiClient.ts"/>
    <interface name="goalStore.addKeyResult()" kind="store-action" signature="addKeyResult(keyResult: KeyResultClient): void" path="apps/web/src/modules/goal/presentation/stores/goalStore.ts"/>
    <interface name="KeyResultAIGenerationDialog" kind="vue-component" signature="props: { modelValue: boolean, goalTitle: string, goalDescription?: string, startDate: number, endDate: number }, emits: { 'update:modelValue': boolean, 'keyResultsSelected': KeyResultPreview[] }" path="apps/web/src/modules/goal/presentation/components/KeyResultAIGenerationDialog.vue"/>
    <interface name="useMessage.showError()" kind="composable-method" signature="(message: string, options?: MessageOptions) =&gt; void" path="apps/web/src/composables/useMessage.ts"/>
    <interface name="useMessage.showSuccess()" kind="composable-method" signature="(message: string) =&gt; void" path="apps/web/src/composables/useMessage.ts"/>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Vitest 3.2.4 + @vue/test-utils 2.4.6 + @testing-library/vue 8.1.0. Component tests: mount component, assert renders, simulate user interactions, mock API responses. E2E tests: Playwright 1.56.1 for full user journeys. Coverage target: ≥70% for new components and composables.
    </standards>
    <locations>
      <location>apps/web/src/modules/goal/presentation/components/__tests__/KeyResultAIGenerationDialog.test.ts</location>
      <location>apps/web/src/modules/goal/presentation/composables/__tests__/useAIGeneration.test.ts</location>
      <location>apps/web/e2e/goal/ai-generate-kr.spec.ts</location>
    </locations>
    <ideas>
      <idea criterion="AC-1">E2E: Navigate to Create Goal page → Assert button with text "AI Generate" visible</idea>
      <idea criterion="AC-2">Unit test: Click AI button → Assert dialog.visible = true</idea>
      <idea criterion="AC-3">Unit test: During API call → Assert v-progress-circular visible, text "Generating with AI..."</idea>
      <idea criterion="AC-4">Unit test: After API response → Assert 3-5 v-list-item elements with KR data</idea>
      <idea criterion="AC-5">Unit test: Click checkbox → Assert selected array updated</idea>
      <idea criterion="AC-6">Unit test: Edit title in v-text-field → Assert updatedKR.title changed</idea>
      <idea criterion="AC-7">Unit test: Click "Add Selected" → Assert goalStore.addKeyResult() called 3 times</idea>
      <idea criterion="AC-8">Unit test: After add → Assert dialog.visible = false, Goal form shows 3 new KRs</idea>
      <idea criterion="AC-9">Unit test: Mock 429 response → Assert snackbar displays "Daily quota exceeded"</idea>
      <idea criterion="AC-15">Unit test: Mock useAIGeneration composable → Assert generateKeyResults() called with correct params</idea>
      <idea criterion="AC-18">E2E: Full flow → Assert no console.error() calls</idea>
      <idea criterion="AC-19">CI: Run vitest → Assert all component tests pass</idea>
    </ideas>
  </tests>
</story-context>
