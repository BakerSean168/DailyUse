# STORY-020: ç½‘ç»œåŒæ­¥å±‚ - å®¢æˆ·ç«¯åŒæ­¥å¼•æ“

## ğŸ“‹ Story æ¦‚è¿°

**Story ID**: STORY-020  
**Epic**: EPIC-004 (Offline Sync - å¤šè®¾å¤‡æ•°æ®åŒæ­¥)  
**ä¼˜å…ˆçº§**: P3  
**é¢„ä¼°å·¥æ—¶**: 3-4 å¤©  
**çŠ¶æ€**: ğŸ“‹ Ready for Dev  
**å‰ç½®ä¾èµ–**: STORY-019 âœ… (åŒæ­¥åŸºç¡€è®¾æ–½)

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹

**ä½œä¸º** Desktop åº”ç”¨ç”¨æˆ·  
**æˆ‘å¸Œæœ›** åº”ç”¨èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€å¹¶åœ¨æ¢å¤ååŒæ­¥æ•°æ®  
**ä»¥ä¾¿äº** æˆ‘çš„æ•°æ®èƒ½å¤ŸåŠæ—¶ä¸äº‘ç«¯ä¿æŒä¸€è‡´

---

## ğŸ”§ æŠ€æœ¯èƒŒæ™¯

### åŒæ­¥å¼•æ“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç½‘ç»œåŒæ­¥å±‚æ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Network    â”‚â”€â”€online/offline eventâ”€â”€â”€â–ºâ”‚  Sync        â”‚      â”‚
â”‚  â”‚  Service    â”‚                          â”‚  Engine      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â–²                                         â”‚              â”‚
â”‚        â”‚ check                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚        â”‚                                â”‚        â”‚        â”‚     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                           â–¼        â–¼        â–¼     â”‚
â”‚   â”‚ Health  â”‚                        Push     Pull    Apply     â”‚
â”‚   â”‚ Check   â”‚                        Local   Remote   Remote    â”‚
â”‚   â”‚ (30s)   â”‚                        Changes Changes  Changes   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚        â”‚        â”‚     â”‚
â”‚                                         â–¼        â–¼        â–¼     â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                  â”‚     Sync Client          â”‚   â”‚
â”‚                                  â”‚   /sync/push             â”‚   â”‚
â”‚                                  â”‚   /sync/pull             â”‚   â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Retry Queue                           â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚   â”‚ 1s    â”‚  â”‚ 2s    â”‚  â”‚ 4s    â”‚  â”‚ 8s... â”‚ (æŒ‡æ•°é€€é¿) â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæ­¥æµç¨‹

```
1. æ£€æµ‹åˆ°æœ¬åœ°å˜æ›´
   â†“ (é˜²æŠ– 500ms)
2. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
   â”œâ”€â”€ ç¦»çº¿ â†’ æš‚å­˜åˆ° sync_log
   â””â”€â”€ åœ¨çº¿ â†’ ç»§ç»­
3. è·å–åŒæ­¥é”
4. Push æœ¬åœ°å˜æ›´
   â”œâ”€â”€ æˆåŠŸ â†’ æ ‡è®° synced
   â””â”€â”€ å†²çª â†’ äº¤ç»™å†²çªæœåŠ¡
5. Pull è¿œç¨‹å˜æ›´
6. åº”ç”¨è¿œç¨‹å˜æ›´
7. é‡Šæ”¾åŒæ­¥é”
```

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### AC-1: ç½‘ç»œçŠ¶æ€ç›‘æ§

- [ ] æ­£ç¡®æ£€æµ‹åœ¨çº¿/ç¦»çº¿çŠ¶æ€
- [ ] ç½‘ç»œæ–­å¼€æ—¶è§¦å‘ `offline` äº‹ä»¶
- [ ] ç½‘ç»œæ¢å¤æ—¶è§¦å‘ `online` äº‹ä»¶
- [ ] å®šæœŸå¥åº·æ£€æŸ¥é˜²æ­¢å‡åœ¨çº¿

### AC-2: åœ¨çº¿è‡ªåŠ¨åŒæ­¥

- [ ] å˜æ›´å 500ms è‡ªåŠ¨è§¦å‘åŒæ­¥
- [ ] åŒæ­¥è¿‡ç¨‹ä¸­ä¸é˜»å¡ UI
- [ ] åŒæ­¥æˆåŠŸåæ›´æ–°çŠ¶æ€æ 

### AC-3: ç¦»çº¿æš‚å­˜

- [ ] ç¦»çº¿æ—¶å˜æ›´æ­£å¸¸æš‚å­˜
- [ ] çŠ¶æ€æ æ˜¾ç¤ºå¾…åŒæ­¥æ•°é‡
- [ ] ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥

### AC-4: é‡è¯•æœºåˆ¶

- [ ] å¤±è´¥æ—¶æŒ‡æ•°é€€é¿é‡è¯•
- [ ] æœ€å¤§é‡è¯• 5 æ¬¡
- [ ] è¶…è¿‡é‡è¯•æ¬¡æ•°æ ‡è®°å¤±è´¥

---

## ğŸ“ Tasks/Subtasks

### Task 20.1: ç½‘ç»œçŠ¶æ€ç›‘æ§æœåŠ¡ [3h]

- [ ] 20.1.1 åˆ›å»º `NetworkService` ç±»
- [ ] 20.1.2 ç›‘å¬æµè§ˆå™¨ online/offline äº‹ä»¶
- [ ] 20.1.3 å®ç°å®šæœŸå¥åº·æ£€æŸ¥ (30s)
- [ ] 20.1.4 è§¦å‘ online/offline äº‹ä»¶

**å®ç°å‚è€ƒ:**

```typescript
// services/network.service.ts
export class NetworkService extends EventEmitter {
  private isOnline: boolean;
  private checkInterval: NodeJS.Timer | null = null;
  
  constructor(private syncServerUrl: string) {
    super();
    this.isOnline = navigator.onLine;
    this.setupListeners();
  }
  
  private setupListeners(): void {
    window.addEventListener('online', () => this.setOnline(true));
    window.addEventListener('offline', () => this.setOnline(false));
    
    // å®šæœŸæ£€æµ‹ (é˜²æ­¢å‡åœ¨çº¿)
    this.checkInterval = setInterval(() => this.checkConnection(), 30000);
  }
  
  private async checkConnection(): Promise<void> {
    try {
      const response = await fetch(`${this.syncServerUrl}/health`, {
        method: 'HEAD',
        cache: 'no-cache',
      });
      this.setOnline(response.ok);
    } catch {
      this.setOnline(false);
    }
  }
  
  getStatus(): boolean { return this.isOnline; }
}
```

### Task 20.2: åŒæ­¥å®¢æˆ·ç«¯æœåŠ¡ [4h]

- [ ] 20.2.1 åˆ›å»º `SyncClientService` ç±»
- [ ] 20.2.2 å®ç° `pushChanges()` - æ¨é€æœ¬åœ°å˜æ›´
- [ ] 20.2.3 å®ç° `pullChanges()` - æ‹‰å–è¿œç¨‹å˜æ›´
- [ ] 20.2.4 å¤„ç†è®¤è¯ token
- [ ] 20.2.5 é”™è¯¯å¤„ç†ä¸ç±»å‹å®šä¹‰

**API æ¥å£:**

```typescript
// POST /sync/push
interface SyncPushPayload {
  deviceId: string;
  changes: SyncLogEntry[];
  lastSyncVersion: number;
}

interface SyncPushResult {
  accepted: string[];      // å·²æ¥å—çš„äº‹ä»¶ ID
  conflicts: ConflictInfo[];
  newVersion: number;
}

// POST /sync/pull
interface SyncPullPayload {
  deviceId: string;
  lastSyncVersion: number;
}

interface SyncPullResponse {
  changes: RemoteChange[];
  currentVersion: number;
  hasMore: boolean;
}
```

### Task 20.3: åŒæ­¥å¼•æ“æœåŠ¡ [6h]

- [ ] 20.3.1 åˆ›å»º `SyncEngine` ç±»
- [ ] 20.3.2 å®ç° `sync()` ä¸»åŒæ­¥æ–¹æ³•
- [ ] 20.3.3 å®ç° `pushLocalChanges()` - æ¨é€æµç¨‹
- [ ] 20.3.4 å®ç° `pullRemoteChanges()` - æ‹‰å–æµç¨‹
- [ ] 20.3.5 å®ç° `applyRemoteChanges()` - åº”ç”¨è¿œç¨‹å˜æ›´
- [ ] 20.3.6 ç½‘ç»œæ¢å¤è‡ªåŠ¨è§¦å‘
- [ ] 20.3.7 é˜²æŠ–å¤„ç† (500ms)

**å®ç°å‚è€ƒ:**

```typescript
// services/sync-engine.service.ts
export class SyncEngine {
  private isSyncing = false;
  private debounceTimer: NodeJS.Timer | null = null;
  
  constructor(
    private syncLogService: SyncLogService,
    private syncClient: SyncClientService,
    private conflictService: ConflictService,
    private networkService: NetworkService
  ) {
    // ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥
    this.networkService.on('online', () => this.sync());
  }
  
  /**
   * è§¦å‘åŒæ­¥ (å¸¦é˜²æŠ–)
   */
  triggerSync(): void {
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }
    this.debounceTimer = setTimeout(() => this.sync(), 500);
  }
  
  /**
   * æ‰§è¡Œå®Œæ•´åŒæ­¥
   */
  async sync(): Promise<SyncResult> {
    if (this.isSyncing) return { status: 'already-syncing' };
    if (!this.networkService.getStatus()) return { status: 'offline' };
    
    this.isSyncing = true;
    
    try {
      await this.pushLocalChanges();
      await this.pullRemoteChanges();
      return { status: 'success' };
    } catch (error) {
      return { status: 'error', error };
    } finally {
      this.isSyncing = false;
    }
  }
}
```

### Task 20.4: é‡è¯•é˜Ÿåˆ—æœåŠ¡ [3h]

- [ ] 20.4.1 åˆ›å»º `RetryQueueService` ç±»
- [ ] 20.4.2 å®ç°æŒ‡æ•°é€€é¿ç®—æ³•
- [ ] 20.4.3 å®ç°æœ€å¤§é‡è¯•é™åˆ¶ (5æ¬¡)
- [ ] 20.4.4 è¶…è¿‡é™åˆ¶æ ‡è®°å¤±è´¥

**é‡è¯•ç­–ç•¥:**

| é‡è¯•æ¬¡æ•° | å»¶è¿Ÿæ—¶é—´ |
|---------|---------|
| 1 | 1s |
| 2 | 2s |
| 3 | 4s |
| 4 | 8s |
| 5 | 16s |
| >5 | æ ‡è®°å¤±è´¥ |

### Task 20.5: ç¼–å†™å•å…ƒæµ‹è¯• [4h]

- [ ] 20.5.1 NetworkService æµ‹è¯•
- [ ] 20.5.2 SyncClientService æµ‹è¯•
- [ ] 20.5.3 SyncEngine æµ‹è¯•
- [ ] 20.5.4 RetryQueueService æµ‹è¯•

### Task 20.6: é›†æˆä¸çŠ¶æ€æ  [2h]

- [ ] 20.6.1 é›†æˆåˆ° DI å®¹å™¨
- [ ] 20.6.2 å®ç°çŠ¶æ€æ åŒæ­¥æŒ‡ç¤ºå™¨
- [ ] 20.6.3 æ˜¾ç¤ºå¾…åŒæ­¥æ•°é‡

---

## ğŸ“ Dev Notes

### æŠ€æœ¯è§„èŒƒ

1. **é˜²æŠ–é…ç½®**
   - å˜æ›´åç­‰å¾… 500ms å†è§¦å‘åŒæ­¥
   - é¿å…é¢‘ç¹åŒæ­¥è¯·æ±‚

2. **å¥åº·æ£€æŸ¥**
   - æ¯ 30s æ£€æŸ¥ä¸€æ¬¡æœåŠ¡ç«¯è¿é€šæ€§
   - ä½¿ç”¨ HEAD è¯·æ±‚å‡å°‘å¸¦å®½

3. **é”™è¯¯å¤„ç†**
   - ç½‘ç»œé”™è¯¯è§¦å‘é‡è¯•é˜Ÿåˆ—
   - ä¸šåŠ¡é”™è¯¯ (å¦‚è®¤è¯å¤±è´¥) ä¸é‡è¯•

### ç›¸å…³æ–‡ä»¶ä½ç½®

```
apps/desktop/src/main/services/
â”œâ”€â”€ network.service.ts         # Task 20.1
â”œâ”€â”€ sync-client.service.ts     # Task 20.2
â”œâ”€â”€ sync-engine.service.ts     # Task 20.3
â””â”€â”€ retry-queue.service.ts     # Task 20.4

apps/desktop/src/renderer/components/
â””â”€â”€ SyncStatusIndicator.vue    # Task 20.6
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 20.1: åœ¨çº¿è‡ªåŠ¨åŒæ­¥

```
å‰ç½®æ¡ä»¶ï¼š
  - ç½‘ç»œæ­£å¸¸è¿æ¥
  - ç”¨æˆ·å·²ç™»å½•
  
æ­¥éª¤ï¼š
  1. åˆ›å»ºä¸€ä¸ªæ–°ç›®æ ‡
  2. ç­‰å¾… 500ms (é˜²æŠ–æ—¶é—´)
  3. æ£€æŸ¥ sync_log çŠ¶æ€
  
é¢„æœŸç»“æœï¼š
  - sync_log ä¸­è¯¥è®°å½•çš„ synced = 1
  - æœåŠ¡ç«¯æœ‰å¯¹åº”çš„åŒæ­¥äº‹ä»¶
```

### åœºæ™¯ 20.2: ç¦»çº¿å˜æ›´æš‚å­˜

```
å‰ç½®æ¡ä»¶ï¼š
  - ç½‘ç»œæ–­å¼€ (é£è¡Œæ¨¡å¼)
  
æ­¥éª¤ï¼š
  1. åˆ›å»º 3 ä¸ªæ–°ç›®æ ‡
  2. ä¿®æ”¹ 1 ä¸ªç›®æ ‡
  3. æ£€æŸ¥ sync_log çŠ¶æ€
  4. æ£€æŸ¥çŠ¶æ€æ æ˜¾ç¤º
  
é¢„æœŸç»“æœï¼š
  - sync_log æœ‰ 4 æ¡ synced = 0 çš„è®°å½•
  - çŠ¶æ€æ æ˜¾ç¤ºã€Œç¦»çº¿æ¨¡å¼ - 4 ä¸ªå˜æ›´å¾…åŒæ­¥ã€
```

### åœºæ™¯ 20.3: ç½‘ç»œæ¢å¤è‡ªåŠ¨åŒæ­¥

```
å‰ç½®æ¡ä»¶ï¼š
  - åœºæ™¯ 20.2 å®Œæˆå
  - æœ‰ 4 ä¸ªå¾…åŒæ­¥å˜æ›´
  
æ­¥éª¤ï¼š
  1. æ¢å¤ç½‘ç»œè¿æ¥
  2. ç­‰å¾… 5 ç§’
  3. æ£€æŸ¥ sync_log çŠ¶æ€
  4. æ£€æŸ¥çŠ¶æ€æ æ˜¾ç¤º
  
é¢„æœŸç»“æœï¼š
  - æ‰€æœ‰ sync_log è®°å½•çš„ synced = 1
  - çŠ¶æ€æ æ˜¾ç¤ºã€Œå·²åŒæ­¥ âœ“ã€
  - æ”¶åˆ°é€šçŸ¥ã€Œ4 ä¸ªå˜æ›´å·²åŒæ­¥åˆ°äº‘ç«¯ã€
```

### åœºæ™¯ 20.4: é‡è¯•æŒ‡æ•°é€€é¿

```
å‰ç½®æ¡ä»¶ï¼š
  - æœåŠ¡ç«¯è¿”å› 500 é”™è¯¯
  
æ­¥éª¤ï¼š
  1. åˆ›å»ºä¸€ä¸ªæ–°ç›®æ ‡
  2. è§‚å¯Ÿé‡è¯•è¡Œä¸º
  3. è®°å½•æ¯æ¬¡é‡è¯•çš„æ—¶é—´é—´éš”
  
é¢„æœŸç»“æœï¼š
  - ç¬¬ 1 æ¬¡é‡è¯•ï¼š~1s å
  - ç¬¬ 2 æ¬¡é‡è¯•ï¼š~2s å
  - ç¬¬ 3 æ¬¡é‡è¯•ï¼š~4s å
  - ç¬¬ 4 æ¬¡é‡è¯•ï¼š~8s å
  - ç¬¬ 5 æ¬¡é‡è¯•å¤±è´¥åï¼Œè®°å½•åˆ°é—®é¢˜åˆ—è¡¨
```

---

## ğŸ“ File List

> å®ç°è¿‡ç¨‹ä¸­åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

*å¼€å‘è¿‡ç¨‹ä¸­æ›´æ–°*

---

## ğŸ“ Change Log

| æ—¥æœŸ | å˜æ›´ | ä½œè€… |
|------|------|------|
| 2025-12-07 | Story åˆ›å»º | AI |

---

## ğŸ¤– Dev Agent Record

### Debug Log

*å¼€å‘è¿‡ç¨‹ä¸­çš„è°ƒè¯•è®°å½•*

### Completion Notes

*å®Œæˆæ—¶çš„å¤‡æ³¨*
