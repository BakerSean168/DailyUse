# STORY-021: å†²çªæ£€æµ‹ä¸è§£å†³

## ğŸ“‹ Story æ¦‚è¿°

**Story ID**: STORY-021  
**Epic**: EPIC-004 (Offline Sync - å¤šè®¾å¤‡æ•°æ®åŒæ­¥)  
**ä¼˜å…ˆçº§**: P3  
**é¢„ä¼°å·¥æ—¶**: 4-5 å¤©  
**çŠ¶æ€**: âœ… Completed  
**å®Œæˆæ—¥æœŸ**: 2025-12-08  
**å‰ç½®ä¾èµ–**: STORY-019 âœ…, STORY-020 (ç½‘ç»œåŒæ­¥å±‚)

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹

**ä½œä¸º** å¤šè®¾å¤‡ç”¨æˆ·  
**æˆ‘å¸Œæœ›** å½“ä¸åŒè®¾å¤‡ä¸Šçš„ä¿®æ”¹äº§ç”Ÿå†²çªæ—¶èƒ½å¤Ÿæ¸…æ™°åœ°çœ‹åˆ°å¹¶è§£å†³  
**ä»¥ä¾¿äº** æˆ‘ä¸ä¼šä¸¢å¤±ä»»ä½•é‡è¦çš„ä¿®æ”¹

---

## ğŸ”§ æŠ€æœ¯èƒŒæ™¯

### å†²çªåœºæ™¯ç¤ºä¾‹

```
è®¾å¤‡ A (ç¦»çº¿)              è®¾å¤‡ B (åœ¨çº¿)              æœåŠ¡ç«¯
    â”‚                         â”‚                        â”‚
    â”‚  ä¿®æ”¹æ ‡é¢˜ä¸ºã€ŒAç‰ˆæœ¬ã€      â”‚                        â”‚
    â”‚  (base_version=1)       â”‚                        â”‚
    â”‚                         â”‚  ä¿®æ”¹æ ‡é¢˜ä¸ºã€ŒBç‰ˆæœ¬ã€     â”‚
    â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
    â”‚                         â”‚                        â”‚  version=2
    â”‚                         â”‚                        â”‚
    â”‚  æ¢å¤ç½‘ç»œï¼Œå°è¯•åŒæ­¥       â”‚                        â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
    â”‚                         â”‚                        â”‚  æ£€æµ‹åˆ°å†²çª!
    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  base_version(1) < version(2)
    â”‚  è¿”å›å†²çªä¿¡æ¯            â”‚                        â”‚
    â”‚                         â”‚                        â”‚
    â”‚  æ˜¾ç¤ºå†²çªè§£å†³å¯¹è¯æ¡†       â”‚                        â”‚
    â”‚                         â”‚                        â”‚
```

### å†²çªè§£å†³ç­–ç•¥

| å®ä½“ç±»å‹ | å­—æ®µ | ç­–ç•¥ | è¯´æ˜ |
|----------|------|------|------|
| Goal | title | ç”¨æˆ·é€‰æ‹© | æ ‡é¢˜å†²çªéœ€è¦ç”¨æˆ·å†³å®š |
| Goal | progress | å–è¾ƒå¤§å€¼ | è¿›åº¦åªå¢ä¸å‡ |
| Goal | status | ä¼˜å…ˆçº§åˆå¹¶ | completed > active > paused |
| Task | title | ç”¨æˆ·é€‰æ‹© | |
| Task | status | å·²å®Œæˆä¼˜å…ˆ | ä»»ä¸€å®Œæˆå³å®Œæˆ |
| Task | dueDate | å–è¾ƒæ—© | æ›´ç´§è¿«çš„ä¼˜å…ˆ |
| Reminder | time | ç”¨æˆ·é€‰æ‹© | æ—¶é—´æ•æ„Ÿ |
| Setting | * | åå†™å…¥ä¼˜å…ˆ | é…ç½®é¡¹ç®€å•è¦†ç›– |

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### AC-1: å†²çªæ£€æµ‹

- [ ] æ­£ç¡®æ£€æµ‹ç‰ˆæœ¬å·å†²çª
- [ ] è¯†åˆ«å†²çªçš„å…·ä½“å­—æ®µ
- [ ] éå†²çªå­—æ®µå¯è‡ªåŠ¨åˆå¹¶

### AC-2: è‡ªåŠ¨è§£å†³

- [ ] progress å­—æ®µå–è¾ƒå¤§å€¼
- [ ] status å­—æ®µæŒ‰ä¼˜å…ˆçº§åˆå¹¶
- [ ] dueDate å­—æ®µå–è¾ƒæ—©å€¼
- [ ] è‡ªåŠ¨è§£å†³åä¸æç¤ºç”¨æˆ·

### AC-3: æ‰‹åŠ¨è§£å†³

- [ ] å†²çªæ—¶æ˜¾ç¤ºè§£å†³å¯¹è¯æ¡†
- [ ] æ”¯æŒé€‰æ‹©æœ¬åœ°/è¿œç¨‹ç‰ˆæœ¬
- [ ] æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘åˆå¹¶
- [ ] è§£å†³åæ­£ç¡®åŒæ­¥

### AC-4: å†²çªå†å²

- [ ] è®°å½•æ‰€æœ‰å†²çªåŠè§£å†³æ–¹æ¡ˆ
- [ ] å¯æŸ¥çœ‹å†å²å†²çª
- [ ] æ”¯æŒæŒ‰å®ä½“ç±»å‹ç­›é€‰

---

## ğŸ“ Tasks/Subtasks

### Task 21.1: å†²çªæ£€æµ‹æœåŠ¡ [4h]

- [ ] 21.1.1 åˆ›å»º `ConflictDetectionService` ç±»
- [ ] 21.1.2 å®ç°ç‰ˆæœ¬å·æ¯”è¾ƒé€»è¾‘
- [ ] 21.1.3 å®ç°å­—æ®µçº§å·®å¼‚æ£€æµ‹
- [ ] 21.1.4 åˆ¤æ–­æ˜¯å¦å¯è‡ªåŠ¨åˆå¹¶

**å®ç°å‚è€ƒ:**

```typescript
// services/conflict-detection.service.ts
export interface ConflictInfo {
  entityType: EntityType;
  entityId: string;
  localVersion: VersionedEntity;
  remoteVersion: VersionedEntity;
  conflictingFields: string[];
}

export class ConflictDetectionService {
  detectConflict(
    local: VersionedEntity,
    remote: VersionedEntity
  ): ConflictInfo | null {
    // ç‰ˆæœ¬å·ç›¸åŒæˆ–æœ¬åœ°æ›´æ–°ï¼Œæ— å†²çª
    if (local.version >= remote.version) return null;
    
    // æ£€æµ‹å­—æ®µçº§å†²çª
    const conflictingFields = this.findConflictingFields(local, remote);
    
    if (conflictingFields.length === 0) return null;
    
    return {
      entityType: local.entityType,
      entityId: local.id,
      localVersion: local,
      remoteVersion: remote,
      conflictingFields,
    };
  }
}
```

### Task 21.2: å†²çªè®°å½•æœåŠ¡ [3h]

- [ ] 21.2.1 åˆ›å»º `ConflictRecordService` ç±»
- [ ] 21.2.2 å®ç° `createConflict()` - ä¿å­˜å†²çªè®°å½•
- [ ] 21.2.3 å®ç° `getUnresolvedConflicts()` - è·å–æœªè§£å†³å†²çª
- [ ] 21.2.4 å®ç° `resolveConflict()` - æ ‡è®°å·²è§£å†³
- [ ] 21.2.5 å®ç° `getConflictHistory()` - æŸ¥è¯¢å†å²

**æ•°æ®ç»“æ„:**

```typescript
interface ConflictRecord {
  id: string;
  entityType: EntityType;
  entityId: string;
  localVersion: string;          // JSON
  remoteVersion: string;         // JSON
  resolvedVersion: string | null;
  resolutionStrategy: 'local' | 'remote' | 'merge' | 'manual' | null;
  resolvedAt: number | null;
  resolvedBy: string | null;     // deviceId
  createdAt: number;
}
```

### Task 21.3: å†²çªè§£å†³å™¨æœåŠ¡ [6h]

- [ ] 21.3.1 åˆ›å»º `ConflictResolverService` ç±»
- [ ] 21.3.2 å®ç° `tryAutoResolve()` - å°è¯•è‡ªåŠ¨è§£å†³
- [ ] 21.3.3 å®ç° `getFieldAutoStrategy()` - è·å–å­—æ®µç­–ç•¥
- [ ] 21.3.4 å®ç° `mergeField()` - å­—æ®µåˆå¹¶é€»è¾‘
- [ ] 21.3.5 å®ç° `resolveManually()` - æ‰‹åŠ¨è§£å†³
- [ ] 21.3.6 è§£å†³åè§¦å‘åŒæ­¥

**åˆå¹¶ç­–ç•¥å®ç°:**

```typescript
// åˆå¹¶ç­–ç•¥é…ç½®
const strategies: Record<string, Record<string, ResolutionStrategy>> = {
  goal: {
    title: 'manual',
    description: 'manual',
    progress: 'merge',   // Math.max
    status: 'merge',     // ä¼˜å…ˆçº§
    updatedAt: 'remote',
  },
  task: {
    title: 'manual',
    status: 'merge',     // completed ä¼˜å…ˆ
    dueDate: 'merge',    // Math.min
    updatedAt: 'remote',
  },
  reminder: {
    time: 'manual',
    message: 'manual',
    enabled: 'merge',    // OR
  },
  setting: {
    '*': 'remote',       // åå†™å…¥ä¼˜å…ˆ
  },
};
```

### Task 21.4: å†²çªå†å²æœåŠ¡ [2h]

- [ ] 21.4.1 åˆ›å»º `ConflictHistoryService` ç±»
- [ ] 21.4.2 å®ç° `getFormattedHistory()` - æ ¼å¼åŒ–å†å²
- [ ] 21.4.3 æ”¯æŒæŒ‰ç±»å‹ç­›é€‰
- [ ] 21.4.4 æ”¯æŒåˆ†é¡µ

### Task 21.5: å†²çªè§£å†³ UI [4h]

- [ ] 21.5.1 åˆ›å»º `ConflictResolutionDialog` ç»„ä»¶
- [ ] 21.5.2 æ˜¾ç¤ºæœ¬åœ°/è¿œç¨‹ç‰ˆæœ¬å¯¹æ¯”
- [ ] 21.5.3 é«˜äº®å†²çªå­—æ®µ
- [ ] 21.5.4 æ”¯æŒé€‰æ‹©æˆ–ç¼–è¾‘
- [ ] 21.5.5 ç¡®è®¤æŒ‰é’®è§¦å‘è§£å†³

**UI è®¾è®¡:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ æ•°æ®å†²çª                                       [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ç›®æ ‡ã€Œå­¦ä¹  TypeScriptã€å­˜åœ¨å†²çª                         â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   æœ¬åœ°ç‰ˆæœ¬       â”‚    â”‚   äº‘ç«¯ç‰ˆæœ¬       â”‚            â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚            â”‚
â”‚  â”‚ æ ‡é¢˜: å­¦ä¹  TS v1â”‚    â”‚ æ ‡é¢˜: å­¦ä¹  TS æœ€ç»ˆâ”‚            â”‚
â”‚  â”‚ ^^^^^^^^^^^^^^^ â”‚    â”‚ ^^^^^^^^^^^^^^^^^â”‚  â† å†²çª   â”‚
â”‚  â”‚ è¿›åº¦: 70%       â”‚    â”‚ è¿›åº¦: 60%        â”‚            â”‚
â”‚  â”‚ çŠ¶æ€: active    â”‚    â”‚ çŠ¶æ€: active     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                         â”‚
â”‚  â—‹ ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬                                         â”‚
â”‚  â—‹ ä½¿ç”¨äº‘ç«¯ç‰ˆæœ¬                                         â”‚
â”‚  â—‹ æ‰‹åŠ¨åˆå¹¶                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚ æ ‡é¢˜: å­¦ä¹  TypeScript - æœ€ç»ˆç‰ˆ       â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                         â”‚
â”‚                    [å–æ¶ˆ]  [ç¡®è®¤è§£å†³]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Task 21.6: ç¼–å†™æµ‹è¯• [4h]

- [ ] 21.6.1 å†²çªæ£€æµ‹æµ‹è¯•
- [ ] 21.6.2 è‡ªåŠ¨åˆå¹¶ç­–ç•¥æµ‹è¯•
- [ ] 21.6.3 æ‰‹åŠ¨è§£å†³æµ‹è¯•
- [ ] 21.6.4 å†²çªå†å²æµ‹è¯•

---

## ğŸ“ Dev Notes

### æŠ€æœ¯è§„èŒƒ

1. **å†²çªæ£€æµ‹æ—¶æœº**
   - Pull è¿œç¨‹å˜æ›´æ—¶æ£€æµ‹
   - Push è¿”å›å†²çªæ—¶å¤„ç†

2. **è‡ªåŠ¨åˆå¹¶æ¡ä»¶**
   - æ‰€æœ‰å†²çªå­—æ®µéƒ½æœ‰è‡ªåŠ¨ç­–ç•¥
   - ç­–ç•¥ä¸ä¸º 'manual'

3. **å†²çªé€šçŸ¥æ–¹å¼** (æ ¹æ®ç”¨æˆ·è®¾ç½®)
   - `immediate`: ç«‹å³å¼¹å‡ºå¯¹è¯æ¡†
   - `taskbar`: ä»»åŠ¡æ é€šçŸ¥ï¼Œç‚¹å‡»åå¤„ç†
   - `on-open`: ä¸‹æ¬¡æ‰“å¼€åº”ç”¨æ—¶æç¤º

### ç›¸å…³æ–‡ä»¶ä½ç½®

```
apps/desktop/src/main/services/
â”œâ”€â”€ conflict-detection.service.ts   # Task 21.1
â”œâ”€â”€ conflict-record.service.ts      # Task 21.2
â”œâ”€â”€ conflict-resolver.service.ts    # Task 21.3
â””â”€â”€ conflict-history.service.ts     # Task 21.4

apps/desktop/src/renderer/components/
â””â”€â”€ ConflictResolutionDialog.vue    # Task 21.5
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 21.1: ç‰ˆæœ¬å†²çªæ£€æµ‹

```
å‰ç½®æ¡ä»¶ï¼š
  - è®¾å¤‡ A å’Œè®¾å¤‡ B éƒ½æœ‰åŒä¸€ç›®æ ‡ (version = 1)
  - è®¾å¤‡ A ç¦»çº¿
  
æ­¥éª¤ï¼š
  1. è®¾å¤‡ A (ç¦»çº¿) ä¿®æ”¹ç›®æ ‡æ ‡é¢˜ä¸ºã€Œæ ‡é¢˜ Aã€
  2. è®¾å¤‡ B (åœ¨çº¿) ä¿®æ”¹ç›®æ ‡æ ‡é¢˜ä¸ºã€Œæ ‡é¢˜ Bã€ï¼ŒåŒæ­¥æˆåŠŸ (version = 2)
  3. è®¾å¤‡ A æ¢å¤ç½‘ç»œï¼Œå°è¯•åŒæ­¥
  
é¢„æœŸç»“æœï¼š
  - æ£€æµ‹åˆ°ç‰ˆæœ¬å†²çª (æœ¬åœ° baseVersion=1, æœåŠ¡ç«¯ version=2)
  - ç”Ÿæˆå†²çªè®°å½•
  - åŒæ­¥çŠ¶æ€å˜ä¸º conflict
```

### åœºæ™¯ 21.2: è‡ªåŠ¨åˆå¹¶ - è¿›åº¦å­—æ®µ

```
å‰ç½®æ¡ä»¶ï¼š
  - åŒä¸€ç›®æ ‡åœ¨ä¸¤å°è®¾å¤‡ä¸Š
  
æ­¥éª¤ï¼š
  1. è®¾å¤‡ A (ç¦»çº¿) å°†è¿›åº¦ä» 50% æ”¹ä¸º 70%
  2. è®¾å¤‡ B (åœ¨çº¿) å°†è¿›åº¦ä» 50% æ”¹ä¸º 60%
  3. è®¾å¤‡ A æ¢å¤ç½‘ç»œ
  
é¢„æœŸç»“æœï¼š
  - è‡ªåŠ¨åˆå¹¶ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
  - æœ€ç»ˆè¿›åº¦ = max(70%, 60%) = 70%
```

### åœºæ™¯ 21.3: æ‰‹åŠ¨è§£å†³ - æ ‡é¢˜å†²çª

```
å‰ç½®æ¡ä»¶ï¼š
  - åœºæ™¯ 21.1 çš„å†²çªçŠ¶æ€
  
æ­¥éª¤ï¼š
  1. å¼¹å‡ºå†²çªè§£å†³å¯¹è¯æ¡†
  2. ç”¨æˆ·é€‰æ‹©ã€Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬ã€
  3. ç‚¹å‡»ç¡®è®¤
  
é¢„æœŸç»“æœï¼š
  - ç›®æ ‡æ ‡é¢˜æ›´æ–°ä¸ºã€Œæ ‡é¢˜ Aã€
  - å†²çªè®°å½•æ›´æ–°ï¼šresolutionStrategy = 'local'
  - ç”Ÿæˆæ–°çš„åŒæ­¥äº‹ä»¶
```

### åœºæ™¯ 21.4: å†²çªå†å²æŸ¥è¯¢

```
å‰ç½®æ¡ä»¶ï¼š
  - å·²è§£å†³è¿‡ 3 ä¸ªå†²çª
  
æ­¥éª¤ï¼š
  1. æ‰“å¼€è®¾ç½® â†’ åŒæ­¥å†å²
  2. æŸ¥çœ‹å†²çªåˆ—è¡¨
  3. æŒ‰ç±»å‹ç­›é€‰ã€Œç›®æ ‡ã€
  
é¢„æœŸç»“æœï¼š
  - æ˜¾ç¤ºæ‰€æœ‰å·²è§£å†³çš„å†²çª
  - æ¯æ¡è®°å½•æ˜¾ç¤ºï¼šå®ä½“åç§°ã€å†²çªå­—æ®µã€è§£å†³ç­–ç•¥ã€è§£å†³æ—¶é—´
  - ç­›é€‰ååªæ˜¾ç¤ºç›®æ ‡ç±»å‹çš„å†²çª
```

---

## ğŸ“ File List

> å®ç°è¿‡ç¨‹ä¸­åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

*å¼€å‘è¿‡ç¨‹ä¸­æ›´æ–°*

---

## ğŸ“ Change Log

| æ—¥æœŸ | å˜æ›´ | ä½œè€… |
|------|------|------|
| 2025-12-07 | Story åˆ›å»º | AI |

---

## ğŸ¤– Dev Agent Record

### Debug Log

*å¼€å‘è¿‡ç¨‹ä¸­çš„è°ƒè¯•è®°å½•*

### Completion Notes

*å®Œæˆæ—¶çš„å¤‡æ³¨*
