# STORY-041: ä¹ æƒ¯æé†’ç³»ç»Ÿ

## ğŸ“‹ Story æ¦‚è¿°

**Story ID**: STORY-041  
**Epic**: EPIC-008 (Habit Tracking)  
**ä¼˜å…ˆçº§**: P1 (æ ¸å¿ƒä»·å€¼)  
**é¢„ä¼°å·¥æ—¶**: 2 å¤©  
**çŠ¶æ€**: ğŸ“‹ Ready for Dev  
**å‰ç½®ä¾èµ–**: STORY-038 âœ… (Habit Check-in & Streak)

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹

**ä½œä¸º** DailyUse ç”¨æˆ·  
**æˆ‘å¸Œæœ›** ç³»ç»Ÿèƒ½åœ¨åˆé€‚çš„æ—¶é—´æé†’æˆ‘å®Œæˆä¹ æƒ¯  
**ä»¥ä¾¿äº** ä¸é”™è¿‡ä¹ æƒ¯æ‰“å¡ï¼Œä¿æŒä¹ æƒ¯è¿ç»­æ€§

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶ - å›ºå®šæ—¶é—´æé†’

- [ ] è®¾ç½®æ¯æ—¥å›ºå®šæ—¶é—´æé†’ï¼ˆå¦‚æ¯å¤© 7:00 æ™¨è·‘ï¼‰
- [ ] æ”¯æŒå¤šä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚æ—©ä¸­æ™šå¤šæ¬¡æé†’ï¼‰
- [ ] æ”¯æŒé‡å¤æ¨¡å¼ï¼ˆæ¯å¤©/å·¥ä½œæ—¥/å‘¨æœ«/è‡ªå®šä¹‰ï¼‰
- [ ] æ”¯æŒæå‰æé†’ï¼ˆå¦‚æå‰ 5 åˆ†é’Ÿï¼‰
- [ ] æé†’æ–¹å¼ï¼šç³»ç»Ÿé€šçŸ¥ + åº”ç”¨å†…å¼¹çª—

### åŠŸèƒ½éªŒæ”¶ - æ™ºèƒ½æ—¶é—´å»ºè®®

- [ ] åŸºäºå†å²æ‰“å¡æ—¶é—´æ¨èæœ€ä½³æé†’æ—¶é—´
- [ ] åˆ†æç”¨æˆ·æ´»è·ƒæ—¶æ®µï¼Œé¿å¼€å¿™ç¢Œæ—¶é—´
- [ ] è€ƒè™‘ä¹ æƒ¯ç±»å‹è‡ªåŠ¨å»ºè®®æ—¶é—´ï¼ˆå¦‚æ™¨è·‘å»ºè®®æ—©ä¸Š6-8ç‚¹ï¼‰
- [ ] å­¦ä¹ ç”¨æˆ·å»¶è¿Ÿæ‰“å¡ä¹ æƒ¯ï¼ŒåŠ¨æ€è°ƒæ•´æ—¶é—´

### åŠŸèƒ½éªŒæ”¶ - ä½ç½®æé†’ï¼ˆæœªæ¥ç§»åŠ¨ç«¯ï¼‰

- [ ] åˆ°è¾¾æŒ‡å®šåœ°ç‚¹è§¦å‘æé†’ï¼ˆå¦‚åˆ°å¥èº«æˆ¿æé†’å¥èº«ï¼‰
- [ ] ç¦»å¼€åœ°ç‚¹æé†’ï¼ˆå¦‚ç¦»å¼€åŠå…¬å®¤æé†’å…³ç¯ï¼‰
- [ ] åœ°ç†å›´æ è®¾ç½®
- [ ] å°Šé‡ç”¨æˆ·éšç§ï¼Œå¯é€‰åŠŸèƒ½

### åŠŸèƒ½éªŒæ”¶ - ä¹ æƒ¯é“¾æé†’

- [ ] è¯†åˆ«ä¹ æƒ¯é“¾ï¼ˆAå®Œæˆåæé†’Bï¼‰
- [ ] è‡ªåŠ¨å»ºè®®ä¹ æƒ¯é¡ºåº
- [ ] å®Œæˆå‰ç½®ä¹ æƒ¯åç«‹å³æé†’åç»­ä¹ æƒ¯
- [ ] ä¹ æƒ¯é“¾å®Œæˆç»™äºˆé¢å¤–å¥–åŠ±

### åŠŸèƒ½éªŒæ”¶ - æé†’ç®¡ç†

- [ ] å…¨å±€å¼€å…³ï¼šä¸€é”®æš‚åœæ‰€æœ‰æé†’
- [ ] å•ä¸ªä¹ æƒ¯å¼€å…³ï¼šç‹¬ç«‹æ§åˆ¶æ¯ä¸ªä¹ æƒ¯æé†’
- [ ] å…æ‰“æ‰°æ—¶æ®µï¼šè®¾ç½®å‹¿æ‰°æ—¶é—´ï¼ˆå¦‚åˆä¼‘ã€ä¼šè®®ï¼‰
- [ ] ä¸´æ—¶å»¶è¿Ÿï¼šå»¶è¿Ÿ 10/30/60 åˆ†é’Ÿ
- [ ] æé†’å†å²ï¼šæŸ¥çœ‹è¿‡å»çš„æé†’è®°å½•å’Œå“åº”æƒ…å†µ

### åŠŸèƒ½éªŒæ”¶ - æé†’æ ·å¼

- [ ] ç³»ç»Ÿé€šçŸ¥æ˜¾ç¤ºä¹ æƒ¯åç§°ã€å›¾æ ‡ã€Streakä¿¡æ¯
- [ ] é€šçŸ¥æ“ä½œï¼šç«‹å³æ‰“å¡/å»¶è¿Ÿ/è·³è¿‡
- [ ] åº”ç”¨å†…å¼¹çª—æ”¯æŒå¿«é€Ÿæ‰“å¡
- [ ] å£°éŸ³æé†’ï¼ˆå¯è‡ªå®šä¹‰é“ƒå£°ï¼‰
- [ ] éœ‡åŠ¨æé†’ï¼ˆç§»åŠ¨ç«¯ï¼‰

### æŠ€æœ¯éªŒæ”¶

- [ ] æé†’å‡†æ—¶ç‡ â‰¥ 99%ï¼ˆè¯¯å·® Â±1 åˆ†é’Ÿï¼‰
- [ ] åå°è¿è¡Œæ—¶æ­£å¸¸æé†’
- [ ] ç³»ç»Ÿé‡å¯åæ¢å¤æé†’
- [ ] æ—¶åŒºåˆ‡æ¢æ­£ç¡®å¤„ç†

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### æ•°æ®æ¨¡å‹

> **æ¶æ„å†³ç­–**: ä¹ æƒ¯æé†’ä½œä¸º Reminder æ¨¡å—çš„æ‰©å±•ï¼Œè€Œéç‹¬ç«‹å®ç°ã€‚åŸå› ï¼š
> - å¤ç”¨æé†’è°ƒåº¦å¼•æ“ï¼Œé¿å…é‡å¤å®ç°å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ
> - ç»Ÿä¸€é€šçŸ¥ç®¡ç†ï¼Œæ‰€æœ‰æé†’èµ°åŒä¸€å¥—é€šçŸ¥æ¸ é“
> - å…æ‰“æ‰°æ—¶æ®µã€æé†’æ—¥å¿—ç­‰åŸºç¡€è®¾æ–½å…±äº«
> - å‡å°‘ 70% çš„é‡å¤ä»£ç 

```typescript
// packages/domain-client/src/reminder/entities/
interface HabitReminder extends ReminderTemplate {
  id: string;
  habitId: string;
  userId: string;
  enabled: boolean;
  type: 'fixed' | 'smart' | 'location' | 'chain';
  schedule: ReminderSchedule;
  notification: NotificationConfig;
  createdAt: Date;
  updatedAt: Date;
}

interface ReminderSchedule {
  type: 'daily' | 'weekly' | 'custom';
  times: string[];               // HH:mm æ ¼å¼
  daysOfWeek?: number[];         // 0-6ï¼Œå‘¨æ—¥åˆ°å‘¨å…­
  customDates?: Date[];
  advanceMinutes?: number;       // æå‰æé†’åˆ†é’Ÿæ•°
  repeatCount?: number;          // é‡å¤æ¬¡æ•°ï¼ˆå¦‚æ¯å°æ—¶é‡å¤3æ¬¡ï¼‰
  repeatInterval?: number;       // é‡å¤é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
}

interface NotificationConfig {
  showSystemNotification: boolean;
  showInAppPopup: boolean;
  playSound: boolean;
  soundFile?: string;
  vibrate?: boolean;              // ç§»åŠ¨ç«¯
  actions: NotificationAction[];
}

interface NotificationAction {
  type: 'checkin' | 'delay' | 'skip';
  label: string;
}

interface SmartReminderConfig {
  enabled: boolean;
  learnFromHistory: boolean;
  avoidBusyHours: boolean;
  considerHabitChain: boolean;
  adaptToDelays: boolean;
  confidence: number;            // AI æ¨èç½®ä¿¡åº¦
}

interface LocationReminder {
  id: string;
  habitId: string;
  trigger: 'enter' | 'exit';
  location: {
    latitude: number;
    longitude: number;
    radius: number;              // ç±³
    name: string;
  };
  enabled: boolean;
}

interface HabitChainReminder {
  id: string;
  sequence: string[];            // habit IDs
  enabled: boolean;
  delaySeconds: number;          // å‰ä¸€ä¸ªå®Œæˆåå»¶è¿Ÿæé†’
}

interface ReminderLog {
  id: string;
  reminderId: string;
  triggeredAt: Date;
  respondedAt?: Date;
  action: 'checkin' | 'delay' | 'skip' | 'ignore';
  delayMinutes?: number;
}

interface DoNotDisturbPeriod {
  id: string;
  userId: string;
  startTime: string;             // HH:mm
  endTime: string;               // HH:mm
  daysOfWeek: number[];
  enabled: boolean;
}
```

### æœåŠ¡å±‚

```typescript
// packages/application-client/src/reminder/services/HabitReminderService.ts
// æ‰©å±• ReminderServiceï¼Œæ·»åŠ ä¹ æƒ¯ç‰¹å®šçš„æé†’é€»è¾‘
export class HabitReminderService extends ReminderService {
  // æé†’åˆ›å»º
  createReminder(
    habitId: string,
    schedule: ReminderSchedule
  ): Promise<HabitReminder>;
  
  createSmartReminder(habitId: string): Promise<HabitReminder>;
  
  createChainReminder(habitIds: string[]): Promise<HabitChainReminder>;
  
  // æé†’ç®¡ç†
  updateReminder(
    reminderId: string,
    updates: Partial<HabitReminder>
  ): Promise<HabitReminder>;
  
  deleteReminder(reminderId: string): Promise<void>;
  
  enableReminder(reminderId: string): Promise<void>;
  disableReminder(reminderId: string): Promise<void>;
  
  // å…¨å±€æ§åˆ¶
  pauseAllReminders(durationMinutes: number): Promise<void>;
  resumeAllReminders(): Promise<void>;
  
  // æé†’æŸ¥è¯¢
  getReminders(habitId: string): Promise<HabitReminder[]>;
  getNextReminder(habitId?: string): Promise<HabitReminder | null>;
  getReminderLogs(
    habitId: string,
    startDate: Date,
    endDate: Date
  ): Promise<ReminderLog[]>;
  
  // å‹¿æ‰°è®¾ç½®
  addDoNotDisturbPeriod(period: DoNotDisturbPeriod): Promise<void>;
  removeDoNotDisturbPeriod(periodId: string): Promise<void>;
  isInDoNotDisturbPeriod(): boolean;
  
  // æ™ºèƒ½å»ºè®®
  suggestReminderTime(habitId: string): Promise<string[]>;
  analyzeReminderEffectiveness(
    habitId: string
  ): Promise<EffectivenessReport>;
  
  // æé†’å“åº”
  respondToReminder(
    reminderId: string,
    action: 'checkin' | 'delay' | 'skip',
    delayMinutes?: number
  ): Promise<void>;
  
  // äº‹ä»¶
  onReminderTriggered: (reminder: HabitReminder) => void;
  onReminderResponded: (log: ReminderLog) => void;
}
```

### æ™ºèƒ½æé†’ç®—æ³•

```typescript
// åŸºäºå†å²æ•°æ®æ¨èæœ€ä½³æé†’æ—¶é—´
class SmartReminderEngine {
  async suggestBestTime(habitId: string): Promise<string[]> {
    // 1. è·å–å†å²æ‰“å¡æ•°æ®
    const checkIns = await this.getCheckInHistory(habitId);
    
    // 2. åˆ†ææ‰“å¡æ—¶é—´åˆ†å¸ƒ
    const timeDistribution = this.analyzeTimeDistribution(checkIns);
    
    // 3. æ‰¾å‡ºå³°å€¼æ—¶é—´æ®µ
    const peakHours = this.findPeakHours(timeDistribution);
    
    // 4. æå‰ 15 åˆ†é’Ÿæé†’
    const reminderTimes = peakHours.map(hour => {
      const reminderHour = hour - 0.25; // æå‰ 15 åˆ†é’Ÿ
      return this.formatTime(reminderHour);
    });
    
    return reminderTimes;
  }
  
  analyzeTimeDistribution(checkIns: HabitCheckIn[]): Map<number, number> {
    const distribution = new Map<number, number>();
    
    checkIns.forEach(checkIn => {
      const hour = checkIn.checkedAt.getHours() + 
                   checkIn.checkedAt.getMinutes() / 60;
      const count = distribution.get(hour) || 0;
      distribution.set(hour, count + 1);
    });
    
    return distribution;
  }
  
  findPeakHours(distribution: Map<number, number>): number[] {
    const sorted = Array.from(distribution.entries())
      .sort((a, b) => b[1] - a[1]);
    
    // è¿”å›å‰ 2 ä¸ªå³°å€¼æ—¶é—´
    return sorted.slice(0, 2).map(([hour]) => hour);
  }
  
  // å­¦ä¹ ç”¨æˆ·å»¶è¿Ÿä¹ æƒ¯
  async adaptToDelayPattern(habitId: string): Promise<number> {
    const logs = await this.getReminderLogs(habitId);
    
    // è®¡ç®—å¹³å‡å»¶è¿Ÿæ—¶é—´
    const delays = logs
      .filter(log => log.action === 'delay')
      .map(log => log.delayMinutes || 0);
    
    if (delays.length === 0) return 0;
    
    const avgDelay = delays.reduce((a, b) => a + b) / delays.length;
    
    // å¦‚æœç”¨æˆ·ç»å¸¸å»¶è¿Ÿ 30 åˆ†é’Ÿï¼Œå°±æå‰ 30 åˆ†é’Ÿæé†’
    return avgDelay;
  }
}

// ä¹ æƒ¯é“¾è¯†åˆ«
class HabitChainDetector {
  async detectChains(userId: string): Promise<HabitChainReminder[]> {
    const habits = await this.getHabits(userId);
    const chains: HabitChainReminder[] = [];
    
    // åˆ†ææ¯å¯¹ä¹ æƒ¯çš„å®Œæˆé¡ºåº
    for (let i = 0; i < habits.length; i++) {
      for (let j = 0; j < habits.length; j++) {
        if (i === j) continue;
        
        const correlation = await this.calculateSequenceCorrelation(
          habits[i].id,
          habits[j].id
        );
        
        // å¦‚æœ A å®Œæˆå 30 åˆ†é’Ÿå†… B ä¹Ÿå®Œæˆçš„æ¦‚ç‡ > 70%
        if (correlation.probability > 0.7 && correlation.avgDelay < 30) {
          chains.push({
            id: generateId(),
            sequence: [habits[i].id, habits[j].id],
            enabled: true,
            delaySeconds: correlation.avgDelay * 60,
          });
        }
      }
    }
    
    return chains;
  }
  
  async calculateSequenceCorrelation(
    habitA: string,
    habitB: string
  ): Promise<{ probability: number; avgDelay: number }> {
    const checkInsA = await this.getCheckIns(habitA);
    const checkInsB = await this.getCheckIns(habitB);
    
    let matches = 0;
    let totalDelays = 0;
    
    checkInsA.forEach(a => {
      const b = checkInsB.find(b =>
        this.isSameDay(a.date, b.date) && b.checkedAt > a.checkedAt
      );
      
      if (b) {
        matches++;
        const delay = (b.checkedAt.getTime() - a.checkedAt.getTime()) / 60000;
        totalDelays += delay;
      }
    });
    
    return {
      probability: matches / checkInsA.length,
      avgDelay: matches > 0 ? totalDelays / matches : 0,
    };
  }
}
```

### UI ç»„ä»¶

#### æé†’è®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â° ä¹ æƒ¯æé†’è®¾ç½®                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  [ âœ“ ] å¯ç”¨æ‰€æœ‰æé†’                                  â”‚
â”‚                                                      â”‚
â”‚  ä¹ æƒ¯: ğŸƒ æ™¨è·‘ 30 åˆ†é’Ÿ                               â”‚
â”‚                                                      â”‚
â”‚  å›ºå®šæ—¶é—´æé†’:                                       â”‚
â”‚  [ âœ“ ] æ¯å¤© 06:30  [ç¼–è¾‘] [åˆ é™¤]                     â”‚
â”‚  [ âœ“ ] æ¯å¤© 18:00  [ç¼–è¾‘] [åˆ é™¤]                     â”‚
â”‚  [ + æ·»åŠ æ—¶é—´ ]                                      â”‚
â”‚                                                      â”‚
â”‚  é‡å¤è®¾ç½®:                                           â”‚
â”‚  ( â— ) æ¯å¤©                                          â”‚
â”‚  (   ) å·¥ä½œæ—¥ (å‘¨ä¸€è‡³å‘¨äº”)                           â”‚
â”‚  (   ) å‘¨æœ«                                          â”‚
â”‚  (   ) è‡ªå®šä¹‰ [é€‰æ‹©æ—¥æœŸ]                             â”‚
â”‚                                                      â”‚
â”‚  ğŸ’¡ æ™ºèƒ½å»ºè®®:                                        â”‚
â”‚  æ ¹æ®ä½ çš„å†å²è®°å½•ï¼Œå»ºè®®åœ¨ä»¥ä¸‹æ—¶é—´æé†’:               â”‚
â”‚  â€¢ 06:45 (ä½ é€šå¸¸åœ¨è¿™ä¸ªæ—¶é—´å®Œæˆ)                      â”‚
â”‚  â€¢ æå‰ 15 åˆ†é’Ÿæé†’æ•ˆæœæœ€å¥½                          â”‚
â”‚  [ åº”ç”¨å»ºè®® ]                                        â”‚
â”‚                                                      â”‚
â”‚  æé†’æ–¹å¼:                                           â”‚
â”‚  [ âœ“ ] ç³»ç»Ÿé€šçŸ¥                                      â”‚
â”‚  [ âœ“ ] åº”ç”¨å†…å¼¹çª—                                    â”‚
â”‚  [ âœ“ ] å£°éŸ³æé†’  [é€‰æ‹©é“ƒå£° â–¼]                        â”‚
â”‚  [   ] éœ‡åŠ¨ (ç§»åŠ¨ç«¯)                                 â”‚
â”‚                                                      â”‚
â”‚  å¿«æ·æ“ä½œ:                                           â”‚
â”‚  [ âœ“ ] é€šçŸ¥ä¸­æ˜¾ç¤º"ç«‹å³æ‰“å¡"æŒ‰é’®                      â”‚
â”‚  [ âœ“ ] æ˜¾ç¤ºå½“å‰ Streak ä¿¡æ¯                          â”‚
â”‚                                                      â”‚
â”‚  ğŸ”— ä¹ æƒ¯é“¾æé†’:                                      â”‚
â”‚  [ âœ“ ] å®Œæˆ"æ™¨è·‘"å 5 åˆ†é’Ÿæé†’"å†¥æƒ³"                 â”‚
â”‚  (ç³»ç»Ÿæ£€æµ‹åˆ°ä½ é€šå¸¸åœ¨è·‘æ­¥åå†¥æƒ³)                      â”‚
â”‚                                                      â”‚
â”‚  â¸ï¸  å…æ‰“æ‰°æ—¶æ®µ:                                     â”‚
â”‚  [ âœ“ ] 12:00 - 13:00 (åˆä¼‘)                          â”‚
â”‚  [ âœ“ ] 22:00 - æ¬¡æ—¥ 06:00 (ç¡çœ )                     â”‚
â”‚  [ + æ·»åŠ æ—¶æ®µ ]                                      â”‚
â”‚                                                      â”‚
â”‚  ğŸ“Š æé†’æ•ˆæœåˆ†æ:                                    â”‚
â”‚  å“åº”ç‡: 87%  (13/15 æ¬¡)                             â”‚
â”‚  å¹³å‡å»¶è¿Ÿ: 12 åˆ†é’Ÿ                                   â”‚
â”‚  æœ€ä½³æé†’æ—¶é—´: 06:30                                 â”‚
â”‚  [ æŸ¥çœ‹è¯¦ç»†åˆ†æ ]                                    â”‚
â”‚                                                      â”‚
â”‚           [ ä¿å­˜è®¾ç½® ]  [ æµ‹è¯•æé†’ ]                 â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç³»ç»Ÿé€šçŸ¥æ ·å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DailyUse                                    [å…³é—­] â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  ğŸƒ è¯¥è·‘æ­¥äº†ï¼                                       â”‚
â”‚                                                      â”‚
â”‚  æ™¨è·‘ 30 åˆ†é’Ÿ                                        â”‚
â”‚  ğŸ”¥ å½“å‰è¿ç»­ 7 å¤©                                    â”‚
â”‚                                                      â”‚
â”‚  [ âœ“ ç«‹å³æ‰“å¡ ]  [ â° å»¶è¿Ÿ ]  [ âœ— è·³è¿‡ ]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åº”ç”¨å†…å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â° ä¹ æƒ¯æé†’                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚                      ğŸƒ                              â”‚
â”‚                                                      â”‚
â”‚                  æ™¨è·‘ 30 åˆ†é’Ÿ                        â”‚
â”‚                                                      â”‚
â”‚              ç°åœ¨æ˜¯æœ€ä½³è¿åŠ¨æ—¶é—´ï¼                    â”‚
â”‚                                                      â”‚
â”‚            ğŸ”¥ ä¿æŒ 7 å¤©è¿ç»­è®°å½• ğŸ”¥                   â”‚
â”‚                                                      â”‚
â”‚                                                      â”‚
â”‚             [ âœ“ å»æ‰“å¡ ]                             â”‚
â”‚                                                      â”‚
â”‚         [ å»¶è¿Ÿ 10åˆ†é’Ÿ ]  [ è·³è¿‡ä»Šå¤© ]                â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å»¶è¿Ÿé€‰æ‹©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â° å»¶è¿Ÿæé†’                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  å°†åœ¨ç¨åå†æ¬¡æé†’ä½ å®Œæˆ"æ™¨è·‘ 30 åˆ†é’Ÿ"                â”‚
â”‚                                                      â”‚
â”‚  é€‰æ‹©å»¶è¿Ÿæ—¶é•¿:                                       â”‚
â”‚                                                      â”‚
â”‚      [ 10 åˆ†é’Ÿ ]    [ 30 åˆ†é’Ÿ ]                     â”‚
â”‚                                                      â”‚
â”‚      [ 1 å°æ—¶ ]     [ 2 å°æ—¶ ]                      â”‚
â”‚                                                      â”‚
â”‚      [ è‡ªå®šä¹‰ ]                                      â”‚
â”‚                                                      â”‚
â”‚                [ ç¡®å®š ]  [ å–æ¶ˆ ]                   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¿›ç¨‹æé†’æœåŠ¡

```typescript
// apps/desktop/src/main/services/ReminderMainService.ts
export class ReminderMainService {
  private scheduledReminders = new Map<string, NodeJS.Timeout>();
  
  async initialize() {
    // å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰æé†’
    const reminders = await this.getAllReminders();
    reminders.forEach(reminder => this.scheduleReminder(reminder));
    
    // ç›‘å¬ç³»ç»ŸçŠ¶æ€
    this.watchSystemStatus();
  }
  
  scheduleReminder(reminder: HabitReminder) {
    const nextTriggerTime = this.calculateNextTriggerTime(reminder);
    const delay = nextTriggerTime.getTime() - Date.now();
    
    if (delay > 0) {
      const timeout = setTimeout(() => {
        this.triggerReminder(reminder);
      }, delay);
      
      this.scheduledReminders.set(reminder.id, timeout);
    }
  }
  
  async triggerReminder(reminder: HabitReminder) {
    // æ£€æŸ¥æ˜¯å¦åœ¨å…æ‰“æ‰°æ—¶æ®µ
    if (this.isInDoNotDisturbPeriod()) {
      // å»¶è¿Ÿåˆ°å…æ‰“æ‰°ç»“æŸ
      this.delayReminder(reminder, this.getDoNotDisturbEndTime());
      return;
    }
    
    // æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
    if (reminder.notification.showSystemNotification) {
      this.showSystemNotification(reminder);
    }
    
    // å‘é€åˆ°æ¸²æŸ“è¿›ç¨‹æ˜¾ç¤ºå¼¹çª—
    if (reminder.notification.showInAppPopup) {
      this.sendToRenderer('reminder:show', reminder);
    }
    
    // æ’­æ”¾å£°éŸ³
    if (reminder.notification.playSound) {
      this.playSound(reminder.notification.soundFile);
    }
    
    // è®°å½•æé†’æ—¥å¿—
    await this.logReminder(reminder);
    
    // é‡æ–°è°ƒåº¦ï¼ˆå¦‚æœæ˜¯é‡å¤æé†’ï¼‰
    this.scheduleReminder(reminder);
  }
  
  private watchSystemStatus() {
    const { powerMonitor } = require('electron');
    
    // ç³»ç»Ÿç¡çœ æ—¶æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
    powerMonitor.on('suspend', () => {
      this.scheduledReminders.forEach(timeout => clearTimeout(timeout));
      this.scheduledReminders.clear();
    });
    
    // ç³»ç»Ÿå”¤é†’æ—¶é‡æ–°è°ƒåº¦
    powerMonitor.on('resume', () => {
      this.initialize();
    });
  }
}
```

---

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

```
packages/domain-client/src/habit/
  â”œâ”€â”€ aggregates/HabitReminder.ts
  â”œâ”€â”€ aggregates/LocationReminder.ts
  â”œâ”€â”€ aggregates/HabitChainReminder.ts
  â”œâ”€â”€ value-objects/ReminderSchedule.ts
  â”œâ”€â”€ value-objects/NotificationConfig.ts
  â”œâ”€â”€ value-objects/ReminderLog.ts
  â””â”€â”€ value-objects/DoNotDisturbPeriod.ts

packages/application-client/src/habit/
  â”œâ”€â”€ services/HabitReminderService.ts
  â””â”€â”€ utils/
      â”œâ”€â”€ SmartReminderEngine.ts
      â””â”€â”€ HabitChainDetector.ts

packages/infrastructure-client/src/repositories/
  â””â”€â”€ HabitReminderRepository.ts

apps/desktop/src/main/services/
  â””â”€â”€ ReminderMainService.ts

apps/desktop/src/renderer/components/habit/reminder/
  â”œâ”€â”€ ReminderSettingsPage.tsx
  â”œâ”€â”€ ReminderTimeSelector.tsx
  â”œâ”€â”€ ReminderNotificationModal.tsx
  â”œâ”€â”€ DelayReminderModal.tsx
  â”œâ”€â”€ DoNotDisturbSettings.tsx
  â”œâ”€â”€ SmartSuggestions.tsx
  â”œâ”€â”€ HabitChainSettings.tsx
  â””â”€â”€ ReminderEffectivenessReport.tsx

apps/desktop/src/renderer/hooks/
  â””â”€â”€ useReminders.ts

apps/desktop/src/preload/channels/
  â””â”€â”€ reminderChannels.ts
```

### ä¿®æ”¹æ–‡ä»¶

```
apps/desktop/src/main/main.ts
  â””â”€â”€ åˆå§‹åŒ– ReminderMainService

apps/desktop/src/preload/preload.ts
  â””â”€â”€ æ·»åŠ  reminder:* é€šé“ç™½åå•

apps/desktop/src/renderer/components/habit/HabitDetailPage.tsx
  â””â”€â”€ æ·»åŠ æé†’è®¾ç½®å…¥å£
```

---

## ğŸ§ª æµ‹è¯•è¦ç‚¹

### å•å…ƒæµ‹è¯•

- æé†’æ—¶é—´è®¡ç®—
- æ™ºèƒ½æ¨èç®—æ³•
- ä¹ æƒ¯é“¾æ£€æµ‹
- å…æ‰“æ‰°åˆ¤æ–­

### é›†æˆæµ‹è¯•

- æé†’å‡†æ—¶è§¦å‘
- ç³»ç»Ÿç¡çœ /å”¤é†’å¤„ç†
- ä¸»è¿›ç¨‹ â†” æ¸²æŸ“è¿›ç¨‹é€šä¿¡
- æé†’å“åº”è®°å½•

### E2E æµ‹è¯•

- å®Œæ•´æé†’æµç¨‹
- å»¶è¿Ÿæé†’
- å¿«é€Ÿæ‰“å¡
- ä¹ æƒ¯é“¾æé†’

### æ€§èƒ½æµ‹è¯•

- å¤§é‡æé†’è°ƒåº¦
- é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
- å†…å­˜å ç”¨

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‡†æ—¶æ€§**ï¼šæé†’è¦å‡†æ—¶ï¼Œè¯¯å·®æ§åˆ¶åœ¨ 1 åˆ†é’Ÿå†…
2. **å¯é æ€§**ï¼šç³»ç»Ÿé‡å¯ã€ç¡çœ å”¤é†’åè¦æ­£å¸¸å·¥ä½œ
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæé†’ä¸èƒ½è¿‡äºæ‰“æ‰°ï¼Œè¦å°Šé‡å…æ‰“æ‰°è®¾ç½®
4. **æƒé™ç®¡ç†**ï¼šç³»ç»Ÿé€šçŸ¥éœ€è¦ç”¨æˆ·æˆæƒ
5. **ç”µæ± ä¼˜åŒ–**ï¼šç§»åŠ¨ç«¯è¦è€ƒè™‘ç”µæ± æ¶ˆè€—
6. **æ—¶åŒºå¤„ç†**ï¼šè·¨æ—¶åŒºä½¿ç”¨è¦æ­£ç¡®å¤„ç†
7. **éšç§ä¿æŠ¤**ï¼šä½ç½®æé†’è¦æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
8. **æ— éšœç¢**ï¼šé€šçŸ¥è¦æ”¯æŒå±å¹•é˜…è¯»å™¨

---

## ğŸš€ æœªæ¥æ‰©å±•

1. **è¯­éŸ³æé†’**ï¼šè¯­éŸ³æ’­æŠ¥æé†’å†…å®¹
2. **æƒ…å¢ƒæ„ŸçŸ¥**ï¼šæ ¹æ®æ—¥å†ã€å¤©æ°”ç­‰è°ƒæ•´æé†’
3. **ç¤¾äº¤æé†’**ï¼šå¥½å‹å®Œæˆæ—¶æé†’è‡ªå·±
4. **æ‰‹è¡¨é›†æˆ**ï¼šæ™ºèƒ½æ‰‹è¡¨éœ‡åŠ¨æé†’
5. **AI åŠ©æ‰‹**ï¼šå¯¹è¯å¼æé†’äº¤äº’
6. **æ¸¸æˆåŒ–**ï¼šæé†’å¤±è´¥æœ‰"æƒ©ç½š"ï¼ŒåŠæ—¶å“åº”æœ‰å¥–åŠ±
7. **å®¶åº­å…±äº«**ï¼šå®¶äººäº’ç›¸æé†’
8. **ç¬¬ä¸‰æ–¹é›†æˆ**ï¼šä¸æ—¥å†ã€å¾…åŠäº‹é¡¹åŒæ­¥
