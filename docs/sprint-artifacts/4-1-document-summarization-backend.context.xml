<story-context id="story-4-1-document-summarization-backend" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4-1</storyId>
    <title>Document Summarization Backend</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-1-document-summarization-backend.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a User</asA>
    <iWant>I want to summarize long texts</iWant>
    <soThat>So that I can get the key points quickly.</soThat>
    <tasks>
      <![CDATA[
Task 1: Create Request/Response DTOs (SummarizationRequestDTO, SummarizationResultDTO)
Task 2: Implement SUMMARIZATION_PROMPT template (system + user + JSON format)
Task 3: Add summarizeDocument() in AIGenerationService (validate, quota, adapter invoke, logging)
Task 4: Implement validateSummaryOutput() (core length, keyPoints count, actionItems count)
Task 5: Extend AIGenerationApplicationService (orchestration + GenerationTask entity)
Task 6: Add Controller handler (AIConversationController.summarizeDocument) with Zod validation
Task 7: Add route POST /api/ai/summarize + Swagger docs
Task 8: Unit tests for summarizeDocument (happy path + validation failures + quota consumption + compressionRatio)
Task 9: Integration tests for endpoint (auth, size limits, quota exceeded, timeout)
Task 10: Manual quality verification (10 varied text samples, ≥80% accuracy)
      ]]>
    </tasks>
  </story>

  <acceptanceCriteria><![CDATA[
AC-1: POST /api/ai/summarize returns 200 OK
AC-2: Response contains summary.core, summary.keyPoints[], summary.actionItems[]
AC-3: core summary 50-150 words
AC-4: keyPoints 3-5 items, each 15-30 words
AC-5: actionItems 0-3 practical suggestions
AC-6: input length 1-50,000 chars enforced
AC-7: quota checked & consumed (QuotaEnforcementService)
AC-8: metadata.tokensUsed, metadata.compressionRatio, metadata.inputLength present
AC-9: Uses AIGenerationService & QuotaEnforcementService
AC-10: Prompt template produces JSON only
AC-11: Response structure validated (core/keyPoints/actionItems)
AC-12: Logs summarization events (accountUuid, tokensUsed, inputLength)
AC-13: Controller thin (delegates to application service)
AC-14: language + includeActions optional params supported
AC-15: Unit tests for summarizeDocument()
AC-16: Integration test with MockAIAdapter
AC-17: Zero TypeScript errors
AC-18: Swagger/OpenAPI documented
  ]]></acceptanceCriteria>

  <artifacts>
    <docs><![CDATA[
{ "items": [
  {
    "path": "docs/sprint-artifacts/tech-spec-epic-4.md",
    "title": "Epic 4 Tech Spec",
    "section": "API Design / Summarization",
    "snippet": "POST /api/ai/summarize returns structured summary { core, keyPoints, actionItems } with metadata (tokensUsed, compressionRatio)."
  },
  {
    "path": "docs/architecture-api.md",
    "title": "API Backend Architecture",
    "section": "DDD Layers",
    "snippet": "Interface → Application → Domain → Infrastructure layered pattern; controller must remain thin and delegate to application service."
  },
  {
    "path": "docs/epics.md",
    "title": "Epics File",
    "section": "Story 4.1 Definition",
    "snippet": "Story 4.1 defines summarization endpoint POST /api/ai/summarize with structured summary output (Core, Key Points, Actions)."
  }
]}
    ]]></docs>
    <code><![CDATA[
{ "items": [
  {
    "path": "packages/domain-server/src/modules/ai/services/AIGenerationService.ts",
    "kind": "service",
    "symbol": "AIGenerationService",
    "lines": "1-250",
    "reason": "Base pattern for generation workflow (validate, quota, adapter, persist). Summarization will follow similar steps."
  },
  {
    "path": "packages/domain-server/src/modules/ai/services/QuotaEnforcementService.ts",
    "kind": "service",
    "symbol": "QuotaEnforcementService",
    "lines": "1-160",
    "reason": "Provides quota check/consume operations required by AC-7."
  },
  {
    "path": "apps/api/src/modules/ai/interface/http/AIConversationController.ts",
    "kind": "controller",
    "symbol": "AIConversationController",
    "lines": "1-200",
    "reason": "Existing controller structure to extend with summarizeDocument handler (thin controller pattern)."
  },
  {
    "path": "vitest.config.ts",
    "kind": "config",
    "symbol": "vitest root config",
    "lines": "1-120",
    "reason": "Testing framework configuration for unit/integration tests (AC-15, AC-16)."
  }
]}
    ]]></code>
    <dependencies><![CDATA[
{ "runtime": [
  { "name": "@dailyuse/contracts", "version": "workspace:*", "reason": "Expose DTOs & enums for request/response." },
  { "name": "@dailyuse/domain-server", "version": "workspace:*", "reason": "Domain services extension (summarizeDocument)." },
  { "name": "zod", "version": "4.1.12", "reason": "Request validation in controller." },
  { "name": "swagger-jsdoc", "version": "6.2.8", "reason": "API documentation (AC-18)." },
  { "name": "swagger-ui-express", "version": "5.0.1", "reason": "Serve API docs." }
], "dev": [
  { "name": "vitest", "version": "^3.2.4", "reason": "Unit & integration tests (AC-15, AC-16)." },
  { "name": "@testing-library/jest-dom", "version": "^6.8.0", "reason": "Extended matchers (if UI tests appear later)." }
]}
    ]]></dependencies>
  </artifacts>

  <constraints><![CDATA[
Controller must remain thin (AC-13) and delegate to application service; summarization logic resides in domain service following existing AIGenerationService pattern. Must reuse QuotaEnforcementService for quota checks (no duplicate quota logic). Response must be strictly JSON with required fields; reject malformed AI output. Input length limit enforced early (avoid unnecessary token spend). Logging mandatory: accountUuid, tokensUsed, inputLength (audit + future monitoring). Model config: temperature 0.5 (deterministic summaries). No persistence of summaries (transient response) per current scope.
  ]]></constraints>
  <interfaces><![CDATA[
{ "rest": [
  {
    "name": "Summarize Document",
    "kind": "POST",
    "signature": "POST /api/ai/summarize { text: string (1-50000), language?: 'zh-CN'|'en', includeActions?: boolean } → 200 { summary: { core: string, keyPoints: string[], actionItems?: string[] }, metadata: { tokensUsed: number, generatedAt: number, inputLength: number, compressionRatio: number } }",
    "path": "apps/api/src/modules/ai/interface/http/AIConversationController.ts"
  }
]}
    ]]></interfaces>
  <tests>
    <standards><![CDATA[
Vitest is the unified test runner. Unit tests target domain service (summarizeDocument) with adapter mocked. Integration tests invoke Express route using Supertest with MockAIAdapter registered. All tests reside in __tests__ directories near services or in api module test folder. 100% AC mapping required.
    ]]></standards>
    <locations><![CDATA[
packages/domain-server/src/modules/ai/services/__tests__
apps/api/src/modules/ai/interface/http/__tests__
    ]]></locations>
    <ideas><![CDATA[
TC-AC-1: POST /api/ai/summarize returns 200 for valid input.
TC-AC-3: Reject core summary length outside 50-150 → validation error.
TC-AC-4: Reject keyPoints count <3 or >5.
TC-AC-5: includeActions=false returns no actionItems field.
TC-AC-6: Input >50000 chars → 400 error.
TC-AC-7: Quota exceeded scenario returns 429.
TC-AC-10: Ensure response is valid JSON (simulate malformed adapter output).
TC-AC-12: Log entry asserted (spy logger) includes tokensUsed & inputLength.
TC-AC-15: Unit test covers happy path + validation failures.
TC-AC-16: Integration test with MockAIAdapter simulates timeout.
    ]]></ideas>
  </tests>
</story-context>
