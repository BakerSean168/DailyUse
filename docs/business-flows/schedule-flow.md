# Schedule è°ƒåº¦ç³»ç»Ÿä¸šåŠ¡æµç¨‹

> **æ ¸å¿ƒæ¨¡å—**ï¼šSchedule (è°ƒåº¦å¼•æ“)  
> **æ›´æ–°æ—¥æœŸ**ï¼š2025-11-26  
> **çŠ¶æ€**ï¼šâœ… å·²å®æ–½

---

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [è¿è¡Œæœºåˆ¶](#è¿è¡Œæœºåˆ¶)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [ç”Ÿå‘½å‘¨æœŸ](#ç”Ÿå‘½å‘¨æœŸ)
- [ç›‘æ§ä¸è°ƒè¯•](#ç›‘æ§ä¸è°ƒè¯•)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ Schedule æ¨¡å—ï¼Ÿ

Schedule æ˜¯ DailyUse çš„**ç»Ÿä¸€è°ƒåº¦å¼•æ“**ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œï¼š
- **Reminder æé†’**ï¼šå®šæ—¶è§¦å‘æé†’é€šçŸ¥
- **Goal ç›®æ ‡æé†’**ï¼šç›®æ ‡æˆªæ­¢æ—¥æœŸæé†’
- **Task ä»»åŠ¡æé†’**ï¼šä»»åŠ¡åˆ°æœŸæé†’
- **åå°ä»»åŠ¡**ï¼šæ•°æ®æ¸…ç†ã€ç»Ÿè®¡æŠ¥è¡¨ç­‰

### è®¾è®¡ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡æ¨¡å— (Reminder/Goal/Task)          â”‚
â”‚  - åˆ›å»ºä¸šåŠ¡æ•°æ®                          â”‚
â”‚  - å‘å¸ƒé¢†åŸŸäº‹ä»¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ event: reminder.created
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Schedule æ¨¡å—                           â”‚
â”‚  - ç›‘å¬ä¸šåŠ¡äº‹ä»¶                          â”‚
â”‚  - åˆ›å»º ScheduleTask                     â”‚
â”‚  - ç®¡ç† Cron ä»»åŠ¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ cron trigger
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notification æ¨¡å—                       â”‚
â”‚  - å‘é€é€šçŸ¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **ä¸šåŠ¡è§£è€¦**ï¼šä¸šåŠ¡æ¨¡å—ä¸éœ€è¦å…³å¿ƒå¦‚ä½•è°ƒåº¦
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰å®šæ—¶ä»»åŠ¡åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†
- âœ… **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„ç›‘æ§å’Œæ‰§è¡Œå†å²
- âœ… **å¯é æ€§**ï¼šæ”¯æŒé‡è¯•ã€é”™è¯¯å¤„ç†ã€æŒä¹…åŒ–

---

## è¿è¡Œæœºåˆ¶

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API æœåŠ¡å¯åŠ¨                        â”‚
â”‚                       â”‚                              â”‚
â”‚                       â–¼                              â”‚
â”‚           ScheduleBootstrap.initialize()             â”‚
â”‚                       â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“å±‚        â”‚          â”‚   å†…å­˜å±‚          â”‚
â”‚                  â”‚          â”‚                  â”‚
â”‚ ScheduleTask     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ CronJobManager   â”‚
â”‚ (æŒä¹…åŒ–)         â”‚  åŠ è½½     â”‚ (node-cron)      â”‚
â”‚                  â”‚          â”‚                  â”‚
â”‚ - uuid           â”‚          â”‚ Map<uuid, Job>   â”‚
â”‚ - cronExpression â”‚          â”‚                  â”‚
â”‚ - enabled        â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ - nextRunAt      â”‚          â”‚ â”‚ Cron Job 1   â”‚ â”‚
â”‚ - payload        â”‚          â”‚ â”‚ '0 30 9 * *' â”‚ â”‚
â”‚                  â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                  â”‚
                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                              â”‚ â”‚ Cron Job 2   â”‚ â”‚
                              â”‚ â”‚ '*/30 * * *' â”‚ â”‚
                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚ æ—¶é—´åˆ°è¾¾
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ ScheduleTask     â”‚
                              â”‚ Executor         â”‚
                              â”‚                  â”‚
                              â”‚ - åŠ è½½ä»»åŠ¡        â”‚
                              â”‚ - æ‰§è¡Œä¸šåŠ¡é€»è¾‘   â”‚
                              â”‚ - æ›´æ–°çŠ¶æ€       â”‚
                              â”‚ - è®°å½•å†å²       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æœºåˆ¶è¯´æ˜

#### 1. **å†…å­˜å¸¸é©» + æ•°æ®åº“æŒä¹…åŒ–**

**ä¸æ˜¯å®šæœŸæ‰«ææ•°æ®åº“ï¼**

```typescript
// âŒ é”™è¯¯ç†è§£ï¼šæ¯åˆ†é’Ÿæ‰«ææ•°æ®åº“
setInterval(() => {
  const tasks = db.query('SELECT * FROM tasks WHERE next_run <= now()');
  tasks.forEach(task => execute(task));
}, 60000);

// âœ… å®é™…æœºåˆ¶ï¼šnode-cron äº‹ä»¶é©±åŠ¨
cron.schedule('0 30 9 * * *', async () => {
  // æ—¶é—´åˆ°è¾¾æ—¶è‡ªåŠ¨è§¦å‘ï¼Œä¸éœ€è¦è½®è¯¢
  await executeTask(taskUuid);
});
```

**ä¼˜åŠ¿**ï¼š
- âš¡ **ç²¾ç¡®**ï¼šç²¾ç¡®åˆ°ç§’ï¼Œä¸ä¼šæœ‰å»¶è¿Ÿ
- âš¡ **é«˜æ•ˆ**ï¼šä¸éœ€è¦æ•°æ®åº“è½®è¯¢ï¼ŒCPU å ç”¨ä½
- âš¡ **å®æ—¶**ï¼šäº‹ä»¶é©±åŠ¨ï¼Œå“åº”è¿…é€Ÿ

#### 2. **å¯åŠ¨æ—¶åŠ è½½æœºåˆ¶**

```typescript
// ScheduleBootstrap.ts
public async initialize(): Promise<void> {
  // 1. ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ enabled=true çš„ä»»åŠ¡
  const tasks = await repository.findEnabled();
  
  // 2. æ³¨å†Œåˆ° CronJobManagerï¼ˆå†…å­˜ä¸­ï¼‰
  for (const task of tasks) {
    if (task.status === 'active' && task.enabled) {
      cronManager.registerTask(task);
    }
  }
  
  // 3. ä»»åŠ¡å¼€å§‹åœ¨å†…å­˜ä¸­è¿è¡Œ
  logger.info('Schedule æ¨¡å—åˆå§‹åŒ–å®Œæˆ', { 
    taskCount: tasks.length 
  });
}
```

**æµç¨‹å›¾**ï¼š
```
æœåŠ¡å¯åŠ¨
    â”‚
    â–¼
ScheduleBootstrap.initialize()
    â”‚
    â–¼
æŸ¥è¯¢æ•°æ®åº“: SELECT * FROM schedule_tasks WHERE enabled = true
    â”‚
    â–¼
éå†æ¯ä¸ªä»»åŠ¡
    â”‚
    â”œâ”€â”€â–¶ è§£æ cronExpression
    â”‚
    â”œâ”€â”€â–¶ åˆ›å»º node-cron Job
    â”‚
    â”œâ”€â”€â–¶ ä¿å­˜åˆ° Map<uuid, Job>
    â”‚
    â””â”€â”€â–¶ job.start()
    
å†…å­˜ä¸­çš„ Cron ä»»åŠ¡å¼€å§‹è¿è¡Œ
```

#### 3. **çƒ­é‡è½½æœºåˆ¶**

**åˆ›å»ºæ–°ä»»åŠ¡æ—¶**ï¼š
```typescript
// ReminderApplicationService.ts
async createReminder(request) {
  // 1. åˆ›å»º Reminder
  const reminder = ReminderTemplate.create(request);
  await reminderRepository.save(reminder);
  
  // 2. å‘å¸ƒäº‹ä»¶
  eventBus.publish('reminder.created', { reminder });
  
  // 3. äº‹ä»¶ç›‘å¬å™¨è‡ªåŠ¨åˆ›å»º ScheduleTask
  // ReminderScheduleHandler.ts
  @OnEvent('reminder.created')
  async handleReminderCreated(event) {
    const scheduleTask = ScheduleTask.create({
      sourceModule: 'REMINDER',
      sourceEntityId: reminder.uuid,
      cronExpression: this.calculateCron(reminder),
    });
    await scheduleTaskRepository.save(scheduleTask);
    
    // 4. ğŸ”¥ çƒ­åŠ è½½ï¼šç«‹å³æ³¨å†Œåˆ° CronJobManager
    cronManager.registerTask(scheduleTask);
  }
}
```

**æ›´æ–°ä»»åŠ¡æ—¶**ï¼š
```typescript
async updateReminder(uuid, changes) {
  // 1. æ›´æ–° Reminder
  reminder.update(changes);
  await reminderRepository.save(reminder);
  
  // 2. æ›´æ–° ScheduleTask
  const scheduleTask = await scheduleTaskRepository.findBySourceEntity(
    'REMINDER', 
    uuid
  );
  scheduleTask.updateCronExpression(newCron);
  await scheduleTaskRepository.save(scheduleTask);
  
  // 3. ğŸ”¥ çƒ­é‡è½½ï¼šé‡æ–°æ³¨å†Œ Cron Job
  cronManager.updateTask(scheduleTask); // å†…éƒ¨ä¼šå…ˆ unregister å† register
}
```

**åˆ é™¤ä»»åŠ¡æ—¶**ï¼š
```typescript
async deleteReminder(uuid) {
  // 1. åˆ é™¤ Reminder
  await reminderRepository.delete(uuid);
  
  // 2. åˆ é™¤ ScheduleTask
  await scheduleTaskRepository.deleteBySourceEntity('REMINDER', uuid);
  
  // 3. ğŸ”¥ çƒ­å¸è½½ï¼šä» CronJobManager ç§»é™¤
  cronManager.unregisterTask(taskUuid);
}
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. ScheduleTaskï¼ˆèšåˆæ ¹ï¼‰

**èŒè´£**ï¼šç®¡ç†å•ä¸ªè°ƒåº¦ä»»åŠ¡çš„å®Œæ•´ä¿¡æ¯

```typescript
interface ScheduleTask {
  uuid: string;
  accountUuid: string;
  name: string;
  sourceModule: 'REMINDER' | 'GOAL' | 'TASK';
  sourceEntityId: string;  // å¯¹åº”ä¸šåŠ¡å®ä½“çš„ UUID
  
  // è°ƒåº¦é…ç½®
  schedule: {
    cronExpression: string;
    timezone: string;
    startDate?: number;
    endDate?: number;
    maxExecutions?: number;
  };
  
  // æ‰§è¡ŒçŠ¶æ€
  executionInfo: {
    nextRunAt: number | null;
    lastRunAt: number | null;
    executionCount: number;
    lastExecutionStatus: 'SUCCESS' | 'FAILED' | 'SKIPPED';
    consecutiveFailures: number;
  };
  
  // é‡è¯•ç­–ç•¥
  retryPolicy: {
    maxRetries: number;
    initialDelayMs: number;
    backoffMultiplier: number;
  };
  
  // ä»»åŠ¡å…ƒæ•°æ®
  metadata: {
    payload: Record<string, any>;  // æ‰§è¡Œæ—¶éœ€è¦çš„æ•°æ®
    tags: string[];
    priority: number;
    timeout?: number;
  };
  
  status: 'active' | 'paused' | 'completed' | 'failed';
  enabled: boolean;
}
```

### 2. CronJobManagerï¼ˆåŸºç¡€è®¾æ–½ï¼‰

**èŒè´£**ï¼šç®¡ç†æ‰€æœ‰ Cron ä»»åŠ¡çš„æ³¨å†Œã€æ‰§è¡Œã€ç›‘æ§

```typescript
class CronJobManager {
  // å†…å­˜ä¸­çš„ä»»åŠ¡æ˜ å°„è¡¨
  private jobs: Map<string, CronJob> = new Map();
  private cronExpressions: Map<string, string> = new Map();
  
  /**
   * æ³¨å†Œä»»åŠ¡
   * @returns æ˜¯å¦æˆåŠŸæ³¨å†Œ
   */
  public registerTask(task: ScheduleTask): boolean {
    const cronJob = cron.schedule(
      task.schedule.cronExpression,
      async () => {
        // æ—¶é—´åˆ°è¾¾æ—¶æ‰§è¡Œ
        await this.executor.executeTaskByUuid(task.uuid);
      },
      {
        timezone: task.schedule.timezone || 'Asia/Shanghai',
      }
    );
    
    if (task.enabled) {
      cronJob.start();
    }
    
    this.jobs.set(task.uuid, cronJob);
    return true;
  }
  
  /**
   * æ³¨é”€ä»»åŠ¡
   */
  public unregisterTask(taskUuid: string): boolean {
    const job = this.jobs.get(taskUuid);
    if (job) {
      job.stop();
      this.jobs.delete(taskUuid);
      return true;
    }
    return false;
  }
  
  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  public getStats() {
    return {
      totalJobs: this.jobs.size,
      registeredTasks: Array.from(this.jobs.keys()),
      cronExpressions: Object.fromEntries(this.cronExpressions),
    };
  }
}
```

### 3. ScheduleTaskExecutorï¼ˆåº”ç”¨æœåŠ¡ï¼‰

**èŒè´£**ï¼šæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡é€»è¾‘

```typescript
class ScheduleTaskExecutor {
  async executeTaskByUuid(taskUuid: string): Promise<void> {
    // 1. åŠ è½½ä»»åŠ¡
    const task = await this.repository.findByUuid(taskUuid);
    if (!task) return;
    
    // 2. æ£€æŸ¥çŠ¶æ€
    if (!task.enabled || task.status !== 'active') {
      return;
    }
    
    // 3. è®°å½•å¼€å§‹æ‰§è¡Œ
    const execution = ScheduleExecution.create({
      taskUuid: task.uuid,
      status: 'RUNNING',
    });
    
    // 4. æ ¹æ® sourceModule åˆ†å‘åˆ°å¯¹åº”çš„æ‰§è¡Œå™¨
    try {
      switch (task.sourceModule) {
        case 'REMINDER':
          await this.executeReminderTask(task);
          break;
        case 'GOAL':
          await this.executeGoalTask(task);
          break;
        case 'TASK':
          await this.executeTaskTask(task);
          break;
      }
      
      execution.markSuccess();
    } catch (error) {
      execution.markFailed(error);
      
      // é‡è¯•é€»è¾‘
      if (execution.retryCount < task.retryPolicy.maxRetries) {
        await this.scheduleRetry(task, execution);
      }
    }
    
    // 5. æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task.recordExecution(execution);
    task.calculateNextRun();
    await this.repository.save(task);
  }
  
  private async executeReminderTask(task: ScheduleTask): Promise<void> {
    const reminderUuid = task.sourceEntityId;
    const reminder = await reminderRepository.findByUuid(reminderUuid);
    
    // å‘é€é€šçŸ¥
    await notificationService.send({
      accountUuid: reminder.accountUuid,
      title: reminder.notificationConfig.title,
      body: reminder.notificationConfig.body,
      channels: reminder.notificationConfig.channels,
    });
  }
}
```

### 4. ScheduleMonitorï¼ˆç›‘æ§ï¼‰

**èŒè´£**ï¼šæ”¶é›†å’ŒæŠ¥å‘Šæ‰§è¡Œç»Ÿè®¡

```typescript
class ScheduleMonitor {
  private executionStats = {
    totalExecutions: 0,
    successCount: 0,
    failureCount: 0,
    skipCount: 0,
    totalDuration: 0,
    lastExecutionTime: null,
  };
  
  public recordExecution(execution: ScheduleExecution): void {
    this.executionStats.totalExecutions++;
    
    switch (execution.status) {
      case 'SUCCESS':
        this.executionStats.successCount++;
        break;
      case 'FAILED':
        this.executionStats.failureCount++;
        break;
      case 'SKIPPED':
        this.executionStats.skipCount++;
        break;
    }
    
    if (execution.duration) {
      this.executionStats.totalDuration += execution.duration;
    }
    
    this.executionStats.lastExecutionTime = Date.now();
  }
  
  public printMonitorReport(): void {
    const avgDuration = this.executionStats.totalExecutions > 0
      ? this.executionStats.totalDuration / this.executionStats.totalExecutions
      : 0;
    
    logger.info('ğŸ“Š è°ƒåº¦ä»»åŠ¡ç›‘æ§æŠ¥å‘Š', {
      æ­£åœ¨æ‰§è¡Œ: this.currentlyExecuting.size,
      æ€»æ‰§è¡Œæ¬¡æ•°: this.executionStats.totalExecutions,
      æˆåŠŸæ¬¡æ•°: this.executionStats.successCount,
      å¤±è´¥æ¬¡æ•°: this.executionStats.failureCount,
      è·³è¿‡æ¬¡æ•°: this.executionStats.skipCount,
      æˆåŠŸç‡: `${this.getSuccessRate()}%`,
      å¹³å‡æ‰§è¡Œæ—¶é•¿: `${avgDuration.toFixed(2)}ms`,
      æœ€åæ‰§è¡Œæ—¶é—´: this.formatTime(this.executionStats.lastExecutionTime),
    });
  }
}
```

---

## ç”Ÿå‘½å‘¨æœŸ

### å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾

```mermaid
stateDiagram-v2
    [*] --> åˆ›å»º: ä¸šåŠ¡æ¨¡å—è§¦å‘
    åˆ›å»º --> æ³¨å†Œ: ScheduleBootstrap åŠ è½½
    æ³¨å†Œ --> è¿è¡Œ: job.start()
    è¿è¡Œ --> æ‰§è¡Œä¸­: Cron è§¦å‘
    æ‰§è¡Œä¸­ --> æˆåŠŸ: æ‰§è¡ŒæˆåŠŸ
    æ‰§è¡Œä¸­ --> å¤±è´¥: æ‰§è¡Œå¤±è´¥
    æˆåŠŸ --> è¿è¡Œ: è®¡ç®—ä¸‹æ¬¡æ—¶é—´
    å¤±è´¥ --> é‡è¯•: æœªè¾¾é‡è¯•ä¸Šé™
    é‡è¯• --> æ‰§è¡Œä¸­: å»¶è¿Ÿåé‡è¯•
    å¤±è´¥ --> æš‚åœ: è¾¾åˆ°é‡è¯•ä¸Šé™
    è¿è¡Œ --> æš‚åœ: ç”¨æˆ·æš‚åœ
    æš‚åœ --> è¿è¡Œ: ç”¨æˆ·æ¢å¤
    è¿è¡Œ --> å®Œæˆ: è¾¾åˆ° maxExecutions
    è¿è¡Œ --> åˆ é™¤: ç”¨æˆ·åˆ é™¤
    æš‚åœ --> åˆ é™¤: ç”¨æˆ·åˆ é™¤
    å®Œæˆ --> [*]
    åˆ é™¤ --> [*]
```

### è¯¦ç»†æµç¨‹

#### 1. åˆ›å»ºé˜¶æ®µ
```typescript
// ç”¨æˆ·åˆ›å»º Reminder
POST /api/v1/reminders
  â†“
ReminderApplicationService.createReminder()
  â†“
eventBus.publish('reminder.created')
  â†“
ReminderScheduleHandler.handleReminderCreated()
  â†“
åˆ›å»º ScheduleTask + ä¿å­˜åˆ°æ•°æ®åº“
  â†“
cronManager.registerTask() // ğŸ”¥ çƒ­åŠ è½½
  â†“
Cron Job å¼€å§‹åœ¨å†…å­˜ä¸­è¿è¡Œ
```

#### 2. è¿è¡Œé˜¶æ®µ
```typescript
æ¯éš” N åˆ†é’Ÿ/å°æ—¶/å¤©ï¼ˆæ ¹æ® cronï¼‰
  â†“
node-cron è§¦å‘å›è°ƒ
  â†“
ScheduleTaskExecutor.executeTaskByUuid()
  â†“
åŠ è½½ ScheduleTask â†’ æ£€æŸ¥çŠ¶æ€ â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  â†“
æ›´æ–° executionInfo (nextRunAt, executionCount)
  â†“
è®°å½• ScheduleExecution å†å²
  â†“
ä¿å­˜åˆ°æ•°æ®åº“
  â†“
ç»§ç»­ç­‰å¾…ä¸‹æ¬¡è§¦å‘
```

#### 3. æš‚åœ/æ¢å¤
```typescript
// æš‚åœ
PATCH /api/v1/reminders/{id}/pause
  â†“
reminder.pause() // status = 'PAUSED'
  â†“
scheduleTask.disable()
  â†“
cronManager.stopTask(taskUuid) // job.stop()
  â†“
Cron Job åœæ­¢è§¦å‘ï¼ˆä½†ä¸åˆ é™¤ï¼‰

// æ¢å¤
PATCH /api/v1/reminders/{id}/resume
  â†“
reminder.resume() // status = 'ACTIVE'
  â†“
scheduleTask.enable()
  â†“
cronManager.startTask(taskUuid) // job.start()
  â†“
Cron Job é‡æ–°å¼€å§‹è§¦å‘
```

#### 4. åˆ é™¤é˜¶æ®µ
```typescript
DELETE /api/v1/reminders/{id}
  â†“
åˆ é™¤ Reminder
  â†“
åˆ é™¤ ScheduleTask
  â†“
cronManager.unregisterTask(taskUuid)
  â†“
job.stop() + ä» Map ä¸­ç§»é™¤
  â†“
Cron Job è¢«é”€æ¯
```

---

## ç›‘æ§ä¸è°ƒè¯•

### 1. æ—¥å¿—ç›‘æ§

**å¯åŠ¨æ—¶**ï¼š
```bash
ğŸš€ å¼€å§‹åˆå§‹åŒ– Schedule æ¨¡å—...
ğŸ“‹ æŸ¥è¯¢åˆ°æ´»è·ƒä»»åŠ¡ count: 5
âœ… ä»»åŠ¡æ³¨å†ŒæˆåŠŸ taskUuid: xxx, cronExpression: '0 30 9 * * *'
âœ… Schedule æ¨¡å—åˆå§‹åŒ–å®Œæˆ { totalJobs: 5 }
```

**å®šæœŸç›‘æ§æŠ¥å‘Š**ï¼ˆæ¯10åˆ†é’Ÿï¼‰ï¼š
```bash
=== å®šæœŸç›‘æ§æŠ¥å‘Š ===
ğŸ“‹ CronJobManager ç›‘æ§æŠ¥å‘Š
  å·²æ³¨å†Œä»»åŠ¡æ€»æ•°: 5
  è¿è¡Œä¸­ä»»åŠ¡: 5
  åœæ­¢ä»»åŠ¡: 0

ğŸ“Š è°ƒåº¦ä»»åŠ¡ç›‘æ§æŠ¥å‘Š
  æ­£åœ¨æ‰§è¡Œ: 0
  æ€»æ‰§è¡Œæ¬¡æ•°: 127
  æˆåŠŸæ¬¡æ•°: 125
  å¤±è´¥æ¬¡æ•°: 2
  è·³è¿‡æ¬¡æ•°: 0
  æˆåŠŸç‡: 98.43%
  å¹³å‡æ‰§è¡Œæ—¶é•¿: 245.67ms
  æœ€åæ‰§è¡Œæ—¶é—´: 2025-11-26 15:30:00
```

**ä»»åŠ¡æ‰§è¡Œæ—¶**ï¼š
```bash
â° Cron è§¦å‘ {
  taskUuid: 'xxx',
  taskName: 'Reminder: åƒè¯æé†’',
  cronExpression: '0 0 9,21 * * *',
  triggeredAt: '2025-11-26T09:00:00.000Z'
}

ğŸš€ å¼€å§‹æ‰§è¡Œä»»åŠ¡ { taskUuid: 'xxx' }
âœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ { taskUuid: 'xxx', duration: 234ms }
```

### 2. æ•°æ®åº“æŸ¥è¯¢

**æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡**ï¼š
```sql
SELECT 
  uuid,
  name,
  source_module,
  cron_expression,
  enabled,
  status,
  next_run_at,
  execution_count,
  last_execution_status
FROM schedule_tasks
ORDER BY next_run_at ASC;
```

**æŸ¥çœ‹æœ€è¿‘æ‰§è¡Œè®°å½•**ï¼š
```sql
SELECT 
  e.uuid,
  e.task_uuid,
  t.name,
  e.execution_time,
  e.status,
  e.duration,
  e.retry_count,
  e.error
FROM schedule_executions e
JOIN schedule_tasks t ON e.task_uuid = t.uuid
ORDER BY e.execution_time DESC
LIMIT 20;
```

**ç»Ÿè®¡æ‰§è¡Œæƒ…å†µ**ï¼š
```sql
SELECT 
  t.name,
  COUNT(*) as total_executions,
  SUM(CASE WHEN e.status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
  SUM(CASE WHEN e.status = 'FAILED' THEN 1 ELSE 0 END) as failure_count,
  AVG(e.duration) as avg_duration_ms
FROM schedule_executions e
JOIN schedule_tasks t ON e.task_uuid = t.uuid
GROUP BY t.uuid, t.name
ORDER BY total_executions DESC;
```

### 3. è°ƒè¯•å·¥å…·

**æŸ¥çœ‹å†…å­˜ä¸­çš„ä»»åŠ¡**ï¼š
```typescript
// åœ¨è¿è¡Œæ—¶è°ƒç”¨
const stats = CronJobManager.getInstance().getStats();
console.log(stats);

// è¾“å‡ºï¼š
{
  totalJobs: 5,
  registeredTasks: ['uuid1', 'uuid2', 'uuid3', 'uuid4', 'uuid5'],
  cronExpressions: {
    'uuid1': '0 30 9 * * *',
    'uuid2': '*/30 * * * *',
    'uuid3': '0 0 14 * * 1,5',
    ...
  }
}
```

**æ‰‹åŠ¨è§¦å‘ä»»åŠ¡**ï¼š
```typescript
// æµ‹è¯•ç”¨é€”
const executor = ScheduleTaskExecutor.getInstance();
await executor.executeTaskByUuid('task-uuid');
```

**é‡æ–°åŠ è½½æ‰€æœ‰ä»»åŠ¡**ï¼š
```typescript
const bootstrap = ScheduleBootstrap.getInstance();
await bootstrap.reload();
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ CronJobManager æ˜¾ç¤º 0 ä¸ªä»»åŠ¡ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. æ•°æ®åº“ä¸­æ²¡æœ‰ `enabled=true` çš„ ScheduleTask
2. ScheduleBootstrap æ²¡æœ‰åˆå§‹åŒ–
3. æœåŠ¡å¯åŠ¨ååˆ›å»ºçš„ä»»åŠ¡æ²¡æœ‰çƒ­åŠ è½½

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥æ•°æ®åº“
psql -d dailyuse -c "SELECT COUNT(*) FROM schedule_tasks WHERE enabled = true;"

# 2. å¦‚æœæœ‰æ•°æ®ï¼Œé‡å¯æœåŠ¡ï¼ˆä¼šé‡æ–°åŠ è½½ï¼‰
npm run dev

# 3. æˆ–æ‰‹åŠ¨é‡æ–°åŠ è½½
curl -X POST http://localhost:3000/api/v1/schedule/reload
```

### Q2: ä»»åŠ¡åˆ°æ—¶é—´äº†ä½†æ²¡æœ‰æ‰§è¡Œï¼Ÿ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨ CronJobManager ä¸­æ³¨å†Œ
2. æ£€æŸ¥ `enabled` å’Œ `status` å­—æ®µ
3. æ£€æŸ¥ `nextRunAt` æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯

```sql
-- æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
SELECT uuid, name, enabled, status, next_run_at, cron_expression
FROM schedule_tasks
WHERE source_entity_id = '<business_entity_uuid>';
```

### Q3: å¦‚ä½•æš‚åœæ‰€æœ‰ä»»åŠ¡ï¼ˆç»´æŠ¤æ¨¡å¼ï¼‰ï¼Ÿ

```typescript
// æ–¹æ³• 1ï¼šåœæ­¢æ‰€æœ‰ Cron Jobï¼ˆä¸åˆ é™¤ï¼‰
CronJobManager.getInstance().stopAll();

// æ–¹æ³• 2ï¼šåœ¨æ•°æ®åº“ä¸­æ‰¹é‡ç¦ç”¨
await prisma.scheduleTask.updateMany({
  data: { enabled: false }
});

// ç„¶åé‡å¯æœåŠ¡æˆ–é‡æ–°åŠ è½½
await ScheduleBootstrap.getInstance().reload();
```

### Q4: æœåŠ¡é‡å¯ä¼šä¸¢å¤±ä»»åŠ¡å—ï¼Ÿ

**ä¸ä¼šï¼**

- âœ… æ‰€æœ‰ä»»åŠ¡ä¿å­˜åœ¨æ•°æ®åº“ä¸­
- âœ… æœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰ `enabled=true` çš„ä»»åŠ¡
- âœ… `nextRunAt` å­—æ®µç¡®ä¿ä¸ä¼šé—æ¼è§¦å‘
- âš ï¸ ä½†å¦‚æœæœåŠ¡åœæœºæ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¼šé”™è¿‡ä¸€äº›ä¸­é—´çš„è§¦å‘

### Q5: å¦‚ä½•ç›‘æ§ä»»åŠ¡æ‰§è¡Œæ€§èƒ½ï¼Ÿ

**å®æ—¶ç›‘æ§**ï¼š
```typescript
ScheduleMonitor.getInstance().printMonitorReport();
```

**æ•°æ®åº“æŸ¥è¯¢**ï¼š
```sql
-- æ…¢ä»»åŠ¡åˆ†æ
SELECT 
  t.name,
  AVG(e.duration) as avg_duration,
  MAX(e.duration) as max_duration,
  COUNT(*) as execution_count
FROM schedule_executions e
JOIN schedule_tasks t ON e.task_uuid = t.uuid
WHERE e.status = 'SUCCESS'
GROUP BY t.uuid, t.name
HAVING AVG(e.duration) > 1000  -- å¹³å‡è¶…è¿‡ 1 ç§’
ORDER BY avg_duration DESC;
```

**å¤±è´¥ä»»åŠ¡åˆ†æ**ï¼š
```sql
-- å¤±è´¥ç‡æœ€é«˜çš„ä»»åŠ¡
SELECT 
  t.name,
  COUNT(*) as total,
  SUM(CASE WHEN e.status = 'FAILED' THEN 1 ELSE 0 END) as failures,
  ROUND(SUM(CASE WHEN e.status = 'FAILED' THEN 1 ELSE 0 END)::numeric / COUNT(*) * 100, 2) as failure_rate
FROM schedule_executions e
JOIN schedule_tasks t ON e.task_uuid = t.uuid
GROUP BY t.uuid, t.name
HAVING COUNT(*) > 10
ORDER BY failure_rate DESC;
```

---

## æ‰©å±•é˜…è¯»

- [Reminder æé†’æµç¨‹](./reminder-flow.md)
- [Goal æé†’æµç¨‹](./goal-reminder-flow.md)
- [Notification é€šçŸ¥ç³»ç»Ÿ](./notification-flow.md)
- [node-cron æ–‡æ¡£](https://github.com/node-cron/node-cron)
