# ğŸ“¦ packages/sync-client

> æ•°æ®åŒæ­¥å®¢æˆ·ç«¯

## æ¦‚è¿°

`@dailyuse/sync-client` åŒ…æä¾› Desktop åº”ç”¨ä¸ API æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **åŒå‘åŒæ­¥**: æœ¬åœ° â†’ æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ â†’ æœ¬åœ°
- **å†²çªè§£å†³**: æ”¯æŒå¤šç§å†²çªè§£å†³ç­–ç•¥
- **ç¦»çº¿ä¼˜å…ˆ**: ç¦»çº¿æ—¶è®°å½•å˜æ›´ï¼Œè”ç½‘ååŒæ­¥
- **å¢é‡åŒæ­¥**: åªåŒæ­¥å˜æ›´æ•°æ®ï¼ŒèŠ‚çœå¸¦å®½
- **åŒæ­¥çŠ¶æ€**: è·Ÿè¸ªåŒæ­¥è¿›åº¦å’ŒçŠ¶æ€

## å®‰è£…

```bash
pnpm add @dailyuse/sync-client
```

## ä¸»è¦ç»„ä»¶

### SyncManager

ä¸»åŒæ­¥ç®¡ç†å™¨ï¼š

```typescript
import { SyncManager } from '@dailyuse/sync-client';

const syncManager = new SyncManager({
  apiBaseUrl: 'https://api.dailyuse.app',
  conflictStrategy: 'server-wins', // æˆ– 'client-wins', 'manual'
  syncInterval: 5 * 60 * 1000, // 5 åˆ†é’Ÿ
});

// å¼€å§‹åŒæ­¥
await syncManager.sync();

// ç›‘å¬åŒæ­¥äº‹ä»¶
syncManager.on('sync:start', () => console.log('åŒæ­¥å¼€å§‹'));
syncManager.on('sync:complete', (result) => console.log('åŒæ­¥å®Œæˆ', result));
syncManager.on('sync:error', (error) => console.error('åŒæ­¥é”™è¯¯', error));
syncManager.on('sync:conflict', (conflicts) => console.log('å‘ç°å†²çª', conflicts));
```

### SyncQueue

ç¦»çº¿å˜æ›´é˜Ÿåˆ—ï¼š

```typescript
import { SyncQueue } from '@dailyuse/sync-client';

const queue = new SyncQueue();

// è®°å½•å˜æ›´
queue.enqueue({
  type: 'CREATE',
  entity: 'goal',
  data: { title: 'æ–°ç›®æ ‡', ... },
  timestamp: Date.now(),
});

// è·å–å¾…åŒæ­¥é¡¹
const pending = queue.getPending();

// æ¸…é™¤å·²åŒæ­¥é¡¹
queue.remove(itemId);
```

### ConflictResolver

å†²çªè§£å†³å™¨ï¼š

```typescript
import { ConflictResolver } from '@dailyuse/sync-client';

const resolver = new ConflictResolver({
  strategy: 'server-wins',
});

// è§£å†³å†²çª
const resolved = resolver.resolve({
  local: localEntity,
  remote: remoteEntity,
  base: baseEntity, // å…±åŒç¥–å…ˆ
});
```

## ç›®å½•ç»“æ„

```
packages/sync-client/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ SyncManager.ts        # ä¸»åŒæ­¥ç®¡ç†å™¨
â”‚   â”œâ”€â”€ SyncQueue.ts          # ç¦»çº¿é˜Ÿåˆ—
â”‚   â”œâ”€â”€ ConflictResolver.ts   # å†²çªè§£å†³
â”‚   â”œâ”€â”€ SyncStatus.ts         # åŒæ­¥çŠ¶æ€
â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â”œâ”€â”€ GoalSyncAdapter.ts
â”‚   â”‚   â”œâ”€â”€ TaskSyncAdapter.ts
â”‚   â”‚   â””â”€â”€ ScheduleSyncAdapter.ts
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ ServerWinsStrategy.ts
â”‚       â”œâ”€â”€ ClientWinsStrategy.ts
â”‚       â””â”€â”€ ManualStrategy.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åŒæ­¥æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. æ£€æŸ¥è¿æ¥                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ ç½‘ç»œçŠ¶æ€æ£€æµ‹     â”‚ â”€â”€â–º ç¦»çº¿? â”€â”€â–º è·³è¿‡åŒæ­¥            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚ åœ¨çº¿                                        â”‚
â”‚           â–¼                                            â”‚
â”‚  2. ä¸Šä¼ æœ¬åœ°å˜æ›´                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ SyncQueue       â”‚ â”€â”€â–º å‘é€åˆ°æœåŠ¡å™¨                   â”‚
â”‚  â”‚ è¯»å–å¾…åŒæ­¥é¡¹     â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚                                            â”‚
â”‚           â–¼                                            â”‚
â”‚  3. ä¸‹è½½è¿œç¨‹å˜æ›´                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ è·å–æœåŠ¡å™¨å˜æ›´   â”‚ â”€â”€â–º lastSyncTime ä¹‹åçš„å˜æ›´       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚                                            â”‚
â”‚           â–¼                                            â”‚
â”‚  4. å†²çªæ£€æµ‹ä¸è§£å†³                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ ConflictResolverâ”‚ â”€â”€â–º åº”ç”¨è§£å†³ç­–ç•¥                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚                                            â”‚
â”‚           â–¼                                            â”‚
â”‚  5. åº”ç”¨å˜æ›´                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ æ›´æ–°æœ¬åœ°æ•°æ®åº“   â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚                                            â”‚
â”‚           â–¼                                            â”‚
â”‚  6. æ›´æ–°åŒæ­¥çŠ¶æ€                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ lastSyncTime    â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å†²çªè§£å†³ç­–ç•¥

| ç­–ç•¥ | æè¿° |
|------|------|
| `server-wins` | æœåŠ¡å™¨æ•°æ®ä¼˜å…ˆ |
| `client-wins` | å®¢æˆ·ç«¯æ•°æ®ä¼˜å…ˆ |
| `manual` | æ‰‹åŠ¨è§£å†³å†²çª |
| `merge` | è‡ªåŠ¨åˆå¹¶ (å­—æ®µçº§åˆ«) |

## ä¾èµ–å…³ç³»

```
@dailyuse/sync-client
â”œâ”€â”€ @dailyuse/contracts
â”œâ”€â”€ @dailyuse/utils
â””â”€â”€ @dailyuse/domain-client
```

## ç›¸å…³æ–‡æ¡£

- [Desktop æ¶æ„](../architecture/desktop-architecture.md)
- [é›†æˆæ¶æ„](../architecture/integration-architecture.md)
