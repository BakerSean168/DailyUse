# Story 2-4: 目标进度自动计算 - 手动测试指南

## 测试前准备

### 1. 启动服务

```bash
# 终端 1 - 启动后端 API
nx run api:dev

# 终端 2 - 启动前端 Web
nx run web:dev
```

### 2. 确保数据库有测试数据

需要有：
- ✅ 至少 1 个用户账户
- ✅ 至少 1 个目标
- ✅ 至少 2-3 个关键结果（KR）
- ✅ 关键结果有不同的权重和进度

---

## 测试场景

### ✅ 场景 1：创建目标并添加关键结果

**步骤：**
1. 登录系统
2. 创建新目标（例如："Q4 增长目标"）
3. 为目标添加 3 个关键结果：
   - KR1: "用户增长" - 目标值: 1000, 当前值: 700, 权重: 40%
   - KR2: "收入增长" - 目标值: 100, 当前值: 60, 权重: 30%
   - KR3: "留存率" - 目标值: 100, 当前值: 50, 权重: 30%

**预期结果：**
- ✅ 目标进度自动计算为 61%
  - 计算公式：(70% × 40% + 60% × 30% + 50% × 30%) = 61%

**验证方式：**
- 在目标详情页查看进度圆环
- 进度应显示 61%

---

### ✅ 场景 2：更新关键结果进度

**步骤：**
1. 进入目标详情页
2. 更新 KR1"用户增长"的进度：
   - 将当前值从 700 改为 800
   - 新的进度百分比：80%

**预期结果：**
- ✅ 目标进度自动重新计算为 65%
  - 新公式：(80% × 40% + 60% × 30% + 50% × 30%) = 65%
- ✅ 进度圆环实时更新

**验证方式：**
- 保存后检查进度圆环是否更新为 65%
- 无需刷新页面

---

### ✅ 场景 3：查看进度分解详情

**步骤：**
1. 进入目标详情页
2. 点击进度圆环下方的"查看进度详情"按钮

**预期结果：**
- ✅ 弹出进度分解面板对话框
- ✅ 显示以下信息：
  - 目标总进度：65%
  - 计算模式：加权平均
  - 关键结果列表（3 项）
  - 每个 KR 显示：
    - 序号
    - 名称
    - 进度百分比
    - 权重百分比
    - 贡献度（对总进度的贡献）
  - 计算公式展示
  - 最后更新时间

**验证方式：**
- 检查 KR1 贡献度 = 80% × 40% = 32%
- 检查 KR2 贡献度 = 60% × 30% = 18%
- 检查 KR3 贡献度 = 50% × 30% = 15%
- 总和 = 32% + 18% + 15% = 65% ✅

---

### ✅ 场景 4：调整关键结果权重

**步骤：**
1. 在目标详情页
2. 批量调整权重（如果功能可用）：
   - KR1: 40% → 50%
   - KR2: 30% → 25%
   - KR3: 30% → 25%

**预期结果：**
- ✅ 目标进度自动重新计算为 62.5%
  - 新公式：(80% × 50% + 60% × 25% + 50% × 25%) = 62.5%

**验证方式：**
- 进度圆环更新为 62.5%
- 点击"查看进度详情"验证贡献度更新

---

### ✅ 场景 5：删除关键结果

**步骤：**
1. 删除 KR3"留存率"
2. 只剩下 2 个 KR

**预期结果：**
- ✅ 目标进度自动重新计算
  - 新公式：(80% × 50% + 60% × 25%) / 75% = 73.33%
  - 或者如果权重自动调整为 100%：(80% × 66.67% + 60% × 33.33%) = 73.33%

**验证方式：**
- 检查进度圆环更新
- 进度分解面板只显示 2 个 KR

---

### ✅ 场景 6：进度分解面板 UI 测试

**步骤：**
1. 打开进度分解面板
2. 测试 UI 交互

**验证项：**
- ✅ 加载状态：首次打开时显示 loading spinner
- ✅ 错误处理：模拟网络错误，显示错误提示和重试按钮
- ✅ 进度条颜色：
  - >=90% 显示绿色（success）
  - 70-89% 显示蓝色（info）
  - 50-69% 显示黄色（warning）
  - 30-49% 显示橙色（orange）
  - <30% 显示红色（error）
- ✅ 关闭按钮：点击右上角 X 或底部"关闭"按钮可关闭面板
- ✅ 响应式：在不同屏幕尺寸下正常显示

---

### ✅ 场景 7：无关键结果的目标

**步骤：**
1. 创建一个新目标，不添加任何 KR
2. 进入目标详情页

**预期结果：**
- ✅ 目标进度显示为 0%
- ✅ 不显示"查看进度详情"按钮（因为没有 KR）

**验证方式：**
- 进度圆环显示 0%
- 按钮被隐藏（`v-if="keyResults && keyResults.length > 0"`）

---

## API 端点测试

### 使用 curl 测试

```bash
# 获取进度分解详情
curl -X GET "http://localhost:3000/api/goals/{goal-uuid}/progress-breakdown" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

**预期响应：**

```json
{
  "success": true,
  "data": {
    "totalProgress": 65,
    "calculationMode": "weighted_average",
    "krContributions": [
      {
        "keyResultUuid": "kr1-uuid",
        "keyResultName": "用户增长",
        "progress": 80,
        "weight": 40,
        "contribution": 32
      },
      {
        "keyResultUuid": "kr2-uuid",
        "keyResultName": "收入增长",
        "progress": 60,
        "weight": 30,
        "contribution": 18
      },
      {
        "keyResultUuid": "kr3-uuid",
        "keyResultName": "留存率",
        "progress": 50,
        "weight": 30,
        "contribution": 15
      }
    ],
    "lastUpdateTime": 1698723456789,
    "updateTrigger": "自动计算"
  },
  "message": "Progress breakdown retrieved successfully"
}
```

---

## 边界情况测试

### 1. 权重总和不为 100%

**测试：** 创建 KR，权重总和为 80%

**预期：** 计算仍然正确，使用实际权重总和

### 2. 全部 KR 权重为 0

**测试：** 所有 KR 权重设为 0

**预期：** 使用简单平均算法

### 3. 极端进度值

**测试：** 
- KR 进度超过 100%
- KR 进度为负数

**预期：** 
- 进度限制在 0-100% 范围内
- 或显示错误提示

---

## 性能测试

### 1. 大量关键结果

**测试：** 创建目标，添加 10+ 个 KR

**验证：**
- ✅ 进度计算速度快（<100ms）
- ✅ 进度分解面板流畅滚动
- ✅ 列表正常渲染

### 2. 频繁更新

**测试：** 快速连续更新多个 KR 进度

**验证：**
- ✅ 进度实时更新无延迟
- ✅ 无明显性能问题

---

## 缺陷报告模板

如果发现问题，请使用以下模板报告：

```markdown
### Bug Report

**标题：** [简短描述问题]

**重现步骤：**
1. 
2. 
3. 

**预期结果：**
[描述应该发生什么]

**实际结果：**
[描述实际发生了什么]

**截图：**
[如果有的话]

**环境：**
- 浏览器：
- 操作系统：
- 日期时间：

**严重程度：**
- [ ] Critical（阻塞）
- [ ] High（高）
- [ ] Medium（中）
- [ ] Low（低）
```

---

## 测试完成检查清单

- [ ] 场景 1：创建目标并添加 KR ✅
- [ ] 场景 2：更新 KR 进度 ✅
- [ ] 场景 3：查看进度分解详情 ✅
- [ ] 场景 4：调整 KR 权重 ✅
- [ ] 场景 5：删除 KR ✅
- [ ] 场景 6：进度分解面板 UI ✅
- [ ] 场景 7：无 KR 的目标 ✅
- [ ] API 端点测试 ✅
- [ ] 边界情况测试 ✅
- [ ] 性能测试 ✅
- [ ] 所有缺陷已记录
- [ ] Story 可以标记为 `done`

---

**测试人：** _____________  
**测试日期：** _____________  
**测试通过：** [ ] 是 [ ] 否  
**备注：** _____________________________________________
