# 项目自动化发布流程说明

本项目采用了**release-please**和**release**两个 GitHub Actions workflow，实现了自动化的版本管理、CHANGELOG 生成、打包和发布 Release。下面详细介绍整个流程、每个 workflow 的作用、关键命令和实际操作示例。

---

## 目录

1. 整体流程概览
2. release-please 工作流说明
3. release 工作流说明
4. 实际操作示例
5. 常见问题与建议

---

## 整体流程概览

1. **开发阶段**：开发者正常提交代码到主分支（如 `main`），建议使用 [Conventional Commits](https://www.conventionalcommits.org/) 格式（如 `feat: xxx`、`fix: xxx`）。
2. **自动生成 Release PR**：每次 push 到主分支时，`release-please` workflow 会自动分析 commit，生成/更新 `CHANGELOG.md` 和 package.json 版本号，并创建一个 Release PR。
3. **合并 Release PR**：维护者审核并合并 Release PR，`release-please` 会自动打 tag（如 `v1.2.3`）、创建 GitHub Release、生成 Release Notes。
4. **自动构建与发布产物**：`release` workflow 检测到 tag push，自动构建、打包、上传 Release 产物到 GitHub Release 页面。

1
---

## release-please 工作流说明

**文件位置**：release-please.yml

### 触发条件

- 只要有 push 到 `main` 分支（可根据实际主分支名调整）。

### 主要步骤

```yaml
name: release-please
on:
  push:
    branches:
      - main

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/release-please-action@v4
        with:
          release-type: node
          token: ${{ secrets.GITHUB_TOKEN }}
```

### 工作内容

- **分析 commit**，判断是 patch/minor/major 版本。
- **自动生成/更新 `CHANGELOG.md`**，记录所有变更。
- **自动更新 package.json 版本号**。
- **自动创建 Release PR**，内容包含上述变更。
- **合并 Release PR 后**，自动打 tag（如 `v1.2.3`）、创建 GitHub Release、生成 Release Notes。

---

## release 工作流说明

**文件位置**：release.yml

### 触发条件

- 只有 push 形如 `v1.2.3` 的 tag 时才会触发。

### 主要步骤与命令

```yaml
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
```

#### 1. 检出代码

```yaml
- name: Checkout
  uses: actions/checkout@v4
```

#### 2. 安装 Node.js

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: 20
```

#### 3. 安装 pnpm

```yaml
- name: Setup pnpm
  uses: pnpm/action-setup@v2
  with:
    version: 9.14.4
    run_install: false
```

#### 4. 获取 pnpm 缓存目录

```yaml
- name: Get pnpm store directory
  shell: bash
  run: |
    echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV
```

#### 5. 设置 pnpm 缓存

```yaml
- name: Setup pnpm cache
  uses: actions/cache@v3
  with:
    path: ${{ env.STORE_PATH }}
    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-pnpm-store-
```

#### 6. 安装依赖

```yaml
- name: Install dependencies
  run: pnpm install --frozen-lockfile
```

#### 7. 校验 package.json 版本与 tag 一致

```yaml
- name: Check version matches tag
  run: |
    PKG_VERSION=$(node -p "require('./package.json').version")
    TAG_VERSION=${GITHUB_REF#refs/tags/v}
    if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
      echo "Version in package.json ($PKG_VERSION) does not match tag ($TAG_VERSION)"
      exit 1
    fi
```

#### 8. 构建项目

```yaml
- name: Build
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: pnpm run build
```

#### 9. 生成校验和

```yaml
- name: Generate checksums
  run: |
    cd dist
    sha256sum * > sha256sum.txt
```

#### 10. 上传构建产物

```yaml
- name: Upload Artifacts
  uses: actions/upload-artifact@v4
  with:
    name: dist-${{ matrix.os }}
    path: dist
    compression-level: 9
```

#### 11. 创建 GitHub Release 并上传产物

```yaml
- name: Create Release
  uses: softprops/action-gh-release@v1
  with:
    draft: false
    prerelease: false
    files: |
      artifacts/**/*Setup.exe
      artifacts/**/*Setup.zip
      artifacts/**/*.blockmap
      artifacts/**/*.dmg
      artifacts/**/*.AppImage
      artifacts/**/*.deb
      artifacts/**/*.rpm
      artifacts/**/latest*.yml
    generate_release_notes: true
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 实际操作示例

### 1. 正常开发

```bash
git checkout main
git pull
# 开发、提交
git commit -m "feat: 新增导出功能"
git push
```

### 2. 自动生成 Release PR

- release-please 会自动创建一个 PR，内容包含：
  - 更新 `CHANGELOG.md`
  - 更新 package.json 版本号

### 3. 合并 Release PR

- 审核无误后，点击合并。
- 合并后，release-please 自动打 tag（如 `v1.2.3`），并创建 GitHub Release。

### 4. 自动构建与发布产物

- release.yml workflow 检测到 tag push，自动执行构建、打包、上传产物到 Release 页面。

---

## 常见问题与建议

- **commit message** 建议采用 Conventional Commits 格式，否则自动化工具无法正确识别变更类型。
- **不要手动打 tag**，让 release-please 自动管理版本和 tag。
- **如需多平台构建**，可在 `matrix.os` 中添加更多平台（如 `macos-latest`、`ubuntu-latest`）。
- **如需自定义 changelog 或多包管理**，可查阅 [release-please 文档](https://github.com/googleapis/release-please)。
- **如需自动发布到 npm**，可考虑集成 [semantic-release](https://semantic-release.gitbook.io/semantic-release/)。

---

## 手动触发 release 的流程

1. **确保 package.json 里的版本号已更新**  
   例如：`"version": "0.1.9"`

2. **在本地打 tag**  
   ```sh
   git tag v0.1.9
   ```

3. **推送 tag 到 GitHub**  
   ```sh
   git push origin v0.1.9
   ```

4. **GitHub Actions 会自动触发 release.yml workflow**  
   - 自动构建、上传产物、创建 Release。

---

### 注意事项

- tag 名必须符合 `v1.2.3` 这种格式。
- package.json 里的版本号要和 tag 保持一致，否则 workflow 会报错并退出。
