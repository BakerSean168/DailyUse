# TaskInstance å®Œæˆæ•°æ®å­˜å‚¨è®¾è®¡è¯´æ˜

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·æå‡ºçš„å…³é”®é—®é¢˜ï¼š
> "åªæœ‰ keyResult ç»‘å®šçš„ä»»åŠ¡æ‰éœ€è¦å¡«å†™å®Œæˆé‡ä¿¡æ¯å§ï¼Œå› ä¸ºå®ƒæ˜¯éœ€è¦åˆ›å»º record çš„ã€‚å…¶ä½™çš„ TaskInstance æœ‰åœ°æ–¹ä¿å­˜ instance å®Œæˆçš„æ•°æ®å—ï¼Ÿ"

## å½“å‰æ¶æ„åˆ†æ

### 1. TaskInstance çš„ CompletionRecord

**ä½ç½®**ï¼š`packages/domain-server/src/task/value-objects/CompletionRecord.ts`

**å·²æœ‰å­—æ®µ**ï¼š
```typescript
export class CompletionRecord {
  public readonly completedAt: number;        // âœ… å®Œæˆæ—¶é—´
  public readonly note: string | null;        // âœ… å¤‡æ³¨
  public readonly rating: number | null;      // âœ… è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰
  public readonly actualDuration: number | null; // âœ… å®é™…è€—æ—¶
  public readonly taskUuid: string;
  public readonly completionStatus: string;
}
```

**ç»“è®º**ï¼š
- âœ… **è¶³å¤Ÿ**ç”¨äºè®°å½•ä»»åŠ¡å®ä¾‹æœ¬èº«çš„å®Œæˆä¿¡æ¯
- âŒ **æ²¡æœ‰** `completionValue` æˆ– `recordValue` å­—æ®µ
- âœ… **æ­£ç¡®çš„è®¾è®¡**ï¼šä»»åŠ¡å®Œæˆå’Œè¿›åº¦è®°å½•æ˜¯ä¸¤ä¸ªä¸åŒçš„å…³æ³¨ç‚¹

### 2. GoalRecord çš„èŒè´£

**ä½ç½®**ï¼šGoal æ¨¡å—

**èŒè´£**ï¼š
```typescript
// GoalRecord ç”¨äºè®°å½•ç›®æ ‡è¿›åº¦
{
  goalUuid: string;
  keyResultUuid: string;
  value: number;              // â­ è¿›åº¦å€¼å­˜å‚¨åœ¨è¿™é‡Œ
  recordedAt: number;
  source: 'TASK_INSTANCE' | 'MANUAL' | ...;
  sourceUuid?: string;        // å¦‚æœæ¥è‡ª TaskInstanceï¼Œè®°å½•å…¶ UUID
}
```

**ç»“è®º**ï¼š
- âœ… **æ­£ç¡®**ï¼šè¿›åº¦å€¼åº”è¯¥å­˜å‚¨åœ¨ GoalRecord ä¸­ï¼Œè€Œä¸æ˜¯ TaskInstance
- âœ… **æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»**ï¼š
  - TaskInstance.CompletionRecordï¼šè®°å½•"ä»»åŠ¡å®Œæˆäº†"
  - GoalRecordï¼šè®°å½•"è¿›åº¦å¢åŠ äº†å¤šå°‘"

## è®¾è®¡å†³ç­–

### âœ… é‡‡ç”¨æ–¹æ¡ˆï¼šæ ¹æ® GoalBinding æ˜¾ç¤ºä¸åŒè¡¨å•

#### åœºæ™¯ 1ï¼šæœ‰ KeyResult ç»‘å®šçš„ä»»åŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæˆä»»åŠ¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡ï¼šé˜…è¯»ã€ŠClean Codeã€‹              â”‚
â”‚ æ—¥æœŸï¼š2025-11-19 Wednesday            â”‚
â”‚                                      â”‚
â”‚ ğŸ“Š å…³è”çš„ç›®æ ‡ä¿¡æ¯                      â”‚
â”‚ â”œâ”€ ç›®æ ‡ï¼šæŠ€æœ¯æå‡è®¡åˆ’                  â”‚
â”‚ â”œâ”€ å…³é”®ç»“æœï¼šé˜…è¯» 5 æœ¬æŠ€æœ¯ä¹¦ç±          â”‚
â”‚ â”œâ”€ è®¡ç®—æ–¹å¼ï¼šç´¯åŠ  (SUM)                â”‚
â”‚ â”œâ”€ å½“å‰è¿›åº¦ï¼š2 / 5 (40%)              â”‚
â”‚ â””â”€ è¿˜éœ€å®Œæˆï¼š3 æœ¬                      â”‚
â”‚                                      â”‚
â”‚ ğŸ“ æœ¬æ¬¡å®Œæˆé‡ï¼ˆå¿…å¡«ï¼‰                  â”‚
â”‚ [    1     ] æœ¬                      â”‚
â”‚                                      â”‚
â”‚ ğŸ’¡ å®Œæˆåé¢„è®¡ï¼š3 / 5 (60%)            â”‚
â”‚                                      â”‚
â”‚ ğŸš€ å¿«æ·å€¼ï¼š[1] [2] [3]                â”‚
â”‚                                      â”‚
â”‚ ğŸ“„ å®Œæˆå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰                    â”‚
â”‚ ğŸ“Š å®é™…è€—æ—¶ï¼ˆå¯é€‰ï¼‰                    â”‚
â”‚                                      â”‚
â”‚         [å–æ¶ˆ]  [ç¡®è®¤å®Œæˆ]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·ç¡®è®¤å®Œæˆ
    â†“
åç«¯å¤„ç†ï¼š
    â”œâ”€ 1. å®Œæˆ TaskInstance
    â”‚     â””â”€ åˆ›å»º CompletionRecord {
    â”‚           completedAt: now,
    â”‚           note: "ä»Šå¤©è¯»å®Œç¬¬ä¸‰ç« ",
    â”‚           duration: 7200000  // 2å°æ—¶
    â”‚        }
    â”‚
    â””â”€ 2. åˆ›å»º GoalRecord {
          goalUuid: "goal-123",
          keyResultUuid: "kr-456",
          value: 1,  // â­ recordValue å­˜å‚¨åœ¨è¿™é‡Œ
          recordedAt: now,
          source: 'TASK_INSTANCE',
          sourceUuid: 'task-instance-789'
       }
```

#### åœºæ™¯ 2ï¼šæ—  KeyResult ç»‘å®šçš„ä»»åŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæˆä»»åŠ¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡ï¼šçœ‹ç”µå½±ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹           â”‚
â”‚ æ—¥æœŸï¼š2025-11-19 Wednesday            â”‚
â”‚                                      â”‚
â”‚ â„¹ï¸  æ­¤ä»»åŠ¡æœªå…³è”ç›®æ ‡ï¼Œç‚¹å‡»ç¡®è®¤å       â”‚
â”‚    å°†ç›´æ¥å®Œæˆã€‚                       â”‚
â”‚                                      â”‚
â”‚ ğŸ“„ å®Œæˆå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰                    â”‚
â”‚ [  å¾ˆç²¾å½©çš„ç”µå½±ï¼Œå€¼å¾—å†çœ‹ä¸€é  ]       â”‚
â”‚                                      â”‚
â”‚ ğŸ“Š å®é™…è€—æ—¶ï¼ˆå¯é€‰ï¼‰                    â”‚
â”‚ [    142    ] åˆ†é’Ÿ                    â”‚
â”‚                                      â”‚
â”‚         [å–æ¶ˆ]  [ç¡®è®¤å®Œæˆ]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·ç¡®è®¤å®Œæˆ
    â†“
åç«¯å¤„ç†ï¼š
    â””â”€ å®Œæˆ TaskInstance
          â””â”€ åˆ›å»º CompletionRecord {
                completedAt: now,
                note: "å¾ˆç²¾å½©çš„ç”µå½±",
                duration: 8520000  // 142åˆ†é’Ÿ
             }
    
    // âŒ ä¸åˆ›å»º GoalRecordï¼ˆå› ä¸ºæ²¡æœ‰ goalBindingï¼‰
```

## èŒè´£åˆ’åˆ†

### TaskInstance.CompletionRecord èŒè´£

**å­˜å‚¨å†…å®¹**ï¼š
- âœ… `completedAt`ï¼šä»€ä¹ˆæ—¶å€™å®Œæˆçš„
- âœ… `note`ï¼šå®Œæˆå¤‡æ³¨ï¼ˆä»»ä½•æƒ³è®°å½•çš„å†…å®¹ï¼‰
- âœ… `rating`ï¼šå¯¹æœ¬æ¬¡å®Œæˆçš„è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
- âœ… `actualDuration`ï¼šå®é™…èŠ±è´¹çš„æ—¶é—´

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æ‰€æœ‰ TaskInstanceï¼ˆä¸ç®¡æ˜¯å¦ç»‘å®šç›®æ ‡ï¼‰
- âœ… è®°å½•"ä»»åŠ¡å®Œæˆ"è¿™ä¸ªäº‹å®
- âœ… æ”¯æŒç”¨æˆ·åæ€å’Œå¤ç›˜

### GoalRecord èŒè´£

**å­˜å‚¨å†…å®¹**ï¼š
- âœ… `value`ï¼šè¿›åº¦å€¼ï¼ˆrecordValueï¼‰
- âœ… `goalUuid`ã€`keyResultUuid`ï¼šå…³è”çš„ç›®æ ‡
- âœ… `source`ï¼šæ•°æ®æ¥æºï¼ˆTaskInstance/Manual/...ï¼‰
- âœ… `sourceUuid`ï¼šæ¥æºå®ä½“çš„ UUID

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ä»…å½“ä»»åŠ¡ç»‘å®šäº† KeyResult æ—¶
- âœ… è®°å½•"ç›®æ ‡è¿›åº¦"
- âœ… æ”¯æŒç›®æ ‡è¿½è¸ªå’Œå¯è§†åŒ–

## æ•°æ®å…³ç³»ç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TaskTemplate                            â”‚
â”‚  - uuid: "template-001"                                      â”‚
â”‚  - title: "é˜…è¯»æŠ€æœ¯ä¹¦ç±"                                      â”‚
â”‚  - goalBinding: {                                            â”‚
â”‚      goalUuid: "goal-123",                                   â”‚
â”‚      keyResultUuid: "kr-456"                                 â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ generates
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TaskInstance                            â”‚
â”‚  - uuid: "instance-789"                                      â”‚
â”‚  - templateUuid: "template-001"                              â”‚
â”‚  - instanceDate: 2025-11-19                                  â”‚
â”‚  - status: "COMPLETED"                                       â”‚
â”‚  - completionRecord: {                                       â”‚
â”‚      completedAt: 1731974400000,                             â”‚
â”‚      note: "è¯»å®Œç¬¬ä¸‰ç« ",                                      â”‚
â”‚      actualDuration: 7200000                                 â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ creates (if has goalBinding)
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       GoalRecord                              â”‚
â”‚  - uuid: "record-999"                                        â”‚
â”‚  - goalUuid: "goal-123"                                      â”‚
â”‚  - keyResultUuid: "kr-456"                                   â”‚
â”‚  - value: 1  â­ è¿›åº¦å€¼å­˜å‚¨åœ¨è¿™é‡Œ                              â”‚
â”‚  - source: "TASK_INSTANCE"                                   â”‚
â”‚  - sourceUuid: "instance-789"                                â”‚
â”‚  - recordedAt: 1731974400000                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¼˜åŠ¿æ€»ç»“

### 1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»** ğŸ¯
- TaskInstanceï¼šç®¡ç†ä»»åŠ¡å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ
- GoalRecordï¼šç®¡ç†ç›®æ ‡è¿›åº¦çš„è®°å½•
- CompletionRecordï¼šè®°å½•å®Œæˆçš„å…ƒæ•°æ®

### 2. **çµæ´»æ€§** ğŸ”„
- æœªæ¥å¯ä»¥æ”¯æŒæ‰‹åŠ¨åˆ›å»º GoalRecordï¼ˆä¸é€šè¿‡ TaskInstanceï¼‰
- TaskInstance å¯ä»¥ç‹¬ç«‹äºç›®æ ‡ç³»ç»Ÿä½¿ç”¨
- ç›®æ ‡ç³»ç»Ÿå¯ä»¥ä»å¤šä¸ªæ¥æºæ”¶é›†è¿›åº¦

### 3. **å¯è¿½æº¯æ€§** ğŸ“Š
- GoalRecord çš„ `sourceUuid` å¯ä»¥è¿½æº¯åˆ°å…·ä½“çš„ TaskInstance
- æ”¯æŒå®¡è®¡å’Œå†å²æŸ¥è¯¢
- å¯ä»¥çŸ¥é“æ¯ä¸ªè¿›åº¦è®°å½•æ˜¯å¦‚ä½•äº§ç”Ÿçš„

### 4. **é¿å…æ•°æ®å†—ä½™** ğŸ’¾
- ä¸åœ¨ TaskInstance ä¸­é‡å¤å­˜å‚¨è¿›åº¦å€¼
- å•ä¸€æ•°æ®æºåŸåˆ™
- æ˜“äºç»´æŠ¤å’ŒæŸ¥è¯¢

### 5. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ** âœ¨
- æœ‰ç›®æ ‡ç»‘å®šï¼šéœ€è¦è¾“å…¥è¿›åº¦å€¼ï¼ˆæœ‰æ„ä¹‰ï¼‰
- æ— ç›®æ ‡ç»‘å®šï¼šç›´æ¥ç¡®è®¤å®Œæˆï¼ˆç®€å•å¿«æ·ï¼‰
- ä¸å¼ºåˆ¶ç”¨æˆ·ä¸ºæ‰€æœ‰ä»»åŠ¡é‡åŒ–

## å®æ–½æ¸…å•

### âœ… å·²å®Œæˆ

1. **å¯¹è¯æ¡†æ™ºèƒ½æ˜¾ç¤º**
   - æœ‰ goalBindingï¼šæ˜¾ç¤ºå®Œæ•´è¡¨å•ï¼ˆrecordValue + note + durationï¼‰
   - æ—  goalBindingï¼šæ˜¾ç¤ºç®€åŒ–è¡¨å•ï¼ˆnote + durationï¼‰

2. **éªŒè¯é€»è¾‘**
   - æœ‰ goalBindingï¼šrecordValue å¿…å¡«
   - æ—  goalBindingï¼šå¯ç›´æ¥å®Œæˆ

3. **UI ä¼˜åŒ–**
   - ç§»é™¤æ’¤å›æŒ‰é’®
   - å¢å¼º KeyResult ä¿¡æ¯å±•ç¤º
   - æ·»åŠ è¿›åº¦æ¡å’Œå‰©ä½™é‡æ˜¾ç¤º

### â³ å¾…å®Œæˆï¼ˆåç«¯ï¼‰

1. **TaskInstanceApplicationService**
   ```typescript
   async completeTaskInstance(
     uuid: string,
     accountUuid: string,
     data?: {
       recordValue?: number;  // ä»…å½“æœ‰ goalBinding æ—¶ä¼ é€’
       note?: string;
       duration?: number;
     }
   ) {
     // 1. å®Œæˆ TaskInstance
     const instance = await this.taskInstanceDomain.complete(uuid, {
       note: data?.note,
       duration: data?.duration,
     });
     
     // 2. å¦‚æœæœ‰ goalBinding ä¸”ä¼ é€’äº† recordValueï¼Œåˆ›å»º GoalRecord
     const template = await this.getTemplate(instance.templateUuid);
     if (template.goalBinding && data?.recordValue) {
       await this.goalRecordService.createRecord({
         goalUuid: template.goalBinding.goalUuid,
         keyResultUuid: template.goalBinding.keyResultUuid,
         value: data.recordValue,
         source: 'TASK_INSTANCE',
         sourceUuid: uuid,
         recordedAt: new Date(),
       });
     }
     
     return instance;
   }
   ```

2. **æµ‹è¯•åœºæ™¯**
   - âœ… å®Œæˆæœ‰ goalBinding çš„ä»»åŠ¡ â†’ åˆ›å»º TaskInstance.CompletionRecord + GoalRecord
   - âœ… å®Œæˆæ—  goalBinding çš„ä»»åŠ¡ â†’ ä»…åˆ›å»º TaskInstance.CompletionRecord
   - âœ… éªŒè¯ GoalRecord.sourceUuid æ­£ç¡®å…³è”åˆ° TaskInstance

## ç»“è®º

**ä¸éœ€è¦æ‰©å±• CompletionRecord**ï¼š
- âŒ ä¸æ·»åŠ  `completionValue` å­—æ®µ
- âœ… ä¿æŒ CompletionRecord çš„ç®€æ´å’ŒèŒè´£å•ä¸€
- âœ… è¿›åº¦å€¼å­˜å‚¨åœ¨ GoalRecord ä¸­

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šä»»åŠ¡å®Œæˆ vs ç›®æ ‡è¿›åº¦
2. **èŒè´£å•ä¸€**ï¼šæ¯ä¸ªæ•°æ®ç»“æ„åªè´Ÿè´£ä¸€ä»¶äº‹
3. **çµæ´»å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§è¿›åº¦æ¥æº
4. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šæ ¹æ®åœºæ™¯æ˜¾ç¤ºä¸åŒè¡¨å•

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2025-11-19  
**è®¾è®¡çŠ¶æ€**ï¼šâœ… ç¡®è®¤å¹¶å®æ–½  
**å‰ç«¯è¿›åº¦**ï¼šâœ… 70% å®Œæˆï¼ˆå¯¹è¯æ¡†å·²ä¼˜åŒ–ï¼‰  
**åç«¯è¿›åº¦**ï¼šâ³ å¾…å®æ–½
