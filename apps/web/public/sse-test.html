<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log {
            background: #252526;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #007acc;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { border-color: #4ec9b0; }
        .error { border-color: #f48771; }
        .warning { border-color: #ce9178; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        #status {
            font-size: 24px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Œ SSE è¿æ¥æµ‹è¯•å·¥å…·</h1>
    
    <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
    
    <div>
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€</button>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let eventSource = null;
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateStatus(text, color) {
            const status = document.getElementById('status');
            status.textContent = `çŠ¶æ€: ${text}`;
            status.style.color = color;
        }
        
        function connect() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                log('âŒ æœªæ‰¾åˆ° access_tokenï¼Œè¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            log('ğŸ“‹ Token: ' + token.substring(0, 50) + '...', 'log');
            
            const url = `/api/v1/sse/notifications/events?token=${encodeURIComponent(token)}`;
            log('ğŸš€ æ­£åœ¨è¿æ¥åˆ°: ' + url, 'log');
            
            try {
                eventSource = new EventSource(url);
                log('âœ… EventSource å·²åˆ›å»º', 'success');
                log('   readyState: ' + eventSource.readyState + ' (0=CONNECTING, 1=OPEN, 2=CLOSED)', 'log');
                
                eventSource.onopen = (e) => {
                    log('âœ…âœ…âœ… onopen è§¦å‘ - è¿æ¥æˆåŠŸ!', 'success');
                    log('   readyState: ' + eventSource.readyState, 'success');
                    updateStatus('å·²è¿æ¥', '#4ec9b0');
                };
                
                eventSource.onmessage = (e) => {
                    log('ğŸ“¨ æ”¶åˆ°é»˜è®¤æ¶ˆæ¯: ' + e.data, 'log');
                };
                
                eventSource.onerror = (e) => {
                    log('âŒ onerror è§¦å‘', 'error');
                    log('   readyState: ' + eventSource.readyState, 'error');
                    log('   Error: ' + JSON.stringify(e), 'error');
                    updateStatus('é”™è¯¯', '#f48771');
                };
                
                // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„è‡ªå®šä¹‰äº‹ä»¶
                const events = ['connected', 'heartbeat', 'notification:created', 'notification:sent'];
                events.forEach(eventType => {
                    eventSource.addEventListener(eventType, (e) => {
                        log(`ğŸ”” ${eventType}: ${e.data}`, 'success');
                        if (eventType === 'connected') {
                            updateStatus('å·²è¿æ¥ (connected äº‹ä»¶)', '#4ec9b0');
                        }
                    });
                });
                
                // å®šæœŸæ£€æŸ¥çŠ¶æ€
                const statusCheck = setInterval(() => {
                    if (!eventSource) {
                        clearInterval(statusCheck);
                        return;
                    }
                    const state = eventSource.readyState;
                    const stateText = ['CONNECTING', 'OPEN', 'CLOSED'][state];
                    log(`ğŸ“Š çŠ¶æ€æ£€æŸ¥: ${stateText} (${state})`, state === 1 ? 'success' : 'warning');
                }, 5000);
                
            } catch (error) {
                log('âŒ åˆ›å»ºè¿æ¥å¤±è´¥: ' + error, 'error');
                updateStatus('åˆ›å»ºå¤±è´¥', '#f48771');
            }
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                log('ğŸ”Œ è¿æ¥å·²å…³é—­', 'warning');
                updateStatus('å·²æ–­å¼€', '#ce9178');
                eventSource = null;
            } else {
                log('âš ï¸ æ²¡æœ‰æ´»è·ƒè¿æ¥', 'warning');
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        log('ğŸ’¡ æç¤º: è¯·å…ˆç™»å½•åº”ç”¨ï¼Œç„¶åç‚¹å‡»"è¿æ¥"æŒ‰é’®', 'log');
        log('ğŸ’¡ Token ä» localStorage è¯»å–', 'log');
    </script>
</body>
</html>
